<meta charset="utf-8">
<script src="https://cdn.jsdelivr.net/npm/vue/dist/vue.js"></script>
<title>protect the room</title>
<div onclick="player.shoot();" class="menuContent" id="space_key">space key/<br>(left) click</div>
<canvas onclick="player.shoot();" id="textur" width="300" height="300"></canvas>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Geostar+Fill&display=swap" rel="stylesheet">
<div id="menus" class="menuContent">
    <div class="ScoreText" id="scoreText">
      score:16000
    </div>
    <div class="ScoreText" id="highscoreText">
      highscore:160000
    </div>
    <div id="app">
      <ol class="ScoreText" id="highscoreList">
        <li v-for="abc in highscoresDb"> {{ abc }} </li>
      </ol>
    </div>
    <div id="settings" style="display: none">
    <div>
      <h5 class="ScoreText" id="soundHeader">sound</h5>
      <div id="spacePlayer" style="position: absolute; top: -9999px; left: -9999px;"></div>
      <div id="fightPlayer" style="position: absolute; top: -9999px; left: -9999px;"></div>
      <a class="ScoreText" id="spaceMusicA"><input id="spaceMusicCheck" style="accent-color:green;" checked="true" type="checkbox" onchange="musicSelected(id, checked);">play space music</a>
      <a class="ScoreText" id="fightMusicA"><input id="fightMusicCheck" style="accent-color:green; background:black;" type="checkbox" onchange="musicSelected(id, checked);">play fight music</a>
      <img class="ScoreText button" id="muteButton" onmousedown="style.width = '4.8vw';" onmouseup="style.width = '5vw'; changeMute();" src="https://adi.nicolaiweitkemper.de/Bilder/500px-Mute_Icon.svg.png">
      <input type="range" class="ScoreText" id="volControlSpaceMusic" oninput="playerObj.space.setVolume(value);" min="0" value="100" max="100">
      <input type="range" class="ScoreText" id="volControlFightMusic" oninput="playerObj.fight.setVolume(value);" min="0" value="100" max="100">
      </div>
      <div>
        <h5 id="gameplayHeader" class="ScoreText">gameplay</h5>
        <a class="ScoreText" id="useMultAmmoA" title="the maximal difficulty is lowered and instead you have to collect ammo in one phase and shoot it in the other."><input id="useMultAmmo" checked="true" type="checkbox"> ammo tactic</a>
        <input id="tutorialCheck" type="checkbox">tutorial
        <a class="ScoreText" id="enhancedModeA" title="Gives you the ability to move left and right, but takes the ability to store your ammo away. Furthermore, you now receive points based on your speed, so try to be fast, but don't risk too much!"><input id="enhancedModeCheck" type="checkbox"> enhanced</a>
      </div>
    </div>
    <!-- TODO: home hinzufügen -->
    <img class="ScoreText button" id="playButton" draggable="false" onmousedown="style.width = '4.8vw';" onmouseup="style.width = '5vw'; pauseF(false);" onmouseout="style.width = '5vw';" src="https://adi.nicolaiweitkemper.de/Bilder/play_button.png">
    <img class="ScoreText button" id="homeButton" draggable="false" onmousedown="style.width = '4.8vw';" onmouseup="style.width = '5vw';" onmouseout="style.width = '5vw';" src="https://adi.nicolaiweitkemper.de/Bilder/home_icon.png">
    <img class="ScoreText button" id="retryButton" draggable="false" onmousedown="style.width = '3.3vw';" onmouseup="style.width = '3.5vw'; retry();" onmouseout="style.width = '3.5vw';" src="https://adi.nicolaiweitkemper.de/Bilder/retry_icon.png">
    <!-- <button class="ScoreText button" id="retryButton" onclick="retry();" name="button">⟲</button> -->
    <img class="ScoreText button" id="settingsButton" draggable="false" onmousedown="style.width = '4.8vw';" onmouseup="style.width = '5vw'; changeSettingsVis(src);" onmouseout="style.width = '5vw';" src="https://adi.nicolaiweitkemper.de/Bilder/settings.png">
</div>
<img draggable="false" id="pauseButton" class="button" onmousedown="style.width = '25px';" onmouseup="style.width = '22px'; pauseF(true);" onmouseout="style.width = '22px';" src="https://adi.nicolaiweitkemper.de/Bilder/pause_button.png">
<body>
<script src="https://www.youtube.com/player_api"></script>
<style>
  /* big menuContent and classes: */
  #space_key {
    font-size: 60px;
  background-color: rgba(255, 0, 0, 0.5);
  width: 555px;
  height: 150px;
  border: 3px solid rgba(255, 255, 255, 0.2);
  display: none;

  -webkit-touch-callout: none;
  -webkit-user-select: none;
  -khtml-user-select: none;
  -moz-user-select: none;
  -ms-user-select: none;
  user-select: none;
}
#menus {
  border-radius: 15%;

  background-color: rgba(255, 255, 255, 0.5);
  border: 3px solid white;
  position: absolute;
  left: 50%;
  top: 50%;
  transform: translate(-50%,-50%);
  font-size: 60px;
}
.menuContent {
  position: absolute;
  left: 50%;
  top: 50%;
  transform: translate(-50%,-50%);
  text-align: center;
}
.button {
  border: 3px solid hsla(0, 0%, 2%, 0.4);
  background: hsla(0, 0%, 72%, 0.19);
  border-radius: 15%;

  -webkit-touch-callout: none;
  -webkit-user-select: none;
  -khtml-user-select: none;
  -moz-user-select: none;
  -ms-user-select: none;
  user-select: none;
}
.ScoreText {
  position: absolute;
  left: 50%;
  transform: translate(-50%,-50%);
}
/* pause menu: */
#scoreText {
  top: 7vh;
  font-size: 8vw;
}
#highscoreText {
  top: 16vh;
  font-size: 4.5vw;
}
#highscoreList {
  top: 29vh;
  font-size: 3.5vw;
  overflow: scroll;
  /* max-height: 27vh; */
  max-height: 25vh;
  /* left: 7vw; */
  padding-left: 80px;
  /* list-style-type: none; */
}
/* buttons:  */
#playButton {
  width: 5vw;
  /* bottom: 6.9vh; */
  bottom: 1.3vh;
  font-size: 1vw;
}
#playButton:hover {
  background: hsla(0, 0%, 50%, 0.19);
}
#retryButton {
  /* bottom: 2.25vh; */
  /* bottom: 14.5vh; */
  width: 3.5vw;
  bottom: 20%;
  /* font-size: 5vw; */
}
#retryButton:hover {
  background: hsla(0, 0%, 50%, 0.19);
}
/* #retryButton:active {
  font-size: 2.3vw;
}
#retryButton:not( :hover ) {
  font-size: 2.5vw;
} */
#settingsButton {
  bottom: 1.3vh;
  width: 5vw;
  left: 66%;
}
#settingsButton:hover {
  background: hsla(0, 0%, 50%, 0.19);
}
#homeButton {
  bottom: 1.3vh;
  width: 5vw;
  left: 34%;
}
#homeButton:hover {
  background: hsla(0, 0%, 50%, 0.19);
}
#pauseButton {
  position: absolute;
  top: 15px;
  right: 49px;
  width: 22px;
}
/* settings menu: sound*/
#soundHeader {
  top: 14vh;
  font-size: 5vh;
}
#gameplayHeader {
  top: 31vh;
  font-size: 5vh;
}
#spaceMusicA {
  top: 27vh;
  font-size: 2vw;
  left: 28%;
}
#fightMusicA {
  top: 27vh;
  font-size: 2vw;
  left: 35vw;
  text-size.adjust: auto;
  text-size-adjust: 80%;
}
#muteButton {
  width: 5vw;
  left: 50%;
  top: 32vh;
}
#muteButton:hover {
  background: hsla(0, 0%, 50%, 0.19);
}
#volControlSpaceMusic {
  left: 23%;
  top: 32vh;
}
#volControlFightMusic {
  left: 35vw;
  top: 32vh;
  accent-color: red;
}
/* settings menu: gameplay */
#useMultAmmoA {
  left: 35vw;
  font-size: 2vw;
  /* top: 50vh; */
  top: 44.5vh;
  accent-color: green;
}
#enhancedModeA {
  /* left: 9vw; */
  left: 15vw;
  font-size: 2vw;
  /* top: 50vh; */
  top: 44.5vh;
  accent-color: green;
}
/* custom scrollbars */
::-webkit-scrollbar {
  width: 1vw;
}
::-webkit-scrollbar-track {
  border-radius: 100vw;
  background: hsla(0, 0%, 72%, 0.19);
  margin-block: 10px;
}
::-webkit-scrollbar-thumb {
  background: rgb(40, 40, 40);
  border-radius: 100vw;
}
::-webkit-scrollbar-thumb:hover {
  background: black;
}
::-webkit-scrollbar-corner {
  background: rgba(0,0,0,0);
}

</style>
<br>
<div>Icon made from <a href="https://www.onlinewebfonts.com/icon">Icon Fonts</a> is licensed by CC BY 3.0</div>
<br>
<div>Icons made by <a href="https://www.flaticon.com/authors/mynamepong" title="mynamepong">mynamepong</a> from <a href="https://www.flaticon.com/" title="Flaticon">www.flaticon.com</a></div>
<script>
  function musicSelected(id, checked) {
    if (checked) {
      playerObj[id.split('Music')[0]].playVideo();
      document.getElementById('volControl' + id.replace('Check', '').replace(/^\w/, c => c.toUpperCase())).style.accentColor = 'green';
    } else {
      playerObj[id.split('Music')[0]].pauseVideo();
      document.getElementById('volControl' + id.replace('Check', '').replace(/^\w/, c => c.toUpperCase())).style.accentColor = 'red';
    } localStorage.setItem('spaceMusic', checked);
  }
  menus.style.width = window.innerWidth/2;
  menus.style.height = window.innerHeight/1.4;
  var swipeStr = "";
  if (localStorage.getItem('spaceMusic') == "false") spaceMusicCheck.checked = false;
  if (navigator.userAgent.match(/Android/i) ||
    navigator.userAgent.match(/webOS/i) ||
    navigator.userAgent.match(/iPhone/i) ||
    navigator.userAgent.match(/iPad/i) ||
    navigator.userAgent.match(/iPod/i) ||
    navigator.userAgent.match(/BlackBerry/i) ||
    navigator.userAgent.match(/Windows Phone/i)
  ) {
    var gerät = "Handy";
    swipeStr = "swipe_";
  }
  else var gerät = "PC";
  console.log(gerät);
  var wHeight = window.innerHeight;
  var newCannon;
  var speed ;
  var lives;
  var highscores = {};
  try {
    var app = new Vue({
      el: '#app',
      data: {
        highscoresDb: ["a", "b", "c", "d", "Adrian:6000000", "f", "g", "h", "i", "j", "k", "l", "m", "n", "o", "p"]
      }
    })
    highscoreList.style.paddingLeft = 3.6 + ((app.highscoresDb.length) + "").length*1.5 + "vw";
  } catch (e) {
    console.log("vue not available (no Internet connection?)");
  }
  var name = "Adron";
  var phase = {name: "normal"}
  class Player {
    constructor() {
    this.position = {x: window.innerWidth - 110, y: wHeight/2};
    this.bullets = {max: 1, got: []};
    this.speed = 10;
    if (gerät == "Handy") this.speed = 15;
    this.selectedBullet = 0;
    }
    shoot = (bullet) => {
      console.log("shoot!");
      bullet = JSON.parse(JSON.stringify(player.bullets.got[player.selectedBullet]));
      try {
        if (tutorial.status == "no" || tutorial.status.includes("shoot")) {
        if (tutorial.status == "shoot" && bullet) {
          space_key.style.fontSize = "120px";
          space_key.innerHTML = 'collect';
          // space_key.style.display = "none";
          setTimeout(function () {
            tutorial.status = "collectAmmo";
            tutorial.counter = 0;
            player.bullets.max++;
            bullets.push({speed: 6, x: 33, y: window.innerHeight/3 - 133, width: 133, height: 133, direction: {x: 1, y: 0}});
            setTimeout(function () {
              bullets.push({speed: 5, x: 33, y: 33, width: 50, height: 50, direction: {x: 1, y: 0}});
              setTimeout(function () {
                if (tutorial.status == "collectAmmo" && palyer.bullets.got.length > 0) {
                  restartTutorial();
                }
              }, 5000);
            }, 3333);
          }, 4000);
        }
        if (bullet) new Audio('https://adi.nicolaiweitkemper.de/Sounds/protectTheRoom/shot.wav').play();
        // bullet.y = this.position.y - bullet.height;
        bullet.speed += 5;
        bullets.push(JSON.parse(JSON.stringify(bullet)));
        player.bullets.got.splice(player.selectedBullet, 1);
        if (player.selectedBullet == player.bullets.got.length && player.selectedBullet > 0) player.selectedBullet--;
        player.reload = {index: player.selectedBullet, left: 333};
        player.selectedBullet = -1;
      }
      } catch (e) {
        console.log("can not shoot (no ammo?)");
      }
  }
}
  var tutorial = {status: 'no'};
  var player = new Player();
  var points = {counter: 0, show: []};
  function startGame(pTutorial) {
    pause.boolean = false;
    points = {counter: 0, show: []};
    space_key.style.display = "none";
    menus.style.display = 'none';
    highscoreList.style.display = 'inline';
    space_key.style.fontSize = 60;
    newCannon = {time: {needed: convertNumber*5, got: convertNumber*5 - 16}, counter: 0}
    if (enhancedModeCheck.checked) newCannon.time.needed = convertNumber*3;
    speed = {bullet: 3, cannon: 1777, minTime: 1777};
    lives = {beginning: 133, now: 133};
    phase = {name: "normal"};
    player = new Player();
    cannons = [];
    bullets = [];
    tutorial = {status: 'no'};
    if (pTutorial) tutorial = {status: 'moveDown'};
    disableScroll();
    window.scroll(0, 0);
    // newCannon.time.needed = wHeight*1.7//3;
    // player.speed = 33;
    // player.bullets.max = 6;
    // speed.bullet = 11;
    // reloadAmmo max
    // newCannon.time.needed -= wHeight*1.5//3;
    // newCannon.time.needed = wHeight*5 - wHeight*1.5//3;
    // player.speed = 33;
    // player.bullets.max = 6;
    // speed.bullet = 3;
    // // speed.minTime = 999;
    // evenFaster max:
    // newCannon.time.needed = convertNumber *1.2//3;
    // player.speed = adaptToHeight(89);
    // player.bullets.max = 6;
    // speed.bullet = 11;
    // requestAnimationFrame(animateBullet);
    // evenFaster max:
    // newCannon.time.needed = convertNumber *1//3;
    // player.speed = adaptToHeight(99);
    // player.bullets.max = 6;
    // speed.bullet = 13;
    // enhanced mode max:
    // player.speed = 33;
    // speed.bullet = 9;
    // newCannon.time.needed = convertNumber *2.5;
    requestAnimationFrame(animateBullet);
    space_key.innerHTML = 'space key/<br>(left) click';
    if (pTutorial) {
      cannons.push({x: 33, y: window.innerHeight - 50 - (133*(((window.innerWidth*wHeight)/(1600*1069)))*1.7), width: 133, height: 133, speed: 3000, bulletSpeed: 3, timeGone: 0, direction: {x: 1, y: 0}});
      tutorialCheck.checked = true;
    }
  }
  var canvas = textur.getContext('2d');
  textur.width = window.innerWidth - textur.getBoundingClientRect().left;
  textur.height = wHeight - textur.getBoundingClientRect().top - 10;
  canvas.fillStyle = "black";
  canvas.fillRect(0, 0, textur.width, textur.height);
  //   var cannons = [{x: 10, y: 10, width: 17, height: 17, speed: 1777, bulletSpeed: 10, timeGone: 0, direction: {x: 1, y: 0}}];
  var cannons = [];
  var bullets = [];
  var arrows = {left: new Image(), right: new Image(), up: new Image(), down: new Image()};
  for (var direc of Object.keys(arrows)) {
    arrows[direc].src = 'https://adi.nicolaiweitkemper.de/Bilder/keys/' + swipeStr + direc + '_arrow.png';
  }
  function animateBullet(time) {
    canvas.fillStyle = "black";
    canvas.fillRect(0, 0, textur.width, textur.height);
    // show selected player bullet
    canvas.fillStyle = "red";
    var selectedBullet = player.bullets.got[player.selectedBullet];
    if (selectedBullet) {
    selectedBullet.y = player.position.y - selectedBullet.height;
    canvas.fillRect(selectedBullet.x, selectedBullet.y, selectedBullet.width, selectedBullet.height);
    }
    canvas.fillStyle = "white";
    for (var cannon of cannons) {
      canvas.fillRect(cannon.x, cannon.y, cannon.width, cannon.height);
      cannon.timeGone += 16;
      if (cannon.timeGone == 16 || cannon.timeGone >= cannon.speed) {
        cannon.timeGone = 1;
        bullets.push(JSON.parse(JSON.stringify({speed: cannon.bulletSpeed, x: cannon.x + 1*Math.abs(cannon.direction.y), y: cannon.y + 1*Math.abs(cannon.direction.x), width: cannon.width - 2*Math.abs(cannon.direction.y), height: cannon.height - 2*Math.abs(cannon.direction.x), direction: cannon.direction})));
      }
    }
    bullets.forEach((bullet, i) => {
      // bullet hits room
      if (bullet.x + bullet.width > window.innerWidth - 50) {
        lives.now -= bullet.width;
        bullets.splice(i, 1);
        new Audio('https://adi.nicolaiweitkemper.de/Sounds/protectTheRoom/damage.wav').play();
      }
      else {
      // player picks bullet
      if (!bullet.fromPlayer && isCollide(bullet, {x: player.position.x, y: player.position.y, width: 50, height: 50})) {
        console.log("player picks bullet!");
        if (player.bullets.got.length < player.bullets.max && phase.name != "useAmmo") {
          new Audio('https://adi.nicolaiweitkemper.de/Sounds/protectTheRoom/pick_bullet.wav').play();
          bullet.direction.x = -1;
          bullet.fromPlayer = true;
          if (phase.name != "collectAmmo" || player.position.x + (bullet.width/2)/* + 50*/ - bullet.width >= window.innerWidth - 50 - bullet.width) bullet.x = player.position.x + 50 - bullet.width;
          else bullet.x = player.position.x + (bullet.width/2)/* + 50*/ - bullet.width;
          player.bullets.got.push(JSON.parse(JSON.stringify(bullet)))
          if (tutorial.status == "waiting for bullet 2") tutorial.status = "shoot";
          if (tutorial.status == "collectAmmo") {
            tutorial.counter++;
            if (tutorial.counter > 1) {
              tutorial.status = "choose right ammo";
            }
          }
        }
        bullets.splice(i, 1);
      }
      // player destroys cannon
      if (bullet.fromPlayer) {
        cannons.forEach((cannon, i1) => {
          if (isCollide(cannon, bullet)) {
            cannons.splice(i1, 1);
            new Audio('https://adi.nicolaiweitkemper.de/Sounds/protectTheRoom/cannon_explosion.wav').play();
            if (enhancedModeCheck.checked) {
              points.counter += cannon.points;
              points.show.push({data: cannon, counter: 1333});
            }
            if (tutorial.status == "kill/shoot cannons") {
              tutorial.counter++;
              if (tutorial.counter > 2) {
                player.bullets.max = 1;
                space_key.style.display = "none";
                tutorialCheck.checked = false;
                tutorial.status = "no";
                localStorage.setItem('tutorialPlayed', true);
              }
            }
          }
          if (cannon.points - 16 >= 1) cannon.points -= 16;
        });
      }
      var playerBullets = bullets.filter(a => a.fromPlayer);
      if (selectedBullet) playerBullets.push(JSON.parse(JSON.stringify(selectedBullet)));
      // player defend bullet with bullet "on hand"
      playerBullets.forEach((playerBullet, i1) => {
        if (playerBullet && !bullet.fromPlayer && isCollide(playerBullet, bullet) && JSON.stringify(playerBullet) != JSON.stringify(bullet)) {
          bullets.splice(i, 1);
          new Audio('https://adi.nicolaiweitkemper.de/Sounds/protectTheRoom/shot_shot.wav').play();
          if (player.selectedBullet == player.bullets.got.length - 1 && player.selectedBullet > 0) player.selectedBullet--;
          if (i1 == playerBullets.length - 1 && selectedBullet) {
            console.log("defended with bullet on hand!");
            player.bullets.got.splice(player.selectedBullet, 1);
            if (tutorial.status == "collectAmmo") {
              restartTutorial();
            }
            if (tutorial.status == "waiting for bullet") tutorial.status = "waiting for bullet 2";
          }
        }
      });
    }
      canvas.fillStyle = "white";
      if (bullet.fromPlayer) canvas.fillStyle = "red";
      canvas.fillRect(bullet.x, bullet.y, bullet.width, bullet.height);
      bullet.x += bullet.speed*bullet.direction.x;
      bullet.y += bullet.speed*bullet.direction.y;
    });
    bullets = bullets.filter(b => b.x < textur.width && b.y < textur.height && b.y >= -(b.height) && b.x >= -(b.width));
    if (!enhancedModeCheck.checked && !bullets.length && gerät == "Handy" && tutorial.status == "no" && newCannon.counter && newCannon.counter < 3) newCannon.time.needed = JSON.parse(JSON.stringify(newCannon.time.got));
    // room layout
    canvas.fillStyle = "white";
    canvas.fillRect(window.innerWidth - 50, 0, 35, wHeight);
    canvas.fillStyle = "rgba(40, 228, 70, 0.55)";
    canvas.fillRect(window.innerWidth - 50, -wHeight*(lives.now/lives.beginning) + wHeight, 35, wHeight);
    newCannon.time.got += 16;
    // change variables
    if (newCannon.time.got >= newCannon.time.needed && tutorial.status == "no") {
      console.log("new cannon! Interval: " + newCannon.time.needed);
      if (gerät == "Handy") var size = (Math.round(Math.random()*(140 - player.speed*2)) + (player.speed*2))/1.7;
      else var size = (Math.round(Math.random()*(140 - player.speed)) + player.speed)/1.7;
      if (enhancedModeCheck.checked) bulletSpeed = Math.round(Math.random()*(bulletSpeed - 2)) + 2;
      console.log("bullet speed: " + bulletSpeed);
      // size = size*((window.innerWidth*wHeight)/(1600*1069));
      cannons.push({x: 33, y: Math.round(Math.random()*(textur.getBoundingClientRect().height - 3 - (size*(((window.innerWidth*wHeight)/(1600*1069)))*1.7))), width: size*(((window.innerWidth*wHeight)/(1600*1069)))*1.7, height: size*(((window.innerWidth*wHeight)/(1600*1069)))*1.7, speed: /*Math.round(Math.random()**/speed.cannon/*)*/, bulletSpeed: bulletSpeed, timeGone: 0, direction: {x: 1, y: 0}, points: 3000});
      // if (cannons[cannons.length - 1].speed < speed.minTime) cannons[cannons.length - 1].speed = 999;
      // do {
      // var cannonCollsion = false;
      // for (var cannon of cannons) {
      //   if (cannons[cannons.length - 1] && isCollide(cannon, cannons[cannons.length - 1]) && JSON.stringify(cannon) != JSON.stringify(cannons[cannons.length - 1])) {
      //     cannons[cannons.length - 1].y = Math.round(Math.random()*wHeight - size);
      //     cannonCollsion = true;
      //   }
      // }
      // } while (cannonCollsion);
      if (cannons[cannons.length - 1].y < size) cannons[cannons.length - 1].y = size;
      newCannon.counter++;
      if (phase.counter) phase.counter--;
      var original = wHeight;
      if (!enhancedModeCheck.checked) {
      if (newCannon.time.needed > convertNumber *1.2 && phase.name == "normal") newCannon.time.needed -= 16;
      else if (!useMultAmmo.checked && newCannon.time.needed > convertNumber *1) newCannon.time.needed -= 16;
        else if (useMultAmmo.checked && phase.counter == 0) {
       if (phase.name == "normal" || phase.name == "useAmmo") {
         setTimeout(function () {
           phase.name = "collectAmmo";
           adaptToScreen();
           newCannon.time.needed = convertNumber *5 - convertNumber *1.5//3;
           if (gerät == "Handy") newCannon.time.needed += 1333;
           setTimeout(function () {
             player.speed = /*adaptToHeight(*/33;
           }, 1777);
           speed.bullet = 5//3;
           phase.counter = player.bullets.max + 3;//9;
           console.log(phase.name);
         }, 1555);
        }
        else if (phase.name == "collectAmmo") {
          cannons = [];
          speed.bullet = 11;
          newCannon.time.needed = convertNumber *1.4//3;
          phase.name = "useAmmo";
          adaptToScreen();
          player.speed = 45;
          if (gerät == "Handy") player.speed = adaptToHeight(90);
          phase.counter = player.bullets.max - 2 //4;
          bullets.pop();
          console.log(phase.name);
          player.bullets.max++;
        }
      }
    }
    // TODO: übersichtli<cher
    else if (gerät == "Handy" && newCannon.time.needed > convertNumber) newCannon.time.needed -= 16;
    else if (newCannon.time.needed > convertNumber *2.5) newCannon.time.needed -= 16;
      // TODO: Mode: Zwischenstufe: normale Fähigkeiten + verschiedene Geschwindigkeiten
      // TODO: maxima für neuen mode verändern (bullet speed, cannon interval)
      else if (useMultAmmo.checked && !phase.counter) phase.counter = 7;
      if (enhancedModeCheck.checked && player.speed < 33) player.speed += 0.3;
      else if (!enhancedModeCheck.checked) {
      if (player.speed < 89 && gerät != "Handy") player.speed += 0.2;
      else if (player.speed < 89) player.speed += 0.3;
      else if (!useMultAmmo.checked && player.speed < adaptToHeight(99)) player.speed += 0.2;
    }
      if (player.bullets.max < 6 && !(newCannon.counter/(10 + Math.round(newCannon.counter/10)) + "").includes('.') && !enhancedModeCheck.checked) player.bullets.max++;
      if (enhancedModeCheck.checked && speed.bullets < 9) speed.bullet += 0.1;
      if (speed.bullet < 11 && gerät != "Handy") speed.bullet += 0.1;
      else if (speed.bullet < 11) speed.bullet += 0.2;
      else if (!useMultAmmo.checked && speed.bullet < 13) speed.bullet += 0.1;
      newCannon.time.got = 0;
    }
    // layout ammo
    player.bullets.got.sort((x, y) => x.width - y.width);
    var lastAmmoPosition = 0;
    for (var i = 0; i < player.bullets.max; i++) {
      var bullet = player.bullets.got[i];
      if (player.bullets.got[i]) {
        canvas.fillStyle = "rgba(255, 0, 0, 0.5)";
        canvas.fillRect(10 + lastAmmoPosition, 10 + 27, bullet.width, bullet.height);
        if (i == player.selectedBullet) canvas.fillRect(10 + lastAmmoPosition, 10 + 27 + bullet.height + 10, bullet.width, 10);
        lastAmmoPosition += bullet.width + 10;
      }
      else {
        canvas.fillStyle = "rgba(131, 123, 123, 0.5)";
        canvas.fillRect(10 + lastAmmoPosition, 10 + 27, 50, 50);
        lastAmmoPosition += 60;
      }
    }
    canvas.font = "35px arcade classic";
    canvas.fillStyle = "rgba(131, 123, 123, 0.5)";
    if (enhancedModeCheck.checked) canvas.fillText("score: " + points.counter, 10, 8 + 20);
    else canvas.fillText("score: " + newCannon.counter, 10, 8 + 20);
    if (player.selectedBullet == -1) {
    	player.reload.left -= 16;
    	if (player.reload.left < 1) {
      	player.selectedBullet = player.reload.index;
      }
    }
    if (lives.now > 0 && !(tutorial.status == "no" && tutorialCheck.checked) && !pause.boolean) requestAnimationFrame(animateBullet);
    else {
      if (lives.now <= 0 && tutorial.status != "no") restartTutorial();
      if (!pause.boolean && !pause.inProgress) endGame();
    }
    // player layout
canvas.fillStyle = "white";
canvas.fillRect(player.position.x, player.position.y, 50, 50);
if (tutorial.status.includes("move") && gerät == "PC") {
  canvas.drawImage(arrows.up, player.position.x, player.position.y - 50, 50, 50);
  canvas.drawImage(arrows.down, player.position.x + 5, player.position.y + 50, 40, 40);
}
else if (tutorial.status.includes("move")) {
  canvas.drawImage(arrows.up, player.position.x - 65, player.position.y - 50 - 77, 110, 110);
  canvas.drawImage(arrows.down, player.position.x + 5 - 100, player.position.y + 50 - 7, 150, 150);
}
if (tutorial.status == "shoot") {
  space_key.style.display = "inline";
}
  if (tutorial.status == "choose right ammo") {
    space_key.style.display = "none";
    canvas.fillStyle = "rgba(255, 255, 255, 0.6)";
    canvas.fillRect(0, 200, window.innerWidth, window.innerHeight);
    canvas.fillRect(255, 0, window.innerWidth - 255, 200);
    var img = new Image();
    img.src = 'https://adi.nicolaiweitkemper.de/Bilder/keys/' + swipeStr + 'left_arrow.png';
    canvas.drawImage(img, 45, 195, 40, 40);
    var img = new Image();
    img.src = 'https://adi.nicolaiweitkemper.de/Bilder/keys/' + swipeStr + 'right_arrow.png';
    canvas.drawImage(img, 165, 195, 50, 50);
  }
  // show new points
  for (var point of points.show) {
    canvas.font = "50px geostar fill";
    canvas.fillText(point.data.points, point.data.x, point.data.y - 50);
    point.counter -= 16;
    if (point.counter <= 0) points.show.shift();
  }
  }
  // menu interactions
  function endGame() {
    enableScroll();
    // TODO: highscore system
    if (!highscores[name] || newCannon.counter > highscores[name]) highscores[name] = newCannon.counter;
    showMenu();
  }
  function showMenu() {
    menus.style.top = 0 - (menus.style.height.replace('px', ''))/2 + "px";
    menus.style.display = "inline";
    endGameAnimation(convertCss(menus.style.top));
  }
  var pause = {boolean: false};
  function pauseF(boolean, notReactivateGame) {
    pause.boolean = boolean;
    pause.inProgress = true;
    if (boolean) {
      highscoreList.style.maxHeight = "19vh";
      highscoreList.style.top = "24vh";
      showMenu();
    }
    else {
      highscoreList.style.maxHeight = "25vh";
      highscoreList.style.top = "29vh";
      hideMenu(wHeight/2);
      setTimeout(function () {
        settings.style.display = "none";
        highscoreList.style.display = "inline";
        if (!notReactivateGame) animateBullet();
      }, 500);
    }
    setTimeout(function () {
      pause.inProgress = false;
    }, 499);
  }
  function retry() {
    pauseF(false, true);
    setTimeout(function () {
      startGame(tutorialCheck.checked);
    }, 500);
  }
  function hideMenu(y) {
    menus.style.top = y;
      setTimeout(function () {
        if (convertCss(menus.style.top) > -wHeight/2) hideMenu(convertCss(menus.style.top) - 15);
      }, 1);
  }
  function changeSettingsVis(src) {
    if (src.includes('settings')) {
      settingsButton.src = 'https://adi.nicolaiweitkemper.de/Bilder/winner_steps.png'
      settings.style.display = 'inline';
      highscoreList.style.display = 'none';
    }
    else {
      settingsButton.src = 'https://adi.nicolaiweitkemper.de/Bilder/settings.png';
      settings.style.display = 'none';
      highscoreList.style.display = 'inline';
    }
  }
  function endGameAnimation(y, bounce) {
    menus.style.top = y;
    if (convertCss(menus.style.top) < wHeight/2 + 50 && !bounce) {
      setTimeout(function () {
        endGameAnimation(convertCss(menus.style.top) + 15);
      }, 1);
    }
    else if (convertCss(menus.style.top) > wHeight/2) {
      setTimeout(function () {
        endGameAnimation(convertCss(menus.style.top) - 5, true);
      }, 1);
    }
  }
  function convertCss(data) {
    return JSON.parse(data.replace('px', ''))
  }
  function restartTutorial() {
    tutorial.status = "no";
    setTimeout(function () {
      startGame(true);
    }, 100);
  }
var convertNumber;
adaptToScreen();
function adaptToScreen() {
  convertNumber = ((wHeight*window.innerWidth));
  var handyPlus = 0;
  if (gerät == "Handy" && phase.name != "collectAmmo") handyPlus = 9.5;
  else if (gerät == "Handy") handyPlus = -0.5;
  if (convertNumber/1069/1600 < 1) convertNumber *= (convertNumber/1069/1600)*(1.29 + handyPlus) + 1;
  else if (convertNumber/1069/1600 > 1) convertNumber *= (convertNumber/1069/1600)*1.7;
  convertNumber /= window.innerWidth;
}
function adaptToHeight(original) {
  // original*(wHeight/1069)*1.4;
  for (var i = 1.3; gerät == "Handy" && i >= 1; i -= 0.1) {
    if (original*(wHeight/1069)*i < original && wHeight < 1069) original *= (wHeight/1069)*i;
  }
  return original;
}
if (!localStorage.getItem('tutorialPlayed')) startGame(true);
function isCollide(a, b) {
  return (a.x < b.x + b.width &&
   a.x + a.width > b.x &&
   a.y < b.y + b.height &&
   a.y + a.height > b.y)
}
// control
// enableand disable scrolling
// left: 37, up: 38, right: 39, down: 40,
// spacebar: 32, pageup: 33, pagedown: 34, end: 35, home: 36
var keys = {37: 1, 38: 1, 39: 1, 40: 1};

function preventDefault(e) {
  e.preventDefault();
}

function preventDefaultForScrollKeys(e) {
  if (keys[e.keyCode]) {
    preventDefault(e);
    return false;
  }
}

// modern Chrome requires { passive: false } when adding event
var supportsPassive = false;
try {
  window.addEventListener("test", null, Object.defineProperty({}, 'passive', {
    get: function () { supportsPassive = true; }
  }));
} catch(e) {}

var wheelOpt = supportsPassive ? { passive: false } : false;
var wheelEvent = 'onwheel' in document.createElement('div') ? 'wheel' : 'mousewheel';

// call this to Disable
function disableScroll() {
  window.addEventListener('DOMMouseScroll', preventDefault, false); // older FF
  window.addEventListener(wheelEvent, preventDefault, wheelOpt); // modern desktop
  window.addEventListener('touchmove', preventDefault, wheelOpt); // mobile
  window.addEventListener('keydown', preventDefaultForScrollKeys, false);
  textur.style.touchAction = 'none';
}

// call this to Enable
function enableScroll() {
  window.removeEventListener('DOMMouseScroll', preventDefault, false);
  window.removeEventListener(wheelEvent, preventDefault, wheelOpt);
  window.removeEventListener('touchmove', preventDefault, wheelOpt);
  window.removeEventListener('keydown', preventDefaultForScrollKeys, false);
  textur.style.touchAction = '';
}
document.addEventListener('touchmove', touch);
document.addEventListener('touchstart', touch);
document.addEventListener('touchend', touch);
// document.getElementById('textur').style = "touch-action: none";
var swipe = {};
document.onkeydown = function(event) {
  if (event.key.toLowerCase().includes("up")) {
    player.position.y -= player.speed;
  }
  if (event.key.toLowerCase().includes("down")) {
    player.position.y += player.speed;
    if (cannons[0] && player.position.y >= cannons[0].y + player.speed && tutorial.status == "moveDown") tutorial.status = "waiting for bullet";
  }
  if (event.key.toLowerCase().includes("left")) decX();
  if (event.key.toLowerCase().includes("right")) incX();
  if (event.key == " ") {
    try {
      player.shoot(player.bullets.got[player.selectedBullet]);
    } catch (e) {}
    return false;
  }
}
function incAmmoIndex() {
  player.selectedBullet++;
  if (tutorial.status == "choose right ammo") {
    tutorial.status = "kill/shoot cannons";
    tutorial.counter = 0;
    cannons.push({x: 33, y: 10, width: 33, height: 33, speed: 3000, bulletSpeed: 3, timeGone: 0, direction: {x: 1, y: 0}});
    cannons.push({x: 33, y: 100, width: 33, height: 33, speed: 3000, bulletSpeed: 3, timeGone: 0, direction: {x: 1, y: 0}});
    cannons.push({x: 33, y: 200, width: 33, height: 33, speed: 3000, bulletSpeed: 3, timeGone: 0, direction: {x: 1, y: 0}});
    space_key.style.display = "inline";
    space_key.innerHTML = "kill them!";
  }
}
function incX() {
  var speed = player.speed;
  if (enhancedModeCheck.checked && gerät == "Handy") speed = player.speed/3;
  if (player.selectedBullet + 1 < player.bullets.got.length && player.selectedBullet != -1) incAmmoIndex();
  if (enhancedModeCheck.checked) {
    player.position.x += speed;
    player.bullets.got.map((a) => {
      a.x += speed;
      return a;
    });
  }
}
function decX() {
  var speed = player.speed;
  if (enhancedModeCheck.checked && gerät == "Handy") speed = player.speed/3;
  if (player.selectedBullet > 0) player.selectedBullet--;
  if (enhancedModeCheck.checked) {
    player.position.x -= speed;
    player.bullets.got.map((a) => {
      a.x -= speed;
      return a;
    });
  }
}
function touch(ev) {
  if (ev.touches[1]) player.shoot();
  if (ev.type == "touchstart") {
    var firstTouch = getTouches(ev)[0];
    xDown = firstTouch.clientX;
    yDown = firstTouch.clientY;
    swipe = {beginning: {x: firstTouch.clientX, y: firstTouch.clientY}, counter: -5};
  }
  if (ev.type == "touchmove") {
    swipe.counter++;
    var xDiff = swipe.beginning.x - ev.touches[0].clientX;
    var yDiff = yDown - ev.touches[0].clientY;
    firstTouch = getTouches(ev)[0];
    if ( Math.abs( xDiff ) > Math.abs( yDiff ) ) {/*most significant*/
      if (swipe.counter == 10 || swipe.counter == -1 || enhancedModeCheck.checked) {
        swipe.counter = 0;
        if ( xDiff > 0) {
          decX();
            /* left swipe */
        } else if (xDiff < 0) {
            /* right swipe */
            incX();
        }
      }
    } else {
        if ( yDiff > 0 ) {
            /* up swipe */
            player.position.y -= player.speed/3;
        } else {
            /* down swipe */
            if (cannons[0] && player.position.y >= cannons[0].y + player.speed && tutorial.status == "moveDown") tutorial.status = "waiting for bullet";
            player.position.y += player.speed/3;
        }
    }
  }
  // toggleFullscreen(document.body);
}
var xDown;
var yDown;
function getTouches(ev) {
return ev.touches ||             // browser API
       ev.originalEvent.touches; // jQuery
}

// audio:
var playerObj = {space: null, fight: null};
function onYouTubePlayerAPIReady() {
  var playerOby = new YT.Player('spacePlayer', {
      videoId: 'tNkZsRW7h2c', // this is the id of the video at youtube (the stuff after "?v=")
      loop: true,
      events: {
          onReady: function (e) {
              playerObj.space = e.target;
              if (localStorage.getItem('spaceMusic') == "true" || localStorage.getItem('spaceMusic') == null) musicSelected('spaceMusicCheck', true);// e.target.playVideo();
              else musicSelected('spaceMusicCheck', false);
            },
      }
  });
  var playerOby = new YT.Player('fightPlayer', {
      videoId: 'abg4hqQs5b8', // this is the id of the video at youtube (the stuff after "?v=")
      loop: true,
      events: {
          onReady: function (e) {
              playerObj.fight = e.target;
            },
      }
  });
  // you can do more stuff with the player variable
}
</script>
