<meta charset="utf-8">
<title>protect the room</title>
<canvas id="textur" onclick="player.shoot();" width="300" height="300"></canvas>
<div id="settings">
<input id="useMultAmmo" checked="true" type="checkbox"> ammo tactive
<button onclick="startGame(); settings.style.display = 'none';">start</button>
</div>
<script>
  if (navigator.userAgent.match(/Android/i) ||
    navigator.userAgent.match(/webOS/i) ||
    navigator.userAgent.match(/iPhone/i) ||
    navigator.userAgent.match(/iPad/i) ||
    navigator.userAgent.match(/iPod/i) ||
    navigator.userAgent.match(/BlackBerry/i) ||
    navigator.userAgent.match(/Windows Phone/i)
  ) {var gerät = "Handy";}
  else var gerät = "PC";
  console.log(gerät);
  var newCannon = {time: {needed: window.innerHeight*5, got: window.innerHeight*5 - 16}, counter: 0}
  var speed = {bullet: 3, cannon: 1777, minTime: 1777};
  var lives = {beginning: 133, now: 133};
  var highscores = {};
  var name = "Adron";
  var phase = {name: "normal"}
  class Player {
    constructor() {
    this.position = window.innerHeight/2;
    this.bullets = {max: 1, got: []};
    this.speed = 10;
    if (gerät == "Handy") this.speed = 15;
    this.selectedBullet = 0;
    }
    shoot = (bullet) => {
      console.log("shoot!");
      bullet = player.bullets.got[player.selectedBullet];
      if (bullet) new Audio('https://adi.nicolaiweitkemper.de/Sounds/protectTheRoom/shot.wav').play();
      // bullet.y = this.position - bullet.height;
      bullet.speed += 5;
      bullets.push(JSON.parse(JSON.stringify(bullet)));
      if (player.selectedBullet == player.bullets.got.length - 1 && player.selectedBullet > 0) player.selectedBullet--;
      player.bullets.got.splice(player.selectedBullet, 1);
      player.reload = {index: player.selectedBullet, left: 333};
      player.selectedBullet = -1;
    }
  }
  var player = new Player();
  function startGame() {
  disableScroll();
  window.scroll(0, 0);
    requestAnimationFrame(animateBullet);
  }
  var canvas = textur.getContext('2d');
  textur.width = window.innerWidth - textur.getBoundingClientRect().left;
  textur.height = window.innerHeight - textur.getBoundingClientRect().top - 10;
  canvas.fillStyle = "black";
  canvas.fillRect(0, 0, textur.width, textur.height);
  //   var cannons = [{x: 10, y: 10, width: 17, height: 17, speed: 1777, bulletSpeed: 10, timeGone: 0, direction: {x: 1, y: 0}}];
  var cannons = [];
  var bullets = [];
  function animateBullet(time) {
    canvas.fillStyle = "black";
    canvas.fillRect(0, 0, textur.width, textur.height);
    // show selected player bullet
    canvas.fillStyle = "red";
    var selectedBullet = player.bullets.got[player.selectedBullet];
    if (selectedBullet) {
    selectedBullet.y = player.position - selectedBullet.height;
    canvas.fillRect(selectedBullet.x, selectedBullet.y, selectedBullet.width, selectedBullet.height);
    }
    canvas.fillStyle = "white";
    canvas.fillRect(window.innerWidth - 110, player.position, 50, 50);
    for (var cannon of cannons) {
      canvas.fillRect(cannon.x, cannon.y, cannon.width, cannon.height);
      cannon.timeGone += 16;
      if (cannon.timeGone == 16 || cannon.timeGone >= cannon.speed) {
        cannon.timeGone = 1;
        bullets.push(JSON.parse(JSON.stringify({speed: cannon.bulletSpeed, x: cannon.x + 1*Math.abs(cannon.direction.y), y: cannon.y + 1*Math.abs(cannon.direction.x), width: cannon.width - 2*Math.abs(cannon.direction.y), height: cannon.height - 2*Math.abs(cannon.direction.x), direction: cannon.direction})));
      }
    }
    bullets.forEach((bullet, i) => {
      // bullet room collision
      if (bullet.x + bullet.width > window.innerWidth - 50) {
        lives.now -= bullet.width;
        bullets.splice(i, 1);
        new Audio('https://adi.nicolaiweitkemper.de/Sounds/protectTheRoom/damage.wav').play();
      }
      else {
      // player bullet collision check
      if (!bullet.fromPlayer && isCollide(bullet, {x: window.innerWidth - 110, y: player.position, width: 50, height: 50})) {
        console.log("player hit bullet!");
        if (player.bullets.got.length < player.bullets.max && phase.name != "useAmmo") {
          new Audio('https://adi.nicolaiweitkemper.de/Sounds/protectTheRoom/pick_bullet.wav').play();
          bullet.direction.x = -1;
          bullet.fromPlayer = true;
          bullet.x = window.innerWidth - 110 + 50 - bullet.width;
          player.bullets.got.push(JSON.parse(JSON.stringify(bullet)));
        }
        bullets.splice(i, 1);
      }
      // player bullet cannons collision check
      if (bullet.fromPlayer) {
        cannons.forEach((cannon, i1) => {
          if (isCollide(cannon, bullet)) {
            cannons.splice(i1, 1);
            new Audio('https://adi.nicolaiweitkemper.de/Sounds/protectTheRoom/cannon_explosion.wav').play();
          }
        });
      }
      var playerBullets = bullets.filter(a => a.fromPlayer);
      if (selectedBullet) playerBullets.push(JSON.parse(JSON.stringify(selectedBullet)));
      // player bullet enemy bullet collision check
      playerBullets.forEach((playerBullet, i1) => {
        if (playerBullet && !bullet.fromPlayer && isCollide(playerBullet, bullet) && JSON.stringify(playerBullet) != JSON.stringify(bullet)) {
          bullets.splice(i, 1);
          new Audio('https://adi.nicolaiweitkemper.de/Sounds/protectTheRoom/shot_shot.wav').play();
          if (player.selectedBullet == player.bullets.got.length - 1 && player.selectedBullet > 0) player.selectedBullet--;
          if (i1 == playerBullets.length - 1 && selectedBullet) {
            console.log("deffed with bullet on hand!");
            player.bullets.got.splice(player.selectedBullet, 1);
          }
        }
      });
    }
      canvas.fillStyle = "white";
      if (bullet.fromPlayer) canvas.fillStyle = "red";
      canvas.fillRect(bullet.x, bullet.y, bullet.width, bullet.height);
      bullet.x += bullet.speed*bullet.direction.x;
      bullet.y += bullet.speed*bullet.direction.y;
    });
    bullets = bullets.filter(b => b.x < textur.width && b.y < textur.height && b.y >= -(b.height) && b.x >= -(b.width));
    // room layout
    canvas.fillStyle = "white";
    canvas.fillRect(window.innerWidth - 50, 0, 35, window.innerHeight);
    canvas.fillStyle = "rgba(40, 228, 70, 0.55)";
    canvas.fillRect(window.innerWidth - 50, -window.innerHeight*(lives.now/lives.beginning) + window.innerHeight, 35, window.innerHeight);
    newCannon.time.got += 16;
    if (newCannon.time.got >= newCannon.time.needed) {
      var size = Math.round(Math.random()*140) + player.speed;
      cannons.push({x: 33, y: Math.round(Math.random()*window.innerHeight - size), width: size, height: size, speed: /*Math.round(Math.random()**/speed.cannon/*)*/, bulletSpeed: speed.bullet, timeGone: 0, direction: {x: 1, y: 0}});
      // if (cannons[cannons.length - 1].speed < speed.minTime) cannons[cannons.length - 1].speed = 999;
      // do {
      // var cannonCollsion = false;
      // for (var cannon of cannons) {
      //   if (cannons[cannons.length - 1] && isCollide(cannon, cannons[cannons.length - 1]) && JSON.stringify(cannon) != JSON.stringify(cannons[cannons.length - 1])) {
      //     cannons[cannons.length - 1].y = Math.round(Math.random()*window.innerHeight - size);
      //     cannonCollsion = true;
      //   }
      // }
      // } while (cannonCollsion);
      if (cannons[cannons.length - 1].y < size) cannons[cannons.length - 1].y = size;
      newCannon.counter++;
      if (phase.counter) phase.counter--;
      // increasing difficulty
      // newCannon.time.needed -= window.innerHeight*3.3//3;
      // player.speed = 33;
      // player.bullets.max = 6;
      // speed.bullet = 11;
      if (newCannon.time.needed > window.innerHeight*1.7 && phase.name == "normal") newCannon.time.needed -= 16;
      else if (!useMultAmmo.checked && newCannon.time.needed > window.innerHeight*1.2) newCannon.time.needed -= 16;
        else if (useMultAmmo.checked && phase.counter == 0) {
       if (phase.name == "normal" || phase.name == "useAmmo") {
         setTimeout(function () {
           newCannon.time.needed = window.innerHeight*5 - window.innerHeight*1.5//3;
           if (gerät == "Handy") newCannon.time.needed += 1333;
           player.speed = 33;
           speed.bullet = 5//3;
           phase.counter = player.bullets.max + 3;//9;
           phase.name = "collectAmmo";
           console.log(phase.name);
         }, 1555);
        }
        else if (phase.name == "collectAmmo") {
          newCannon.time.needed = window.innerHeight*1.4//3;
          player.speed = 45;
          speed.bullet = 11;
          phase.counter = player.bullets.max - 2 //4;
          bullets.pop();
          phase.name = "useAmmo";
          console.log(phase.name);
          player.bullets.max++;
        }
      }
      else if (useMultAmmo.checked && !phase.counter) phase.counter = 7;
      if (player.speed < 33) player.speed += 0.2;
      else if (!useMultAmmo.checked && player.speed < 89) player.speed += 0.2;
      if (player.bullets.max < 6 && !(newCannon.counter/(10 + Math.round(newCannon.counter/10)) + "").includes('.')) player.bullets.max++;
      if (speed.bullet < 11) speed.bullet += 0.1;
      newCannon.time.got = 0;
    }
    // layout ammo
    player.bullets.got.sort((x, y) => x.width - y.width);
    var lastAmmoPosition = 0;
    for (var i = 0; i < player.bullets.max; i++) {
      var bullet = player.bullets.got[i];
      if (player.bullets.got[i]) {
        canvas.fillStyle = "rgba(255, 0, 0, 0.5)";
        canvas.fillRect(10 + lastAmmoPosition, 10 + 27, bullet.width, bullet.height);
        if (i == player.selectedBullet) canvas.fillRect(10 + lastAmmoPosition, 10 + 27 + bullet.height + 10, bullet.width, 10);
        lastAmmoPosition += bullet.width + 10;
      }
      else {
        canvas.fillStyle = "rgba(131, 123, 123, 0.5)";
        canvas.fillRect(10 + lastAmmoPosition, 10 + 27, 50, 50);
        lastAmmoPosition += 60;
      }
    }
    canvas.font = "35px Arial";
    canvas.fillStyle = "rgba(131, 123, 123, 0.5)";
    canvas.fillText("score: " + newCannon.counter, 10, 8 + 20);
    if (player.selectedBullet == -1) {
    	player.reload.left -= 16;
    	if (player.reload.left < 1) {
      	player.selectedBullet = player.reload.index;
      }
    }
    if (lives.now > 0) requestAnimationFrame(animateBullet);
    else {
    	if (!highscores[name] || newCannon.counter > highscores[name]) highscores[name] = newCannon.counter;
    }
  }
  document.onkeydown = function(event) {
    if (event.key.toLowerCase().includes("up")) player.position -= player.speed;
    if (event.key.toLowerCase().includes("down")) player.position += player.speed;
    if (event.key.toLowerCase().includes("left") && player.selectedBullet > 0) player.selectedBullet--;
    if (event.key.toLowerCase().includes("right") && player.selectedBullet + 1 < player.bullets.got.length && player.selectedBullet != -1) player.selectedBullet++;
    if (event.key == " ") player.shoot(player.bullets.got[player.selectedBullet]);
}

function isCollide(a, b) {
  return (a.x < b.x + b.width &&
   a.x + a.width > b.x &&
   a.y < b.y + b.height &&
   a.y + a.height > b.y)
}
// newCannon.time.needed = window.innerHeight*1.7//3;
// player.speed = 33;
// player.bullets.max = 6;
// speed.bullet = 11;
// reloadAmmo max
// newCannon.time.needed -= window.innerHeight*1.5//3;
// newCannon.time.needed = window.innerHeight*5 - window.innerHeight*1.5//3;
// player.speed = 33;
// player.bullets.max = 6;
// speed.bullet = 3;
// // speed.minTime = 999;
// evenFaster max:
newCannon.time.needed = window.innerHeight*1.2//3;
player.speed = 89;
player.bullets.max = 6;
speed.bullet = 11;

// enableand disable scrolling
// left: 37, up: 38, right: 39, down: 40,
// spacebar: 32, pageup: 33, pagedown: 34, end: 35, home: 36
var keys = {37: 1, 38: 1, 39: 1, 40: 1};

function preventDefault(e) {
  e.preventDefault();
}

function preventDefaultForScrollKeys(e) {
  if (keys[e.keyCode]) {
    preventDefault(e);
    return false;
  }
}

// modern Chrome requires { passive: false } when adding event
var supportsPassive = false;
try {
  window.addEventListener("test", null, Object.defineProperty({}, 'passive', {
    get: function () { supportsPassive = true; }
  }));
} catch(e) {}

var wheelOpt = supportsPassive ? { passive: false } : false;
var wheelEvent = 'onwheel' in document.createElement('div') ? 'wheel' : 'mousewheel';

// call this to Disable
function disableScroll() {
  window.addEventListener('DOMMouseScroll', preventDefault, false); // older FF
  window.addEventListener(wheelEvent, preventDefault, wheelOpt); // modern desktop
  window.addEventListener('touchmove', preventDefault, wheelOpt); // mobile
  window.addEventListener('keydown', preventDefaultForScrollKeys, false);
}

// call this to Enable
function enableScroll() {
  window.removeEventListener('DOMMouseScroll', preventDefault, false);
  window.removeEventListener(wheelEvent, preventDefault, wheelOpt);
  window.removeEventListener('touchmove', preventDefault, wheelOpt);
  window.removeEventListener('keydown', preventDefaultForScrollKeys, false);
}
document.addEventListener('touchmove', touch);
document.addEventListener('touchstart', touch);
document.addEventListener('touchend', touch);
// document.getElementById('textur').style = "touch-action: none";
var swipe = {};
function touch(ev) {
  if (ev.touches[1]) player.shoot();
  if (ev.type == "touchstart") {
    var firstTouch = getTouches(ev)[0];
    xDown = firstTouch.clientX;
    yDown = firstTouch.clientY;
    swipe = {beginning: {x: firstTouch.clientX, y: firstTouch.clientY}, counter: -5};
  }
  if (ev.type == "touchmove") {
    swipe.counter++;
    var xDiff = swipe.beginning.x - ev.touches[0].clientX;
    var yDiff = yDown - ev.touches[0].clientY;
    firstTouch = getTouches(ev)[0];
    if ( Math.abs( xDiff ) > Math.abs( yDiff ) ) {/*most significant*/
      console.log(swipe.counter);
      if (swipe.counter == 10 || swipe.counter == -1) {
        swipe.counter = 0;
        if ( xDiff > 0 && player.selectedBullet > 0) {
          player.selectedBullet--;
            /* left swipe */
        } else if (xDiff < 0 && player.selectedBullet + 1 < player.bullets.got.length && player.selectedBullet != -1) {
            /* right swipe */
            player.selectedBullet++;
        }
      }
    } else {
        if ( yDiff > 0 ) {
            /* up swipe */
            player.position -= player.speed/3;
        } else {
            /* down swipe */
            player.position += player.speed/3;
        }
    }
  }
  // toggleFullscreen(document.body);
}
var xDown;
var yDown;

function getTouches(ev) {
return ev.touches ||             // browser API
       ev.originalEvent.touches; // jQuery
}
</script>
