<!DOCTYPE html>
<meta charset="utf-8">
<script src="https://adi.nicolaiweitkemper.de/Database2/js.js"></script>
<script src="https://cdn.jsdelivr.net/npm/vue/dist/vue.js"></script>
<script src="https://ajax.googleapis.com/ajax/libs/angularjs/1.4.5/angular.min.js"></script>
<html>

<head>
  <title>game of caution</title>
  <canvas id="textur" width="1582" style="border-width: 3px; border-style: solid;" onclick="canvasClicked();" height="740"></canvas>
  <meta name="viewport" id="scaleControler">
  <div id="ball">
    <style>
      .shape {
   position: absolute;
   width: 50px;
   height: 50px;
   -webkit-radius: 50px;
   margin:0;
   padding:0;
  }
  #sphere1{
   border-radius: 50px;
   background-color: blue;
  }
  </style>
  </div>
</head>

<body>
  <div id="content">
    <div class="shape" id="sphere1"></div>
  </div>
  <br>
  <head>
    <style>
      table, td {
  border: 1px solid black;
}
</style>
  </head>
  <input id="easyMaps" checked="true" onchange="if (checked) {level.normal.levelType = 'easyMaps';} else level.normal.levelType = 'vorgefertigt'; courceSelected();" type="checkbox"> easy map versions
  <h2>sensibility: </h2>
  <a id="sensibilityTitleLeft">high (fast)</a>
  <input type="range" min="1" onchange="sensibility(document.getElementById('sensibility').value)" max="25" value="5" class="slider" id="sensibility">
  <a id="sensibilityTitleRight">low (slow)</a>
  <button type="button" id="normalSensibility" onclick="sensibility(currentLevel.sensibility, true)" name="button">back to normal</button>
  <table id="scores">
    <!-- <tr>
    <td>Row1 cell1</td>
    <td>Row1 cell2</td>
  </tr>
  <tr>
    <td>Row2 cell1</td>
    <td>Row2 cell2</td>
  </tr>
  <tr>
    <td>Row3 cell1</td>
    <td>Row3 cell2</td>
  </tr> -->
  </table>
  <br>
  <br>
  <div id="app">
    <li v-for="title in db" id="levelNames">
      {{ title }}
    </li>
  </div>
  <select name="course" id="courceSelection" onchange="courceSelected()">
  </select>
  <input type="checkbox" onchange="inOrAgainstDirection *= -1;" id="oppositeCheck"> opposite
  <p id="joyStickPlayP"> <input type="checkbox" onchange="if (checked) textur.style.touchAction = 'none';" id="joyStickPlay"> joystick control </p>
  <br>
  <select name="course" id="modeSelection" style="display:none" value="move" onchange="modeSelected(value);">
    <option value="normal">normal</option>
    <option value="growing">growing</option>
    <option value="survive">survive</option>
  </select>
  <br>
  <div id="checkpointManagement">
    <select id="checkpointSelection" onchange="checkpointSelected(value);"></select>
    <button onclick="deleteCheckpoint();">delete latest checkpoint</button>
  </div>
  <!-- <button type="button" id="saveMaps" onclick="saveMapsVorgefertigt()" name="button">save vorgefertigt maps and other data on device for offline mode</button> -->
  <br>
  <select id="tabletPositionModeSelection">
    <option>flat (most natural)</option>
    <option>almost on end (slopes away from you a bit, best? for your posture)</option>
    <option>on end (better for your posture)</option>
  </select>
  <script type="text/javascript">
  if (navigator.userAgent.match(/Android/i) ||
    navigator.userAgent.match(/webOS/i) ||
    navigator.userAgent.match(/iPhone/i) ||
    navigator.userAgent.match(/iPad/i) ||
    navigator.userAgent.match(/iPod/i) ||
    navigator.userAgent.match(/BlackBerry/i) ||
    navigator.userAgent.match(/Windows Phone/i)
  ) {
    var gerät = "Handy"
    console.log("Handy");
    sensibilityTitleLeft.innerHTML = "low (slow)";
    sensibilityTitleRight.innerHTML = "high (fast)";
  } else {
    var gerät = "PC"
    joyStickPlayP.style.display = "none";
    tabletPositionModeSelection.style.display = "none";
    joyStickPlay.checked = true;
    console.log("PC");
  }
  var inOrAgainstDirection = 1;
  window.onbeforeunload = function(){
  console.log("Leave Website");
    if (dbSetWarteschlange.length > 0) {alertWhenFinishedSaving = true; return 'Es wurden noch nicht alle Änderungen gespeichert! Bitte klicken sie auf "bleiben" und warten sie auf die Meldung, dass der Speichervorgang erfolgreich war!';}
  };
  var sphere1 = document.getElementById("sphere1");
  var growing;
  function modeSelected(value) {
    clearInterval(growing);
    level.mode = value;
    startPause();
    if (value == "growing") {
      sphere1.style.width =  level.growing[level.growing.levelType][level.growing.number].beginningSize.x//(window.innerWidth / 40 + 66) / 2 + "px";
      sphere1.style.height = level.growing[level.growing.levelType][level.growing.number].beginningSize.y//(window.innerHeight / 40 + 66) / 2 + "px";
      growing = setInterval(function () {
        sphere1.style.width = (JSON.parse(sphere1.style.width.toString().split('px')[0]) + level.growing[level.growing.levelType][level.growing.number].miliSecForGrowning) + "px";
        sphere1.style.height = (JSON.parse(sphere1.style.height.toString().split('px')[0]) + level.growing[level.growing.levelType][level.growing.number].miliSecForGrowning) + "px";
        level.growing[level.growing.levelType][level.growing.number].spawnPoint.x = window.innerWidth/2 - JSON.parse(sphere1.style.width.toString().split('px')[0]) + 77;
        level.growing[level.growing.levelType][level.growing.number].spawnPointy = window.innerHeight/2 - JSON.parse(sphere1.style.height.toString().split('px')[0]);
      }, 7);
    }
    else {
      sphere1.style.width = 50 + "px";
      sphere1.style.height = 50 + "px";
    }
  }
  function checkpointSelected(value) {
    if (value == "start") {
      checkpoint = checkpoints[level.mode][level[level.mode].number][0];
      level.checkpoint = 0;
    }
    else {
      checkpoint = checkpoints[level.mode][level[level.mode].number][parseInt(value.split('. ')[0])];
      level.checkpoint = parseInt(value.split('. ')[0]);
    }
  }
  function deleteCheckpoint() {
    if (checkpoints[level.mode][level[level.mode].number].length > 1 && level.checkpoint && confirm('Are you sure you want to delete the latest checkpoint (' + (checkpoints[level.mode][level[level.mode].number].length - 1) + '.) ?')) {
      checkpoints[level.mode][level[level.mode].number].pop();
      document.getElementById('checkpointSelection').options[level.checkpoint] = undefined;
      level.checkpoint--;
      if (!level.checkpoint) {
        checkpointManagement.style.display = "none";
      }
      checkpoint = checkpoints[level.mode][level[level.mode].number][level.checkpoint];
      localStorage.setItem('checkpointsGeduldspiel', JSON.stringify(checkpoints));
      if (level.checkpoint) checkpointSelection.value = level.checkpoint + '. checkpoint';
      else checkpointSelection.value = "start";
      restartLevel();
   }
  }
  var sensibilityAcc = {x: 5, y: 5};
  function sensibility(value, backToNormal) {
    document.getElementById('sensibility').value = value;
    sensibilityAcc = {x: value, y: value};
  }
    visible([
      ['app', "none"],
      // ['sliderSize', "none"],
      // ['sliderWidth', "none"],
      // ['sliderHeight', "none"],
      // ['angle', "none"]
    ])

    var canvas = textur.getContext('2d'); //Dimension
    console.log(window.innerWidth + " - " + window.innerHeight);
    var RotatingWall;
    var RotatingDreieck;
    var BlinkWall;
    var mins = 0;
    var secs = 0;
    var tenths = 0;
    var time = 0;
    var x1 = 10,
      y1 = 177; //window.innerHeight - 150 + 3,
    x2 = 0, y2 = 0,
      vx1 = 0, vy1 = 0,
      vx2 = 0, vy2 = 0,
      ax1 = 0, ay1 = 0;
    var mausx = 0;
    var mausy = 0;
    var zählerListe = [window.innerHeight];
    var offline = false;
    var Bild = new Image();
    if (offline == false) Bild.src = "https://adi.nicolaiweitkemper.de/Bilder/Gelduldspiel/normal/GeduldsspielMap1.png"
    canvas.drawImage(Bild, 0, 0, window.innerWidth, window.innerHeight)
    setTimeout(function() {
      Layout();
    }, 500);
    var level = {
      checkpoint: 0,
      normal: {
      rotating: {
        blinkWall: [false] /*, rotatingWall: false*/ ,
        rotatingDreieck: false
      },
      number: 1,
      easyMaps: {
        2: {
          spawnPoint: {
            x: 300,
            y: 755
          }
        },
        4: {
          spawnPoint: {
            x: 175,
            y: 133
          },
        },
        5: {
          spawnPoint: {
            x: 175,
            y: 133
          },
          blinkWall: [{
            timeInvisible: 3000,
            timeVisible: 2000,
            x: 349,
            y: 388,
            width: 17,
            height: 320
          }, {
            timeInvisible: 2000,
            timeVisible: 2000,
            x: 649,
            y: 388,
            width: 17,
            height: 320
          }, {
            timeInvisible: 2000,
            timeVisible: 2000,
            x: 949,
            y: 388,
            width: 17,
            height: 320
          }, {
            timeInvisible: 2000,
            timeVisible: 2000,
            x: 1249,
            y: 388,
            width: 17,
            height: 320
          }]
        },
        6: {
          spawnPoint: {
            x: 250,
            y: 155
          }
        },
        7: {
          spawnPoint: {
            x: 150,
            y: 155
          }
        },
        10: {
          rotatingDreieck: [{
            x: 700,
            y: 370,
            size: 50,
            timeFor360GradRotation: 7000,
            angle: 0
          }]
        },
        14: {
          rotatingWall: [{
            x: window.innerWidth / 2,
            y: window.innerHeight / 2,
            width: window.innerWidth - 120,
            height: 17,
            angle: 0
          }, {
            x: window.innerWidth / 2,
            y: window.innerHeight / 2,
            width: window.innerWidth - 120,
            height: 17,
            angle: 44
          }, {
            x: window.innerWidth / 2,
            y: window.innerHeight / 2,
            width: window.innerWidth - 120,
            height: 17,
            angle: 110
          }, {
            x: window.innerWidth / 2,
            y: window.innerHeight / 2,
            width: window.innerWidth - 120,
            height: 17,
            angle: 150
          }]
        },
        15: {
          rotatingDreieck: [{
            x: window.innerWidth / (1600 / 300),
            y: window.innerHeight / (769 / 155),
            size: window.innerWidth / (1600 / 50),
            timeFor360GradRotation: 5000,
            angle: 0
          }, {
            x: window.innerWidth / (1600 / 500),
            y: window.innerHeight / (769 / 444),
            size: (window.innerWidth + window.innerHeight) / ((1600 + 769) / 30),
            timeFor360GradRotation: 5000,
            angle: 10
          }, {
            x: window.innerWidth / (1600 / 733),
            y: window.innerHeight / (769 / 588),
            size: window.innerWidth / (1600 / 30),
            timeFor360GradRotation: 5000,
            angle: 0
          }, {
            x: window.innerWidth / (1600 / 1222),
            y: window.innerHeight / (769 / 377),
            size: window.innerWidth / (1600 / 100),
            timeFor360GradRotation: 5077,
            angle: 0
          }]
        },
        23: {
          cannons: [
            {x: 1520 + 100, y: 45, width: 100, height: 100, speed: 14000, bulletSpeed: 7, timeGone: 0, direction: {x: -1, y: 0}}
          ],
        },
        24: {
          sensibility: 7,
          cannons: [
            {x: 1520 + 100, y: -17, width: 100, height: 50, speed: 7000, bulletSpeed: 3, timeGone: 0, direction: {x: -1, y: 0}},
            {x: 1520 + 100, y: 145, width: 100, height: 50, speed: 7000, bulletSpeed: 3, timeGone: 0, direction: {x: -1, y: 0}}
          ],
        },
      },
      vorgefertigt: {
        1: {
          spawnPoint: {
            x: 700,
            y: 555
          }
        },
        2: {
          spawnPoint: {
            x: 300,
            y: 577
          }
        },
        3: {
          spawnPoint: {
            x: 50,
            y: 255
          }
        },
        4: {
          spawnPoint: {
            x: 75,
            y: 75
          }
        },
        5: {
          spawnPoint: {
            x: 75,
            y: 75
          },
          blinkWall: [{
            timeInvisible: 3000,
            timeVisible: 2000,
            x: 349,
            y: 475,
            width: 17,
            height: 225
          }, {
            timeInvisible: 2000,
            timeVisible: 2000,
            x: 475,
            y: 475,
            width: 17,
            height: 225
          }, {
            timeInvisible: 2000,
            timeVisible: 2000,
            x: 600,
            y: 475,
            width: 17,
            height: 225
          }, {
            timeInvisible: 2000,
            timeVisible: 2000,
            x: 725,
            y: 475,
            width: 17,
            height: 225
          }, {
            timeInvisible: 2000,
            timeVisible: 2000,
            x: 922,
            y: 475,
            width: 17,
            height: 225
          }, {
            timeInvisible: 1000,
            timeVisible: 1000,
            x: 1050,
            y: 475,
            width: 17,
          }, {
            timeInvisible: 1000,
            timeVisible: 1000,
            x: 1250,
            y: 475,
            width: 17,
            height: 225
          }]
        },
        6: {
          spawnPoint: {
            x: 150,
            y: 155
          }
        },
        7: {},
        8: {
          spawnPoint: {
            x: 50,
            y: 455
          }
        },
        9: {
          rotatingWall: [{
            x: 700,
            y: 400,
            width: 1480,
            height: 17,
            angle: 0
          }]
        },
        10: {
          rotatingDreieck: [{
            x: 700,
            y: 370,
            size: 50,
            timeFor360GradRotation: 3000,
            angle: 0
          }]
        },
        11: {
          spawnPoint: {
            x: 50,
            y: 155
          }
        },
        12: {},
        13: {
          blinkWall: [{
            timeInvisible: 3000,
            timeVisible: 3000,
            x: 210,
            y: 177,
            width: 115,
            height: 17
          }, {
            x: 210,
            y: 388,
            width: 115,
            height: 17
          }]
        },
        14: {
          screenSizeDependent: true,
          rotatingWall: [{
            x: window.innerWidth / 2,
            y: window.innerHeight / 2,
            width: window.innerWidth - 120,
            height: 17,
            angle: 0
          }, {
            x: window.innerWidth / 2,
            y: window.innerHeight / 2,
            width: window.innerWidth - 120,
            height: 17,
            angle: 22
          }, {
            x: window.innerWidth / 2,
            y: window.innerHeight / 2,
            width: window.innerWidth - 120,
            height: 17,
            angle: 44
          }, {
            x: window.innerWidth / 2,
            y: window.innerHeight / 2,
            width: window.innerWidth - 120,
            height: 17,
            angle: 88
          }, {
            x: window.innerWidth / 2,
            y: window.innerHeight / 2,
            width: window.innerWidth - 120,
            height: 17,
            angle: 110
          }, {
            x: window.innerWidth / 2,
            y: window.innerHeight / 2,
            width: window.innerWidth - 120,
            height: 17,
            angle: 130
          }, {
            x: window.innerWidth / 2,
            y: window.innerHeight / 2,
            width: window.innerWidth - 120,
            height: 17,
            angle: 150
          }, {
            x: window.innerWidth / 2,
            y: window.innerHeight / 2,
            width: window.innerWidth - 120,
            height: 17,
            angle: 70
          }]
        },
        16: {
          rotatingWall: [{
            x: window.innerWidth / 2,
            y: window.innerHeight / 2,
            width: window.innerWidth - 200,
            height: 17,
            angle: 0
          }]
        },
        15: {
          sensibility: 9,
          screenSizeDependent: true,
          rotatingDreieck: [{
            x: window.innerWidth / (1600 / 300),
            y: window.innerHeight / (769 / 155),
            size: window.innerWidth / (1600 / 37),
            timeFor360GradRotation: 3000,
            angle: 0
          }, {
            x: window.innerWidth / (1600 / 500),
            y: window.innerHeight / (769 / 444),
            size: (window.innerWidth + window.innerHeight) / ((1600 + 769) / 37),
            timeFor360GradRotation: 3000,
            angle: 10
          }, {
            x: window.innerWidth / (1600 / 733),
            y: window.innerHeight / (769 / 588),
            size: window.innerWidth / (1600 / 37),
            timeFor360GradRotation: 3000,
            angle: 0
          }, {
            x: window.innerWidth / (1600 / 1222),
            y: window.innerHeight / (769 / 377),
            size: window.innerWidth / (1600 / 96),
            timeFor360GradRotation: 3077,
            angle: 0
          }]
        },
        17: {
        },
        18: {
          rotatingWall: [{
            x: 355,
            y: 130,
            width: 370,
            height: 17,
            angle: 0
          }, {
            x: 1080,
            y: 450,
            width: 400,
            height: 17,
            angle: 0
          }, {
            x: 657,
            y: 370,
            width: 355,
            height: 17,
            angle: 0
          }, {
            x: 1350,
            y: 370,
            width: 311,
            height: 17,
            angle: 0
          }, {
            x: 911,
            y: 70,
            width: 311,
            height: 17,
            angle: 0
          }, {
            x: 733,
            y: 630,
            width: 311,
            height: 17,
            angle: 0
          }]
        },
        19: {},
        20: {},
        21: {},
        22: {},
        23: {
          cannons: [
            {x: 1520 + 100, y: 45, width: 100, height: 100, speed: 9999, bulletSpeed: 7, timeGone: 0, direction: {x: -1, y: 0}}
          ],
        },
        24: {
          sensibility: 7,
          cannons: [
            {x: 1520 + 100, y: 10, width: 100, height: 50, speed: 7000, bulletSpeed: 10, timeGone: 0, direction: {x: -1, y: 0}},
            {x: 1520 + 100, y: 137, width: 100, height: 50, speed: 7000, bulletSpeed: 10, timeGone: 0, direction: {x: -1, y: 0}}
          ],
        },
      },
      editLevel: {
        selectedLevel: 1
      },
      editHistory: [],
      stepOfHistory: -1,
      worldWideLevel: {},
      levelType: "easyMaps"
    },
    growing: {
      rotating: {
        blinkWall: [false] /*, rotatingWall: false*/ ,
        rotatingDreieck: false
      },
      number: 1,
      editLevel: {
        selectedLevel: 1
      },
      editHistory: [],
      stepOfHistory: -1,
      worldWideLevel: {},
      levelType: "vorgefertigt",
      vorgefertigt: {
        1: {
          miliSecForGrowning: 0.07,
          beginningSize: {
            x: (window.innerWidth / 40 + 333) / 2 + "px",
            y: (window.innerHeight / 40 + 333) / 2 + "px"
          },
          spawnPoint: {
            x: window.innerWidth/2 - sphere1.style.width,
            y: window.innerHeight/2 - sphere1.style.height
          }
        }
      }
    },
    survive: {
      rotating: {
        blinkWall: [false] /*, rotatingWall: false*/ ,
        rotatingDreieck: false
      },
      number: 1,
      editLevel: {
        selectedLevel: 1
      },
      editHistory: [],
      stepOfHistory: -1,
      worldWideLevel: {},
      levelType: "vorgefertigt",
      vorgefertigt: {
        1: {
          sensibility: 25,
          spawnPoint: {
            x: window.innerWidth/2 - sphere1.style.width,
            y: window.innerHeight/2 - sphere1.style.height
          },
          bullet: [
            {
              startPointInSec: 0,
              pxPerMiliSec: 33,
              startPosition: {
                x: -90,
                y: window.innerHeight/2 - 50
              },
              // endPosition:
              repeatIntervalIn_Secs: 7,
              repetitions: {need: 3, beginningtimes: [7, 7, 7]},
              direction: "right",
              radius: 50
            },
            {
              startPointInSec: 0,
              pxPerMiliSec: 33,
              startPosition: {
                x: -90,
                y: window.innerHeight/2 + 133
              },
              // endPosition:
              repeatIntervalIn_Secs: 7,
              repetitions: {need: 3, beginningtimes: [7, 7, 7]},
              direction: "right",
              radius: 50
            },
            {
              startPointInSec: 27,
              pxPerMiliSec: 15,
              startPosition: {
                x: window.innerWidth/2 + 100,
                y: -90
              },
              // endPosition:
              repeatIntervalIn_Secs: 7,
              repetitions: {need: 2, beginningtimes: [0, 0]},
              direction: "down",
              radius: 77
            },
            {
              startPointInSec: 34,
              pxPerMiliSec: 20,
              startPosition: {
                x: window.innerWidth/2 -150,
                y: -90
              },
              // endPosition:
              repeatIntervalIn_Secs: 7, // not needed (?)
              repetitions: {need: 0, beginningtimes: []},
              direction: "down",
              radius: 77
            }
          ]
        }
      }
    },
      mode: "normal"
    }
    //window.innerHeight - 150 + 3//window.innerHeight/4//610;
    // for (var i = 0; zählerListe[0]>0;i++) {
    //   data = canvas.getImageData(10, zählerListe[0], 1, 1);
    //   red = data.data[0];
    //   green = data.data[1];
    //   blue = data.data[2];
    //   alpha = data.data[3];
    //   if (red == 0 && blue == 0 && alpha == 255 && green == 0) {
    //     y1 = zählerListe[0] - (window.innerWidth/40 + 66);
    //     spawnPoint = zählerListe[0] - (window.innerWidth/40 + 66)
    //   }
    //   zählerListe[0]--;
    // }
    for (const key of Object.keys(level.normal.vorgefertigt)) {
      var pLevel = level.normal.vorgefertigt[key];
      if (!pLevel.spawnPoint) {
        pLevel.spawnPoint = {
          x: 50,
          y: 255
        };
      }
      if (!pLevel.sensibility) pLevel.sensibility = 5;
      for (const attr of Object.keys(pLevel)) {
        if (!level.normal.easyMaps[key]) level.normal.easyMaps[key] = {};
        if (!Object.keys(level.normal.easyMaps[key]).includes(attr)) level.normal.easyMaps[key][attr] = pLevel[attr];
      }
    }
    var highscores = {}
    var AblageListe = [];
    AblageListe[5] = window.innerHeight;
    for (var i = 0; i < Object.keys(level).length - 1; i++) {
      highscores[Object.keys(level)[i]] = {};
      // highscores[Object.keys(level)[i]] = [];
    }
    AblageListe[6] = false;
    function selected() {
      if (AblageListe[6] == true) {AblageListe[6] = false; document.getElementById('select').style.background = "";}
      else {AblageListe[6] = true; document.getElementById('select').style.background = "blue";}
    }
    var checkpoints = {};
    var checkpoint;
    folgenDbgetHighscores();
    function folgenDbgetHighscores() {
      if (localStorage.getItem('geduldsspielHighscores')) highscores = JSON.parse(localStorage.getItem('geduldsspielHighscores'));
      if (localStorage.getItem('checkpointsGeduldspiel')) checkpoints = JSON.parse(localStorage.getItem('checkpointsGeduldspiel'));
      AblageListe[0] = 0;
      for (let i = 0; i < Object.keys(level.normal.vorgefertigt).length; i++) {
        opt = document.createElement("option");
        document.getElementById("courceSelection").options.add(opt);
        opt.setAttribute("id", i);
        if (Object.keys(highscores.normal[joyStickPlay.checked]).includes((i + 1).toString())) opt.text = "✅ " +  (i + 1) + ". map";
        else opt.text = (i + 1) + ". map";
        opt.value = (i + 1) + ". map";
      }
      if (highscores.normal[joyStickPlay.checked]) courceSelection.value = (parseInt(Object.keys(highscores.normal[joyStickPlay.checked])[Object.keys(highscores.normal[joyStickPlay.checked]).length - 1]) + 1) + '. map';
      if (courceSelection.value == "") courceSelection.value = "1. map";
      setTimeout(() => {
        courceSelected();
        startPause();
      }, 777);
    }
    var app = new Vue({
      el: '#app',
      data: {
        db: []
      }
    })
    function restartLevel() {
      if (level.mode == "growing") {
        modeSelected("growing");
        startPause();
      }
      x1 = currentLevel.spawnPoint.x;
      y1 = currentLevel.spawnPoint.y; //AblageListe[5] - 150 + 3;
      time = 0;
      goToCheckpoint();
    }
    var currentLevel;
    function courceSelected() {
      bullets = [];
      if (currentLevel) var levelBefore = JSON.parse(JSON.stringify(currentLevel));
      for (let i = 1; i > 0 && window.innerHeight < textur.height; i -= 0.01) {
        scaleControler.content = "maximum-scale=" + i;
      }
      window.scroll(0, 0);
      level[level.mode].rotating.blinkWall = [false];
      level[level.mode].rotating.rotatingDreieck = false;
      level[level.mode].rotating.rotatingWall = false;
      if (document.getElementById('courceSelection').value != "vorgefertigt") app._data.db = [];
      /*if (document.getElementById('modeSelection').value == "survive") */
      clearInterval(BlinkWall);
        clearInterval(RotatingWall);
        clearInterval(RotatingDreieck);
      if (document.getElementById('courceSelection').value == "show Scores") {
        showScores();
        document.getElementById('levelEditTool').style.display = "none";
        level[level.mode].levelType = "showScores";      
      } else {
        time = 0;
        // level[level.mode].levelType = "vorgefertigt";
      //  if (highscores[level.mode][joyStickPlay.checked][name] != undefined && highscores[level.mode][joyStickPlay.checked][name].length > 0 && document.getElementById('courceSelection').value == "") level[level.mode].number++;
        if (document.getElementById('courceSelection').value != "") {
          level[level.mode].number = JSON.parse(document.getElementById('courceSelection').value.toString().split('.')[0]);
          currentLevel = level.normal[level.normal.levelType][level[level.mode].number];
        }
        else if (level[level.mode].number > Object.keys(level[level.mode].vorgefertigt).length) {
          alert("every vorgefertigt level finished! That was the last one :(  )");
        }
        if (checkpoints[level.mode][level[level.mode].number]) {
          checkpoint = checkpoints[level.mode][level[level.mode].number][checkpoints[level.mode][level[level.mode].number].length - 1];
        }
        else checkpoint = undefined;
        while (document.getElementById('checkpointSelection').options.length > 0) {
          document.getElementById('checkpointSelection').options[0] = undefined;
        }
        for (var i = 0; checkpoint && i < checkpoints[level.mode][level[level.mode].number].length; i++) {
          opt = document.createElement("option");
          document.getElementById("checkpointSelection").options.add(opt);
          if (i > 0) opt.text = i + ". checkpoint";
          else opt.text = "start";
        }
        if (checkpoints[level.mode][level[level.mode].number]?.length > 1) checkpointManagement.style.display = "inline";
        else checkpointManagement.style.display = "none";
        document.getElementById('textur').style.display = "inline";
        Layout();
        setTimeout(function() {
          Layout();
        }, 500);
        // startPause();
        window.scroll(0, 0)
      //  BlinkWall = setInterval(blinkWall, 6000);
      BlinkWall = setInterval(function() {
        for (var i = 0; currentLevel.blinkWall != undefined && i <  currentLevel.blinkWall.length; i++) {
          level[level.mode].rotating.blinkWall[i] = false;
        }
        setTimeout(function() {
          for (var i = 0; currentLevel.blinkWall != undefined &&  i < currentLevel.blinkWall.length; i++) {
            level[level.mode].rotating.blinkWall[i] = true;
          }
          level[level.mode].rotatingNow = "blinkWall";
          Layout();
        }, 3000);
        Layout();
      }, 6000);
      if (currentLevel != undefined && !(currentLevel.rotatingWall == undefined)) {
      RotatingWall = setInterval(function() {
        level[level.mode].rotating.rotatingWall = true;
        level[level.mode].rotatingNow = "rotatingWall";
        Layout();
        rotatingWall(true);
      }, 70);
    }
    if (level && currentLevel.cannons && !levelBefore.cannons) requestAnimationFrame(renderLoop);
      }
      if (!["vorgefertigt", "easyMaps"].includes(level[level.mode].levelType)) document.getElementById('textur').style.display = "none";
      if (level[level.mode].levelType != "showScores") document.getElementById('scores').style.display = "none";
      else document.getElementById('scores').style.display = "inline";
      if (level.type != "showScores" && currentLevel != undefined) {
      x1 = currentLevel.spawnPoint.x;
      y1 = currentLevel.spawnPoint.y;
      goToCheckpoint();
    }
    if (["vorgefertigt", "easyMaps"].includes(level[level.mode].levelType)) {
      Bild = new Image();
      if (easyMaps.checked) Bild.src = "https://adi.nicolaiweitkemper.de/Bilder/Gelduldspiel/" + level.mode + "/easyMaps/GeduldsspielMap" + level[level.mode].number + ".png"
      else Bild.src = "https://adi.nicolaiweitkemper.de/Bilder/Gelduldspiel/" + level.mode + "/GeduldsspielMap" + level[level.mode].number + ".png"
    }
    setTimeout(() => {
      textur.width = Bild.width;
      textur.height = Bild.height;
      if (currentLevel.screenSizeDependent) {
        textur.width = window.innerWidth;
        textur.height = window.innerHeight;
      }
      Layout();
    }, 777);
    document.getElementById('sensibility').value = currentLevel.sensibility;
    sensibilityAcc = {x: currentLevel.sensibility, y: currentLevel.sensibility};
    if (currentLevel.rotatingDreieck && !levelBefore.rotatingDreieck) requestAnimationFrame(renderLoop);
    }

    sphere1.style.width = 50 + "px";
    sphere1.style.height = 50 + "px";
    if (window.DeviceMotionEvent != undefined || joyStick.coordinates) {
      window.ondevicemotion = function(e) {
        if (tabletPositionModeSelection.value.split(' (')[0] == "flat") ax1 = inOrAgainstDirection * event.accelerationIncludingGravity.x * sensibilityAcc.x;
        else if (tabletPositionModeSelection.value.split(' (')[0] == "almost on end") ax1 = inOrAgainstDirection * (event.accelerationIncludingGravity.z - 1) * (-sensibilityAcc.x);
        else ax1 = inOrAgainstDirection * (event.accelerationIncludingGravity.z + 1.7) * (-sensibilityAcc.x);
        if (tabletPositionModeSelection.value.split(' (')[0] != "flat") ay1 = inOrAgainstDirection * event.accelerationIncludingGravity.y * 1.88 * sensibilityAcc.y;
        else ay1 = inOrAgainstDirection * event.accelerationIncludingGravity.y * sensibilityAcc.y;
      }
      function goToCheckpoint() {
        if (checkpoint) {
          x1 = checkpoint.position.x;
          y1 = checkpoint.position.y;
          time = checkpoint.timeNeededToReach;
        }
      }
      setInterval(function() {
        // joy-stick:
        var nextCoordinates = {x: 0, y: 0};
        if (joyStickPlay.checked && document.getElementById('courceSelection').value != "show Scores") {
          if (joyStick && joyStick.coordinates) {
            if (!oppositeCheck.checked) var nextCoordinates = {x: x1 + (mausx - joyStick.coordinates.x)/(JSON.parse(document.getElementById('sensibility').value)*3), y: y1 + (mausy - joyStick.coordinates.y)/(JSON.parse(document.getElementById('sensibility').value)*3)};
            else var nextCoordinates = {x: x1 - (mausx - joyStick.coordinates.x)/(JSON.parse(document.getElementById('sensibility').value)*3), y: y1 - (mausy - joyStick.coordinates.y)/(JSON.parse(document.getElementById('sensibility').value)*3)};
          }
        }
        // else if (gerät == "Handy") var nextCoordinates = {x: parseInt(x1 + vx1 / cssToNumber(sphere1.style.width)), y: parseInt(y1 + vy1 / cssToNumber(sphere1.style.height))}
        var landscapeOrientation = window.innerWidth / window.innerHeight > 1;
        if (landscapeOrientation) {
          vx1 = vx1 + ay1;
          vy1 = vy1 + ax1;
          vx2 = vx2 + ay1;
          vy2 = vy2 + ax1;
        } else {
          vy1 = vy1 - ay1;
          vx1 = vx1 + ax1;
          vy2 = vy2 - ay1;
          vx2 = vx2 + ax1;
        }
        vx1 = vx1 * 0.98;
        vy1 = vy1 * 0.98;
        y1 = parseInt(y1 + vy1 / 50);
        x1 = parseInt(x1 + vx1 / 50);

        vx2 = vx2 * 0.98;
        vy2 = vy2 * 0.98;
        y2 = parseInt(y2 + vy2 / 30);
        x2 = parseInt(x2 + vx2 / 30);
        //  if (scrollY > 0) document.getElementById('sphere1').style.display = "none";
        boundingBoxCheck();
        if (joyStickPlay.checked) {
          x1 = nextCoordinates.x;
          y1 = nextCoordinates.y;
          if (x1 < 0) x1 = 0;
          if (x1 > textur.getBoundingClientRect().right - JSON.parse(sphere1.style.height.replace("px", ""))) x1 = textur.getBoundingClientRect().right - JSON.parse(sphere1.style.height.replace("px", ""));
          if (y1 < 0) y1 = 0;
          if (y1 > textur.getBoundingClientRect().bottom - JSON.parse(sphere1.style.height.replace("px", ""))) y1 = textur.getBoundingClientRect().bottom - JSON.parse(sphere1.style.height.replace("px", ""));
        }
        sphere1.style.top = y1 + "px";
        sphere1.style.left = x1 + "px";
        if ( /*y1 <= AblageListe[5]*/ scrollY == 0) sphere1.style.display = "inline";
        else sphere1.style.display = "none";
        var numbers = [
          [x1 + JSON.parse(sphere1.style.width.replace("px", "")) - 7, y1 + JSON.parse(sphere1.style.height.replace("px", "")) / 2],
          [x1 + JSON.parse(sphere1.style.width.replace("px", "")) / 2, y1 - 8],
          [x1 + JSON.parse(sphere1.style.width.replace("px", "")) / 2, y1 + JSON.parse(sphere1.style.height.replace("px", "")) - 7],
          [x1 - 10, y1 + JSON.parse(sphere1.style.height.replace("px", "")) / 2]
        ]
        for (var i = 0; i < 4; i++) {
          // canvas.fillStyle = "red";
          // canvas.fillRect(numbers[i][0] - 10, numbers[i][1] - 10, 10, 10);
          data = canvas.getImageData(numbers[i][0], numbers[i][1], 1, 1);
          red = data.data[0];
          green = data.data[1];
          blue = data.data[2];
          alpha = data.data[3];
          if ((joyStick != "place" || !joyStickPlay.checked) && ((red == 0 && blue == 0 && alpha == 255 && green == 0) || (joyStickPlay.checked && red == 34 && blue == 76 && green == 177))) {
            console.log("Fail!");
            restartLevel();
          }
          if (!checkpoints[level.mode]) checkpoints[level.mode] = [];
          if (!checkpoints[level.mode][level[level.mode].number]) checkpoints[level.mode][level[level.mode].number] = [{position: {x: currentLevel.spawnPoint.x, y: currentLevel.spawnPoint.y}, timeNeededToReach: 0}];
          var newCheckpoint = 0;
          checkpoints[level.mode][level[level.mode].number].forEach((pCheckpoint, i1) => {
            
        if ((red == 168 && green == 230 && blue == 29) && Math.abs(x1 - pCheckpoint.position.x) > 100 || Math.abs(y1 - pCheckpoint.position.y) > 100) {
          newCheckpoint++;
        }
          if ((red == 168 && green == 230 && blue == 29) && Math.abs(x1 - pCheckpoint.position.x) < 100 && Math.abs(y1 - pCheckpoint.position.y) < 100) {
          if (i1) checkpointSelection.value = i1 + '. checkpoint';
          else checkpointSelection.value = 'start';
          level.checkpoint = i1;
          checkpoint = checkpoints[level.mode][level[level.mode].number][i1];
        }
        });
        if (newCheckpoint == checkpoints[level.mode][level[level.mode].number].length && (red == 168 && green == 230 && blue == 29)) {
          console.log("checkpoint!!!");
          checkpoints[level.mode][level[level.mode].number].push({position: {x: x1, y: y1}, timeNeededToReach: time})
          level.checkpoint++;
          checkpoint = checkpoints[level.mode][level[level.mode].number][level.checkpoint];
          localStorage.setItem('checkpointsGeduldspiel', JSON.stringify(checkpoints));
          opt = document.createElement("option");
          document.getElementById("checkpointSelection").options.add(opt);
          opt.text = level.checkpoint + ". checkpoint";
          checkpointManagement.style.display = "inline";
        }
          if (red == 255 && blue == 0 && alpha == 255 && green == 242) zielErreicht();
        }
        if (joyStickPlay.checked && document.getElementById('courceSelection').value != "show Scores" && !currentLevel.rotatingWall && !currentLevel.rotatingDreieck) Layout();
        if (joyStick && joyStick.coordinates && joyStickPlay.checked) {
          canvas.fillStyle = "blue";
          canvas.beginPath();
          canvas.arc(joyStick.coordinates.x, joyStick.coordinates.y, 10, 0, Math.PI*2, false);
          canvas.fill();
          canvas.strokeStyle = "green";
          canvas.beginPath();
          canvas.moveTo(joyStick.coordinates.x, joyStick.coordinates.y);
          canvas.lineTo(mausx, mausy);
          canvas.stroke();
          canvas.closePath();
        }
      }, 25);
    }
    document.onkeydown = () => {
      // TODO: pause
    }
    function blinkWall() {
      // if (!(level[level.mode].levelType == "editHistory")) {
      //Layout();
      //  setTimeout(function () {
      for (var i = 0; currentLevel != undefined && !(currentLevel.blinkWall == undefined) && i < currentLevel.blinkWall.length; i++) {
        canvas.fillStyle = "black";
        if ((level[level.mode].rotating.blinkWall[i] == true/* && (level[level.mode].levelType == "editLevel" || level[level.mode].levelType == "worldWideLevel")*/)) canvas.fillRect(currentLevel.blinkWall[i].x, currentLevel.blinkWall[i].y, currentLevel.blinkWall[i].width, currentLevel.blinkWall[i].height);
      }
      //  }, 3000);
      // }
      // else {
      //   for (var i = 0; !(currentLevel.blinkWall == undefined) && i < currentLevel.blinkWall.length; i++) {
      //     canvas.fillRect(currentLevel.blinkWall[i].x, currentLevel.blinkWall[i].y, currentLevel.blinkWall[i].width, currentLevel.blinkWall[i].height);
      //   }
      //}
    }

    function zielErreicht() {
      if (document.getElementById('courceSelection').value == "" && level[level.mode].number > Object.keys(level[level.mode].vorgefertigt).length) {
        alert("every vorgefertigt level finished! That was the last one :(  )");
      }
      if (["vorgefertigt", "easyMaps"].includes(level[level.mode].levelType)) {
        if (!highscores[level.mode][joyStickPlay.checked]) highscores[level.mode][joyStickPlay.checked] = {};
        if (highscores[level.mode][joyStickPlay.checked][level[level.mode].number] == undefined || highscores[level.mode][joyStickPlay.checked][level[level.mode].number] > mins + ":" + secs + ":" + "0" + tenths) {
          highscores[level.mode][joyStickPlay.checked][level[level.mode].number] = mins + ":" + secs + ":" + "0" + tenths;
          localStorage.setItem("geduldsspielHighscores", JSON.stringify(highscores));
        }
        level[level.mode].number++;
        document.getElementById('courceSelection').value = level[level.mode].number + ". map";
        courceSelected();
        if (level[level.mode].vorgefertigt[level[level.mode].number] == undefined) {
          console.log("everything Finished!");
          clearInterval(BlinkWall);
          clearInterval(RotatingWall);
          clearInterval(RotatingDreieck);
          showScores();
        }
      }
    if (currentLevel != undefined) {
    x1 = currentLevel.spawnPoint.x;
    y1 = currentLevel.spawnPoint.y;
  }
    if (document.getElementById('sensibility').value != level[level.mode][level[level.mode].levelType][level[level.mode].number - 1].sensibility && !(level[level.mode].number == highscores[level.mode][joyStickPlay.checked][name].length)) sensibility(currentLevel.sensibility);
  }
    function showScores() {
      var pHighscores = highscores[level.mode][joyStickPlay.checked];
      for (var i = 0; i < 11; i++) {
        try {
          document.getElementById("scores").deleteRow(0);
        } catch (e) {
          console.log("wanted to delete too many elements of table");
          i = 11
        }
      }
      document.getElementById('textur').style.display = "none";
      var cell = [ /*row.insertCell(0)*/ ];
        //  var cell = [/*row.insertCell(0)*/];
        for (var i1 = 1; (i1 < Object.keys(level[level.mode][level[level.mode].levelType]).length && ["vorgefertigt", "easyMaps"].includes(level[level.mode].levelType)) || (i1 < Object.keys(pHighscores).length + 1 && level[level.mode].levelType == "worldWideLevel"); i1++) {
            if (i1 < pHighscores.length + 1) {
              cell[cell.length - 2] = row.insertCell(i1);
              if (pHighscores[i1]) cell[cell.length - 2].innerHTML = pHighscores[i1];
              if (pHighscores[i1] > pHighscores[name][i1]) cell[cell.length - 2].style.color = "green";
              else if (pHighscores[i1] < pHighscores[name][i1]) cell[cell.length - 2].style.color = "red";
              else if (name == Object.keys(pHighscores)[i]) cell[cell.length - 2].style.color = "blue";
              else cell[cell.length - 2].style.color = "black";

            } else {
              cell[cell.length - 2] = row.insertCell(i1);
              //  cell[cell.length - 2].innerHTML = "unmade";
              //  cell[cell.length - 2].style.color = "black";
            }
        }
        if (table) var row = table.insertRow(i);
        if (i == 0) {}
        //  var row = table.insertRow(i+1);
        // var row = table.insertRow(i + 1);
      //  var row = table.insertRow(0);
      //  var cell = [/*row.insertCell(0)*/];
      // cell.push(row.insertCell(0));
      // cell[cell.length - 1].innerHTML = "name";f
      var row = table.insertRow(0);
      cell.push(row.insertCell(0));
      cell[cell.length - 1].innerHTML = "name";
      for (var i1 = 1; level[level.mode].levelType != "worldWideLevel" && i1 < Object.keys(level[level.mode][level[level.mode].levelType]).length; i1++) {
        cell.push(row.insertCell(i1));
        cell[cell.length - 1].innerHTML = (i1) + ". Map";
      }
    }
    // Für rotatingDreieck:
    const point = (x, y) => ({
      x,
      y
    });
    const triangle = createPath(point(0, -25), point(-50, -75), point(-100, -25));
    var rectangle = createPath(point(0,-25), point(-50,-25), point(-50,-125), point(0,-125));
    // function drawPath(path, x, y, angle) {
    //     canvas.setTransform(1, 0, 0, 1, x, y);
    //     canvas.rotate(level[level.mode].vorgefertigt[level[level.mode].number].rotatingDreieck[i].angle);
    //     canvas.stroke(path);
    // }

    function drawPath_V2(path, x, y, scale, angle, strokeStyle, fillStyle, i) {
      canvas.setTransform(scale, 0, 0, scale, x, y);
      if (level[level.mode].levelType == "editHistory"/* || level[level.mode].rotating.rotatingDreieck == false*/) angle = (currentLevel.rotatingDreieck[i].angle / 58);
      if (level[level.mode].rotating.rotatingDreieck == true && i == currentLevel.rotatingDreieck.length - 1) level[level.mode].rotating.rotatingDreieck = false;
      canvas.rotate(angle);
      fillStyle && (canvas.fillStyle = fillStyle, canvas.fill(path));
      strokeStyle && (canvas.strokeStyle = strokeStyle, canvas.stroke(path));
    }


    function renderLoop(time) {
      canvas.drawImage(Bild, 0, 0/*, window.innerWidth, AblageListe[5]*/);
      // if (level[level.mode].vorgefertigt[level[level.mode].number].screenSizeDependent) canvas.drawImage(Bild, 0, 0, window.innerWidth, window.innerHeight);
      //  canvas.clearRect(0, 0, textur.width, textur.height);
      //  if (!(level[level.mode].levelType == "editHistory")) Layout();
      const scale = Math.sin(time / 500) * 0.2 + 1.0;
      const scale2 = Math.cos(time / 1000) * 0.4 + 1.0;
      AblageListe[0] = time
  //    if (/*offline == true && */level[level.mode].levelType != "editHistory" && (level[level.mode].rotatingNow == "rotatingDreieck" || currentLevel.rotatingDreieck == undefined) ) Layout();
    //  if (["vorgefertigt", "easyMaps"].includes(level[level.mode].levelType)) Layout();
      for (var i = 0; currentLevel.rotatingDreieck != undefined && i < currentLevel.rotatingDreieck.length; i++) {
        time = AblageListe[0];
        // time += currentLevel.rotatingDreieck[i].angle * 10000
          drawPath_V2(triangle, currentLevel.rotatingDreieck[i].x, currentLevel.rotatingDreieck[i].y, currentLevel.rotatingDreieck[i].size / 10 /*currentLevel.rotatingDreieck[i].size*/ ,
            time / (currentLevel.rotatingDreieck[i].timeFor360GradRotation) * Math.PI + currentLevel.rotatingDreieck[i].angle /*currentLevel.rotatingDreieck[i].angle*/ , "black", "black", i); //360 every 2 second
      }
      // scale path
      //  drawPath_V2(rectangle, 125, 125, scale, time / 2000 * Math.PI, "black"); //360 every 4 second

      canvas.setTransform(1, 0, 0, 1, 0, 0);
      //  requestAnimationFrame(renderLoop);
      // bullets animation
      if (currentLevel.cannons) {
        for (var cannon of currentLevel.cannons) {
          canvas.fillStyle = "black";
          canvas.fillRect(cannon.x, cannon.y, cannon.width, cannon.height);
          cannon.timeGone += 16;
          if (cannon.timeGone == 16 || cannon.timeGone >= cannon.speed) {
            cannon.timeGone = 1;
            bullets.push({speed: cannon.bulletSpeed, x: cannon.x + 1*Math.abs(cannon.direction.y), y: cannon.y + 1*Math.abs(cannon.direction.x), width: cannon.width - 2*Math.abs(cannon.direction.y), height: cannon.height - 2*Math.abs(cannon.direction.x), direction: cannon.direction});
          }
        }
      }
      for (var bullet of bullets) {
        canvas.fillStyle = "black";
        bullet.x += bullet.speed*bullet.direction.x;
        bullet.y += bullet.speed*bullet.direction.y;
        canvas.fillRect(bullet.x, bullet.y, bullet.width, bullet.height);
      }
      bullets = bullets.filter(b => b.x < window.innerWidth + 101 && b.y < textur.height && b.y >= -(b.height) && b.x >= -(b.width));
      if (currentLevel.cannons || currentLevel.rotatingDreieck) {
        requestAnimationFrame(renderLoop);
      }
    }
    function createPath(...points) {
      var cx = 0;
      cy = 0;
      for (const p of points) {
        cx += p.x;
        cy += p.y;
      }
      cx /= points.length;
      cy /= points.length;

      const path = new Path2D;
      for (const p of points) {
        path.lineTo(p.x - cx, p.y - cy);
      }
      path.closePath();
      return path;
    }

    function rotatingWall(rotate) {
      //if (!(currentLevel == undefined || currentLevel.rotatingWall == undefined || currentLevel.rotatingWall[0].angle == undefined) && !(level[level.mode].levelType == "editHistory")) Layout();
      if (offline == true && ["vorgefertigt", "easyMaps"].includes(level[level.mode].levelType)) level[level.mode].rotatingNow = "rotatingWall";
  //    if (["vorgefertigt", "easyMaps"].includes(level[level.mode].levelType)) {rotate = true;Layout();}
      for (var i = 0; !(currentLevel == undefined || currentLevel.rotatingWall == undefined || currentLevel.rotatingWall[0].angle == undefined) && i < level[level.mode][level[level.mode].levelType][
          level[level.mode].number
        ].rotatingWall.length; i++) {
        canvas.save();
        canvas.translate(currentLevel.rotatingWall[i].x, currentLevel.rotatingWall[i].y);
        canvas.rotate(currentLevel.rotatingWall[i].angle * Math.PI / 180)
        canvas.fillStyle = "black";
        canvas.fillRect(-(currentLevel.rotatingWall[i].width / 2), -(currentLevel.rotatingWall[i].height / 2), currentLevel.rotatingWall[i].width, currentLevel
          .rotatingWall[i].height);
        canvas.restore();
        if (!(level[level.mode].levelType == "editHistory") && level[level.mode].rotating.rotatingWall == true) currentLevel.rotatingWall[i].angle++;
        if (!["vorgefertigt", "easyMaps"].includes(level[level.mode].levelType) && level[level.mode].rotating.rotatingWall == true && i == currentLevel.rotatingWall.length - 1) level[level.mode].rotating.rotatingWall = false;
      }
    }

    function boundingBoxCheck() {
      if (x1 < 0) {
        x1 = 0;
        vx1 = -vx1;
      }
      if (y1 < 0) {
        y1 = 0;
        vy1 = -vy1;
      }
      if (x1 > textur.width - JSON.parse(sphere1.style.width.toString().split('px')[0]) / 2) {
        x1 = textur.width - JSON.parse(sphere1.style.width.toString().split('px')[0]) / 2;
        vx1 = -vx1;
      }
      if (y1 > textur.height - JSON.parse(sphere1.style.height.toString().split('px')[0]) / 2) {
        y1 = textur.height - JSON.parse(sphere1.style.height.toString().split('px')[0]) / 2;
        vy1 = -vy1;
      }
      if (x2 < 0) {
        x2 = 0;
        vx2 = -vx2;
      }
      if (y2 < 0) {
        y2 = 0;
        vy2 = -vy2;
      }
      if (x2 > textur.width - JSON.parse(sphere1.style.width.toString().split('px')[0]) / 2) {
        x2 = textur.width - JSON.parse(sphere1.style.width.toString().split('px')[0]) / 2;
        vx2 = -vx2;
      }
      if (y2 > textur.height - JSON.parse(sphere1.style.height.toString().split('px')[0]) / 2) {
        y2 = textur.height - JSON.parse(sphere1.style.height.toString().split('px')[0]) / 2;
        vy2 = -vy2;
      }
    }

    function Layout() {
      if (["vorgefertigt", "easyMaps"].includes(level[level.mode].levelType)) {
        canvas.drawImage(Bild, 0, 0/*, window.innerWidth, AblageListe[5]*/);
        if (level[level.mode].vorgefertigt[level[level.mode].number].screenSizeDependent) canvas.drawImage(Bild, 0, 0, window.innerWidth, window.innerHeight);
      }
      //  if (level[level.mode].levelType == "editHistory"/* || level[level.mode].levelType == "editLevel" */|| level[level.mode].levelType == "worldWideLevel") {
      //    größeAnpassen();
      //}
      if (level[level.mode].rotatingNow != "rotatingWall") rotatingWall();
      if (!(currentLevel.blinkWall == undefined) && level[level.mode].rotating.blinkWall.includes(true)) blinkWall();
      // if (((level[level.mode].levelType == "editLevel" || level[level.mode].levelType == "editHistory" || level[level.mode].levelType == "worldWideLevel") && !(level[level.mode].rotatingNow == "rotatingWall") || (((level[level.mode].levelType == "editLevel" || level[level.mode].levelType == "editHistory" || level[level.mode].levelType == "worldWideLevel") && !(level[level.mode].rotatingNow == "rotatingDreieck")))) || level[level.mode].rotatingNow == "rotatingWall") rotating();
      // if (!(level[level.mode].rotating.blinkWall == undefined) && level[level.mode].rotating.blinkWall.includes(true)) blinkWall();
      //if (level[level.mode].levelType == "editHistory"/* || level[level.mode].levelType == "editLevel" */|| level[level.mode].levelType == "worldWideLevel") level[level.mode][level[level.mode].levelType] = JSON.parse(JSON.stringify(AblageListe[1]));
    }
    // stopWatch:
    var time = 0;
    var running = 0;

    function startPause() {
      if (running == 0) {
        running = 1;
        time = 0;
        increment();
      } else {
        running = 0;
      }
    }

    function reset() {
      running = 0;
      timer = 0;
    }

    function increment() {
      if (running == 1) {
        setTimeout(function() {
          time++;
          mins = Math.floor(time / 10 / 60);
          secs = Math.floor(time / 10);
          secs -= 60 * mins;
          tenths = time % 10;
          if (mins < 10) {
            mins = "0" + mins
          }
          if (secs < 10) {
            secs = "0" + secs;
          }
          increment();
        }, 100);
      }
    }

    function select(type) {
      level[level.mode].rotatingNow = type;
      document.getElementById(level[level.mode].editLevel.selected[0]).style.background = "";
      if (level[level.mode].editHistory.length == 0) level[level.mode].editLevel.selected = [type, 0];
      else if (level[level.mode].editHistory[level[level.mode].stepOfHistory][level[level.mode].editLevel.selected[0]] == undefined) level[level.mode].editLevel.selected = [type, 0];
      else level[level.mode].editLevel.selected = [type, level[level.mode].editHistory[level[level.mode].stepOfHistory][level[level.mode].editLevel.selected[0]].length - 1];
      document.getElementById(type).style.background = "blue";
    }
    // document.getElementById('blinkWall').style.display = "none";
    // document.getElementById('rotatingWall').style.display = "none";
    // document.getElementById('rotatingDreieck').style.display = "none";
    // level[level.mode].editLevel.selected = [];

    function activateBlinkWall() {
      level[level.mode].blinkWall = true;
      for (var i = 0; !(currentLevel.blinkWall == undefined) && i < currentLevel.blinkWall.length; i++) {
        blinkWallFunction(i);
      }
    }

    function blinkWallFunction(i) {
      setTimeout(function() {
        level[level.mode].rotating.blinkWall[i] = true;
        if (level[level.mode].levelType == "worldWideLevel") Layout();
        setTimeout(function() {
          level[level.mode].rotating.blinkWall[i] = false;
          if (level[level.mode].levelType == "worldWideLevel") Layout();
          if (level[level.mode].levelType == "editLevel" || level[level.mode].levelType == "worldWideLevel" && level[level.mode].blinkWall == true) blinkWallFunction(i);
        }, currentLevel.blinkWall[i].timeVisible);
      }, currentLevel.blinkWall[i].timeInvisible);
    }

    if (gerät == "PC") alert("please click to place a joy-stick!"); joyStick = "place";
    function canvasClicked() {
      if (/*joyStick == "place" && */gerät == "PC") {
        joyStick = {coordinates : {x: mausx, y: mausy}};
      }
      if (level[level.mode].levelType == "editHistory") {
        AblageListe[0] = [];
        AblageListe[0][0] = [];
        AblageListe[0][1] = [];
        AblageListe[0][2] = [];
        AblageListe[0][3] = [];
        AblageListe[0][4] = [];

        AblageListe[0][5] = ["rotatingWall", "rotatingDreieck", "blinkWall", "bullet"];
        for (var i = 0; level[level.mode].stepOfHistory > -1 && i < Object.keys(level[level.mode].editHistory[level[level.mode].stepOfHistory]).length; i++) {
          for (var i1 = 0; (AblageListe[0][5].includes(Object.keys(level[level.mode]["editHistory"][level[level.mode].stepOfHistory])[i]) && i1 < level[level.mode].editHistory[level[level.mode].stepOfHistory][Object.keys(level[level.mode].editHistory[level[level.mode].stepOfHistory])[i]].length); i1++) {
            if (Object.keys(level[level.mode].editHistory[level[level.mode].stepOfHistory])[i] == "picture") i1 = level[level.mode].editHistory[level[level.mode].stepOfHistory][Object.keys(level[level.mode].editHistory[level[level.mode].stepOfHistory])[i]].length;
            else {
              AblageListe[0][0].push(level[level.mode].editHistory[level[level.mode].stepOfHistory][Object.keys(level[level.mode].editHistory[level[level.mode].stepOfHistory])[i]][i1].x);
              AblageListe[0][1].push(level[level.mode].editHistory[level[level.mode].stepOfHistory][Object.keys(level[level.mode].editHistory[level[level.mode].stepOfHistory])[i]][i1].y);
              AblageListe[0][2].push(level[level.mode].editHistory[level[level.mode].stepOfHistory][Object.keys(level[level.mode].editHistory[level[level.mode].stepOfHistory])[i]][i1].width);
              AblageListe[0][3].push(level[level.mode].editHistory[level[level.mode].stepOfHistory][Object.keys(level[level.mode].editHistory[level[level.mode].stepOfHistory])[i]][i1].hight);
              AblageListe[0][4].push([i, i1]);
            }
          }
        }
        for (var i = 0; i < AblageListe[0][0].length; i++) {
          if ((AblageListe[0][0][i] - mausx < 55 && AblageListe[0][0][i] - mausx > -55) && (AblageListe[0][1][i] - mausy < 55 && AblageListe[0][1][i] - mausy > -55)) {
            console.log(AblageListe[0][4][i])
            console.log(level[level.mode].editHistory[level[level.mode].stepOfHistory][Object.keys(level[level.mode].editHistory[level[level.mode].stepOfHistory])[AblageListe[0][4][i][0]]]
              [AblageListe[0][4][i][1]]);
            AblageListe[0][0] = i;
            i = AblageListe[0][1].length + 1;
          }
        }
        if (i == AblageListe[0][1].length + 2 && AblageListe[6] == true) {
          document.getElementById(level[level.mode].editLevel.selected[0]).style.background = "";
          level[level.mode].editLevel.selected[0] = Object.keys(level[level.mode].editHistory[level[level.mode].stepOfHistory])[AblageListe[0][4][AblageListe[0][0]][0]]; //[AblageListe[0][0]];
          level[level.mode].editLevel.selected[1] = [AblageListe[0][4][AblageListe[0][0]][1]];
          document.getElementById(level[level.mode].editLevel.selected[0]).style.background = "blue";
          Layout();
          visibilityEditStuff();
          for (var i = 0; i < Object.keys(level[level.mode].editHistory[level[level.mode].stepOfHistory][level[level.mode].editLevel.selected[0]][level[level.mode].editLevel.selected[1]]).length; i++) {
            if (Object.keys(level[level.mode].editHistory[level[level.mode].stepOfHistory][level[level.mode].editLevel.selected[0]][level[level.mode].editLevel.selected[1]])[i] == "width" || Object.keys(level[level.mode].editHistory[level[level.mode].stepOfHistory][level[level.mode].editLevel.selected[0]][level[level.mode].editLevel.selected[1]])[
                i] == "height" || Object.keys(level[level.mode].editHistory[level[level.mode].stepOfHistory][level[level.mode].editLevel.selected[0]][level[level.mode].editLevel.selected[1]])[i] == "size") document.getElementById("slider" + capitalizeFirstLetter(Object.keys(level[level.mode].editHistory[
              level[level.mode].stepOfHistory][level[level.mode].editLevel.selected[0]][level[level.mode].editLevel.selected[1]])[i])).value = level[level.mode].editHistory[level[level.mode].stepOfHistory][level[level.mode].editLevel.selected[0]][level[level.mode].editLevel.selected[1]][Object.keys(level[level.mode].editHistory[level[level.mode].stepOfHistory]
              [level[level.mode].editLevel.selected[0]][level[level.mode].editLevel.selected[1]])[i]];
            else if (!(document.getElementById(Object.keys(level[level.mode].editHistory[level[level.mode].stepOfHistory][level[level.mode].editLevel.selected[0]][level[level.mode].editLevel.selected[1]])[i]) == undefined))
              document.getElementById(Object.keys(level[level.mode].editHistory[level[level.mode].stepOfHistory][level[level.mode].editLevel.selected[0]][level[level.mode].editLevel.selected[1]])[i]).value = level[level.mode].editHistory[level[level.mode].stepOfHistory][level[level.mode].editLevel.selected[0]][level[level.mode].editLevel.selected[
                1]][Object.keys(level[level.mode].editHistory[level[level.mode].stepOfHistory][level[level.mode].editLevel.selected[0]][level[level.mode].editLevel.selected[1]])[i]];
          }
        } else {
          console.log("createElement");
          //  level[level.mode].stepOfHistory++;
          if (level[level.mode].editHistory.length > 0) {
            level[level.mode].editHistory.push(JSON.parse(JSON.stringify(level[level.mode].editHistory[level[level.mode].stepOfHistory])));
          } else {
            level[level.mode].editHistory.push({});
          }
          if (level[level.mode].editHistory.length == 1) level.normal.editHistory.unshift([]);
          level[level.mode].stepOfHistory = level[level.mode].editHistory.length - 1;
          level[level.mode].number = level[level.mode].stepOfHistory;
          if (level[level.mode].editHistory[level[level.mode].editHistory.length - 1][level[level.mode].editLevel.selected[0]] == undefined) level[level.mode].editHistory[level[level.mode].editHistory.length - 1][level[level.mode].editLevel.selected[0]] = [];
          level[level.mode].editHistory[level[level.mode].editHistory.length - 1][level[level.mode].editLevel.selected[0]].push({
            x: mausx,
            y: mausy /* - 17 - scrollY*/ ,
            angle: 0
          })
    //      level[level.mode].editHistory[level[level.mode].editHistory.length - 1].spawnPoint = {x: 10, y: 255};
          level[level.mode].editHistory/*[level[level.mode].editHistory.length - 1]*/.sensibility = 5;
          document.getElementById('angle').style.display = "inline";
          visibilityEditStuff();
          if (level[level.mode].editLevel.selected[0] == "rotatingWall") level[level.mode].editHistory[level[level.mode].editHistory.length - 1][level[level.mode].editLevel.selected[0]][level[level.mode].editHistory[level[level.mode].editHistory.length - 1][level[level.mode].editLevel.selected[0]].length - 1]["timeFor360GradRotation"] = 3000;
          if (level[level.mode].editLevel.selected[0] == "blinkWall") {
            //    visible([['timeVisible', "inline"], ['timeInvisible', "inline"]]);
            level[level.mode].editHistory[level[level.mode].editHistory.length - 1][level[level.mode].editLevel.selected[0]][level[level.mode].editHistory[level[level.mode].editHistory.length - 1][level[level.mode].editLevel.selected[0]].length - 1]["timeVisible"] = document.getElementById('timeVisible').value;
            level[level.mode].editHistory[level[level.mode].editHistory.length - 1][level[level.mode].editLevel.selected[0]][level[level.mode].editHistory[level[level.mode].editHistory.length - 1][level[level.mode].editLevel.selected[0]].length - 1]["timeInvisible"] = document.getElementById('timeInvisible').value;
          }
          //  else visible([['timeVisible', "none"], ['timeInvisible', "none"]]);
          if (!(level[level.mode].editLevel.selected[0] == "rotatingDreieck")) {
            level[level.mode].editHistory[level[level.mode].editHistory.length - 1][level[level.mode].editLevel.selected[0]][level[level.mode].editHistory[level[level.mode].editHistory.length - 1][level[level.mode].editLevel.selected[0]].length - 1]["width"] = document.getElementById('sliderWidth').value;
            level[level.mode].editHistory[level[level.mode].editHistory.length - 1][level[level.mode].editLevel.selected[0]][level[level.mode].editHistory[level[level.mode].editHistory.length - 1][level[level.mode].editLevel.selected[0]].length - 1]["height"] = document.getElementById('sliderHeight').value;
            //    visible([['sliderSize', "none"], ['timeFor360GradRotation', "none"], ['sliderWidth', "inline"], ['sliderHeight', "inline"]])
            // document.getElementById('sliderSize').style.display = "none";
            // document.getElementById('timeFor360GradRotation').style.display = "none";
            // document.getElementById('sliderWidth').style.display = "inline";
            // document.getElementById('sliderHeight').style.display = "inline";
          } else {
            level[level.mode].editHistory[level[level.mode].editHistory.length - 1][level[level.mode].editLevel.selected[0]][level[level.mode].editHistory[level[level.mode].editHistory.length - 1][level[level.mode].editLevel.selected[0]].length - 1]["size"] = document.getElementById('sliderSize').value;
            level[level.mode].editHistory[level[level.mode].editHistory.length - 1][level[level.mode].editLevel.selected[0]][level[level.mode].editHistory[level[level.mode].editHistory.length - 1][level[level.mode].editLevel.selected[0]].length - 1]["timeFor360GradRotation"] = document.getElementById(
              'timeFor360GradRotation').value;
            //    visible([["sliderSize", "inline"], ['sliderWidth', "none"], ['sliderHeight', "none"], ['timeFor360GradRotation', "inline"]]);
            // document.getElementById('sliderSize').style.display = "inline";
            // document.getElementById('sliderWidth').style.display = "none";
            // document.getElementById('sliderHeight').style.display = "none";
            // document.getElementById('timeFor360GradRotation').style.display = "inline";
          }
          if (level[level.mode].editLevel.selected[0] == "blinkWall") {
            document.getElementById('angle').style.display = "none";
          }
          //  else document.getElementById('angle').style.display = "inline";
          level[level.mode].editLevel.selected[1] = level[level.mode].editHistory[level[level.mode].editHistory.length - 1][level[level.mode].editLevel.selected[0]].length - 1;
          Layout();
        }
      }
      for (var i = level[level.mode].editHistory.length - 1; level[level.mode].editHistory[i] != undefined && Object.keys(level[level.mode].editHistory[i]).length == 0; i--) {
        level[level.mode].editHistory.pop();
      }
    }

    function readMouseMove(e) {
      mausx = e.clientX + scrollX;
      mausy = e.clientY + scrollY;
      //  console.log(mausx + " - " + mausy);
    }
    document.onmousemove = readMouseMove

    var f = function() {
      var eventHandler = function(event) {
        //  console.log(window.scrollX + " - " + window.scrollY);
        console.log("scroll - " + scrollY);
      };
      window.addEventListener('scroll', eventHandler, false)
    };
    window.addEventListener('DOMContentLoaded', f, false)

    function visible(list) {
      for (var i = 0; i < list.length; i++) {
        document.getElementById(list[i][0]).style.display = list[i][1];
      }
    }
    AblageListe[3] = false;

    function capitalizeFirstLetter(string) {
      return string.charAt(0).toUpperCase() + string.slice(1);
    }

    document.addEventListener('touchmove', touch);
    document.addEventListener('touchstart', touch);
    document.addEventListener('touchend', touch);
    var joyStick;
  function touch(ev) {
    if (joyStickPlay.checked && ev.type == "touchend" && joyStick.coordinates) {
      //textur.style.touchAction = '';
      mausx = joyStick.coordinates.x;
      mausy = joyStick.coordinates.y;
    }
    if (ev.touches[0] != undefined) {
        mausx = ev.touches[0]["pageX"]// + scrollX;
        mausy = ev.touches[0]["pageY"]// + scrollY;
      }
    if (joyStickPlay.checked && ev.type == "touchstart" && mausy < textur.getBoundingClientRect().bottom) {
      joyStick = {coordinates : {x: mausx, y: mausy}};
      // if (!ev.touches[1]) textur.style.touchAction = 'none';
      // else textur.style.touchAction = '';
    }
  }
  function cssToNumber(string) {
    return JSON.parse(string.toString().split("px")[0]);
  }
  // cannon
var bullets = [];

  </script>
</body>

</html>
