<div id="settings">
<input type="text" value="3" id="width" placeholder="width">
<br>
<input type="text" value="2" id="height" placeholder="height">
<br>
vertausche <input type="text" value="3" id="anzahlVertauschen"> mal
auf Ablage <input type="text" value="3" id="anzahlLöschen">
<button type="button" onclick="createPackage();" name="button">createPackages</button>
</div>
<canvas id="textur" width="1848" onmousedown="mousedownOnCanvas();" onmouseup="mouseUpOnCanvas();" height="700"></canvas>
<script>
  var packages = [];
  var storage = [];
  function createPackage() {
    gebrauchteZuege = 0;
    settings.style.display = "none";
    var number = 1;
    for (var i = 0; i < JSON.parse(width.value); i++) {
      number = i + 1;
      packages[i] = [];
      for (var i1 = 0; i1 < JSON.parse(height.value); i1++) {
        packages[i][i1] = [];
        for (var i2 = 0; i2 < 3; i2++) {
          packages[i][i1][i2] = number;
          number += JSON.parse(width.value);
        }
      }
    }
    // vertausche
    // for (var i = 0; i < JSON.parse(anzahlVertauschen.value); i++) {
    //   var randomNumbers = [{x: Math.round(Math.random() *(packages.length - 1)), y: Math.round(Math.random() *(packages[0].length - 1)), höhe: Math.round(Math.random() *(packages[0][0].length - 1))}, {x: Math.round(Math.random() *(packages.length - 1)), y: Math.round(Math.random() *(packages[0].length - 1)), höhe: Math.round(Math.random() *(packages[0][0].length - 1))}];
    //   var ablage = JSON.parse(JSON.stringify(packages[randomNumbers[0].x][randomNumbers[0].y][randomNumbers[0].höhe]));
    //   //packages[Math.round(Math.random() *(packages.length))][Math.round(Math.random() *(packages[0].length))][Math.round(Math.random() *(packages[0][0].length))]packages[randomNumbers[1].x][randomNumbers[1].y][randomNumbers[1].höhe] = ablage;
    //   packages[randomNumbers[0].x][randomNumbers[0].y][randomNumbers[0].höhe] = JSON.parse(JSON.stringify(packages[randomNumbers[1].x][randomNumbers[1].y][randomNumbers[1].höhe]));
    //   packages[randomNumbers[1].x][randomNumbers[1].y][randomNumbers[1].höhe] = JSON.parse(JSON.stringify(ablage));
    // }
    // Idee: auf Ablage statt löschen
    for (var i = 0; i < JSON.parse(anzahlLöschen.value); i++) {
      var randomNumbers = {x: Math.round(Math.random() *(packages.length - 1)), y: Math.round(Math.random() *(packages[0].length - 1)), höhe: Math.round(Math.random() *(packages[0][0].length - 1))};
      missingNumbers.push(JSON.parse(JSON.stringify(packages[randomNumbers.x][randomNumbers.y][randomNumbers.höhe])))
      packages[randomNumbers.x][randomNumbers.y].splice(randomNumbers.höhe, 1);
    }
    layoutAll();
  }
  var canvas = textur.getContext('2d');
  function layoutAll() {
    // canvas.fillStyle = "black";
    // canvas.fillRect(0, 0, textur.width, textur.height);
    var Bild = new Image();
    Bild.src = "https://adi.nicolaiweitkemper.de/Bilder/space.jpeg";
    canvas.drawImage(Bild, 0, 0, textur.width, textur.height);
    layout(packages, 0);
    layout(storage, 10 + 60*JSON.parse(width.value) + 33);
  }
  function layout(type, position) {
    canvas.fillStyle = "gray";
    canvas.fillRect(0 + position, i1*60*3, JSON.parse(width.value)*60, 10);
    canvas.fillStyle = "gray";
    canvas.fillRect(0 + position, 0, 10, 10 + JSON.parse(height.value)*60*3);
    for (var i = 0; i < JSON.parse(width.value); i++) {
      canvas.fillStyle = "gray";
      canvas.fillRect(60*(i + 1) + position, 0, 10, 10 + JSON.parse(height.value)*60*3);
      if (!type[i]) type[i] = [];
      for (var i1 = 0; i1 < JSON.parse(height.value); i1++) {
        if (!type[i][i1]) type[i][i1] = [];
        for (var i2 = 0; i2 < 3; i2++) {
          drawPackage(10 + i*60 + position, 10 + i1*60*3 + 60*i2, position, type, true, i, i1, i2);
        }
      }
    }
    canvas.fillStyle = "gray";
    canvas.fillRect(0 + position, i1*60*3, JSON.parse(width.value)*60, 10);
  }
  function drawPackage(x, y, startX, type, grayIncluded, i, i1, i2) {
    canvas.fillStyle = "gray";
    if (grayIncluded) canvas.fillRect(0 + startX, i1*60*3, JSON.parse(width.value)*60, 10);
    canvas.fillStyle = "orange";
    if (type[i][i1][i2] == undefined) {
      // canvas.fillStyle = "black";
      var Bild = new Image();
      Bild.src = "https://adi.nicolaiweitkemper.de/Bilder/space.jpeg";
      canvas.drawImage(Bild, x, y, 50, 70, x, y, 50, 70);
    }
    else canvas.fillRect(x, y, 50, 50);
    canvas.fillStyle = "white";
    canvas.font = "32px Georgia";
    if (!(type[i][i1][i2] == undefined)) canvas.fillText(type[i][i1][i2], x + 32/2, y + 30);
  }
  var selected = {x: 0, y: 0, height: 0}
  var selectedStore = {};
  function mousedownOnCanvas() {
    if (!selected.grabbing || (clickCheck() && ((clickCheck().type == "sorting" && packages[clickCheck().x][clickCheck().y][clickCheck().height] != undefined) || (clickCheck().type != "sorting" && storage[clickCheck().x][clickCheck().y][clickCheck().height] != undefined)))) {
    selected = {x: 0, y: 0, height: 0, selecting: true};
    if (clickCheck()) {selected = clickCheck(); selected.beginningHeight = clickCheck().height;}
  }
  else {
    // canvas.fillStyle = "blue";
    // canvas.fillRect(mausx + 30, mausy + 30, 10, 10);
    if (clickCheck(mausx + 30, mausy + 30) && clickCheck(mausx + 30, mausy + 30).type == "Ablage") {
      if (selected.type == "sorting") movePackages(storage, "storage", packages);
      else movePackages(storage, "storage", storage);
    }
    if (clickCheck(mausx + 30, mausy + 30) && clickCheck(mausx + 30, mausy + 30).type == "sorting") {
      if (selected.type == "sorting") movePackages(packages, "packages", packages);
      else movePackages(packages, "packages", storage);
    }
    }
  }
  function movePackages(type, typeString, typeAt) {
    console.log("in Zwischenlager");
    console.log(clickCheck(mausx + 30, mausy + 30));
    var enoughSpace = true;
    for (var i = clickCheck(mausx + 30, mausy + 30).height; i < /*3*/(selected.height - selected.beginningHeight + 1); i++) {
      if (type[clickCheck(mausx + 30, mausy + 30).x][clickCheck(mausx + 30, mausy + 30).y][i] != undefined) enoughSpace = false;
    }
    if (typeString == "packages") {
      for (var i = selected.beginningHeight; i < selected.height + 1; i++) {
        if (packages[clickCheck(mausx + 30, mausy + 30).x][clickCheck(mausx + 30, mausy + 30).y][clickCheck(mausx + 30, mausy + 30).height + i] != undefined) enoughSpace = false;
      }
    }
    if (enoughSpace) console.log("enoughSpace");
    var atTop = true;
    for (var i = clickCheck(mausx + 30, mausy + 30).height - (selected.height - selected.beginningHeight + 1); i < clickCheck(mausx + 30, mausy + 30).height; i++) {
      if (i > -1 && type[clickCheck(mausx + 30, mausy + 30).x][clickCheck(mausx + 30, mausy + 30).y][i] == undefined) atTop = false;
    }
    if (atTop) console.log("atTop");
    if (atTop && enoughSpace) {
      console.log("lockBox");
      gebrauchteZuege++;
      for (var i = clickCheck(mausx + 30, mausy + 30).height; i < (selected.height - selected.beginningHeight + 1) + clickCheck(mausx + 30, mausy + 30).height; i++) {
        type[clickCheck(mausx + 30, mausy + 30).x][clickCheck(mausx + 30, mausy + 30).y][/*clickCheck(mausx + 30, mausy + 30).height*/ + i/* - (selected.height - selected.beginningHeight)*/] = JSON.parse(JSON.stringify(typeAt[selected.x][selected.y][selected.beginningHeight + (i - clickCheck(mausx + 30, mausy + 30).height)/* - (3 - (selected.height - selected.beginningHeight + 1))*//* - (selected.height - selected.beginningHeight)*/]));
      }
      typeAt[selected.x][selected.y].splice(selected.beginningHeight, (selected.height - selected.beginningHeight + 1));
      selected = {x: 0, y: 0, height: 0, grabbing: false}
      selected.grabbing = false;
      finishedCheck();
    }
  }
  var missingNumbers = [];
  function finishedCheck() {
    var zahlAktuell = 1;
    var rightOrder = true;
    for (var i = 0; i < JSON.parse(width.value); i++) {
      zahlAktuell = i + 1;
      for (var i1 = 0; i1 < JSON.parse(height.value); i1++) {
        for (var i2 = 0; i2 < 3; i2++) {
          if (packages[i][i1][i2] != undefined && packages[i][i1][i2] != zahlAktuell && !(missingNumbers.includes(zahlAktuell))) rightOrder = false;
          zahlAktuell += JSON.parse(width.value);
        }
      }
    }
    if (rightOrder) console.log("rightOrder!!!");
  }
  function mouseUpOnCanvas() {
    if (selected.selecting) selected.grabbing = true;
    selected.selecting = false;
  }
  var mausx;
  var mausy;
  function readMouseMove(e) {
    mausx = e.clientX + scrollX;
    mausy = e.clientY + scrollY;
    if (selected.selecting) {
    if (clickCheck() && selected.selecting && (selected.x == clickCheck().x && selected.y == clickCheck().y && selected.height < clickCheck().height)) selected.height += (clickCheck().height - selected.height);
    layoutAll();
    var xDrauf = 0;
    if (selected.type == "Ablage") xDrauf = 60*JSON.parse(width.value) + 33 + 10;
    canvas.fillStyle = "rgba(255, 0, 0, 0.4)";
    canvas.fillRect(selected.x*60 + xDrauf, selected.y*60*3 + 60*selected.beginningHeight, 70, 50*(selected.height - selected.beginningHeight + 1) + 10*(selected.height - selected.beginningHeight + 1));
      // for (var i = 0; i < selected.height - selected.beginningHeight; i++) {
      //   drawPackage(selected.x, selected.y, i);
      // }
    }
    else {
      layoutAll();
      if (selected.type == "Ablage") var pPackages = JSON.parse(JSON.stringify(storage));
      else var pPackages = packages;
      for (var i = 0; i < selected.height - selected.beginningHeight + 1; i++) {
        drawPackage(mausx + 10, mausy + 10 + 60*(i), 0, pPackages, false, selected.x, selected.y, selected.beginningHeight + i);
      }
      canvas.fillStyle = "rgba(255, 0, 0, 0.4)";
      canvas.fillRect(mausx/*selected.x*60*/, mausy/*selected.y*60*3 + 60*selected.beginningHeight*/, 70, 50*(selected.height - selected.beginningHeight + 1) + 10*(selected.height - selected.beginningHeight + 1));
    }
  }
  document.onmousemove = readMouseMove
  var gebrauchteZuege = 0;
  function clickCheck(pMausx, pMausy) {
    if (!pMausx) pMausx = mausx;
    if (!pMausy) pMausy = mausy;
    for (var i = 0; i < JSON.parse(width.value); i++) {
      for (var i1 = 0; i1 < JSON.parse(height.value); i1++) {
        for (var i2 = 0; i2 < 3; i2++) {
          // canvas.fillRect(10 + i*60, 10 + i1*60*3 + 60*i2, 50, 50);
          if (pMausx > 10 + i*60 && pMausx < 10 + i*60 + 50 && pMausy > 10 + i1*60*3 + 60*i2 && pMausy < 10 + i1*60*3 + 60*i2 + 50) return {x: i, y: i1, height: i2, selecting: true, grabbing: false, type: "sorting"};
          if (pMausx > 10 + i*60 + 10 + 60*JSON.parse(width.value) + 33 && pMausx < 10 + i*60 + 50 + 10 + 60*JSON.parse(width.value) + 33 && pMausy > 10 + i1*60*3 + 60*i2 && pMausy < 10 + i1*60*3 + 60*i2 + 50) return {x: i, y: i1, height: i2, selecting: true, grabbing: false, type: "Ablage"};
        }
      }
    }
  }
</script>
