<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
<meta charset="utf-8">
<script src="https://adi.nicolaiweitkemper.de/Database/js.js"></script>
<button id="BAndereBenutzerAnzeigen" type="button" onclick="namenabfrage(prompt('Wie heißt die Person, nach der sie suchen?'));" name="button">highscores von anderen Spielern ansehen</button>
<select name="course" id="modeSelection" value="move" onchange="modeSelected(value);">
  <option value="normal">normal</option>
  <option value="items">items</option>
</select>
<button id="BNeueRunde" type="button" onclick="neueRunde()" name="button">Neue Runde</button>
<canvas id="textur" width="2570" height="888" style="touch-action: none"></canvas>
<script>
  if (navigator.userAgent.match(/Android/i) ||
    navigator.userAgent.match(/webOS/i) ||
    navigator.userAgent.match(/iPhone/i) ||
    navigator.userAgent.match(/iPad/i) ||
    navigator.userAgent.match(/iPod/i) ||
    navigator.userAgent.match(/BlackBerry/i) ||
    navigator.userAgent.match(/Windows Phone/i)
  ) {
    var gerät = "Handy"
    console.log("Handy");
  } else {
    var gerät = "PC"
    console.log("PC");
  }
  var textur = document.getElementById('textur');
  var canvas = textur.getContext('2d'); //Dimension
  var Bild;
  var AblageListe = [];
  var zählerListe = [];
  var spielfeld = [];
  var KoordinatenX = 145;
  var KoordinatenY = 110;
  var zählerListe = [];
  var mausx = 0;
  var mausy = 0;
  var mausxScroll = 0;
  var mausyScroll = 0;
  var zustände = [];
  var felderAuswahl = [];
  zustände[2] = "inRunde";
  var Endanimation;
  var scores = [0, 0];
  var zweitBesteScores = {normal: [0, 0], items: [0, 0]};
  var highscores = {normal: [0, 0], items: [0, 0,]};
  var name = prompt("Wie heißen sie? Diese Information ist nötig, um deine Highscores speichern zu können.");
  var namen = [];
  var mode = "normal";
  var items = {flash: {xp: {needs: 100, got: 0}}, exchanger: {xp: {needs: 77, got: 0}}, changer: {xp: {needs: 88, got: 0}}}
  var selectedItem = "flash";

  var alert = true;

  var diff;

  dbGet("von2Zu4", "highscores" + name, function(result) {
    if (result == "NOPE" == false) {
      highscores = JSON.parse(result);
    }
  });
  dbGet("von2Zu4", "zweitBesteScores" + name, function(result) {
    if (result == "NOPE" == false) {
      zweitBesteScores = JSON.parse(result);
    }
  });
  dbGet("von2Zu4", "namen" + name, function(result) {
    if (result == "NOPE" == false) {
      namen = result.toString().split(',');
    }
  });

  dbGet("von2Zu4", mode + " spielfeld " + name, function(result) {
    if (result == "NOPE" == false) {
      spielfeld = result.toString().split(';');
      zählerListe[0] = 0;
      spielfeld.pop();
      while (zählerListe[0] < 4) {
        spielfeld[zählerListe[0]] = spielfeld[zählerListe[0]].toString().split(',');
        zählerListe[0]++;
      }
    } else {
      zahlenKreieren();
    }
    spielfeldKreieren();
  });

  /*canvas.fillStyle = "blue"
  canvas.beginPath();
  canvas.arc(110,110,99,0,Math.PI*2, false);
  canvas.fill();
  canvas.fillStyle = "red"
  canvas.beginPath();
  canvas.arc(110,110,90,0,Math.PI*2, false);
  canvas.fill();
  */

  if (gerät == "Handy") {
    $('head').append('<link rel="stylesheet" href="http://adi.nicolaiweitkemper.de/von2Zu4Handy.css" type="text/css" />');
  }

  function modeSelected(value) {
    mode = value;
    dbGet("von2Zu4", mode + " spielfeld " + name, function(result) {
      if (result == "NOPE") {
        neueRunde();
      }
      else {
        if (mode == "items") itemsAnzeigen(0);
        spielfeld = result.toString().split(';');
        zählerListe[0] = 0;
        spielfeld.pop();
        while (zählerListe[0] < 4) {
          spielfeld[zählerListe[0]] = spielfeld[zählerListe[0]].toString().split(',');
          zählerListe[0]++;
        }
        spielfeldKreieren();
      }
    });
    dbGet("von2Zu4", "items " + name, function(result) {
      if (result == "NOPE" == false) {
        items = JSON.parse(result);
      }
    });
  }

  function namenabfrage(name, included) {
    if (namen.includes(name)) included = true;
    namen[namen.length] = name;
    dbGet("von2Zu4", "highscores" + namen[namen.length - 1], function(result) {
      if (included == true || JSON.parse(result)[mode][0] == "NOPE" || JSON.parse(result)[mode][0] == "" || JSON.parse(result)[mode][0] == "null") {
        namen.pop();
        audio = new Audio("http://adi.nicolaiweitkemper.de/Sounds/windows%207%20trash.wav").play();
      }
      dbSet("von2Zu4", "namen" + name, namen);
      AblageListe[3] = 267 * namen.length
      document.getElementById('textur').height = 888 + 300 * namen.length + "";
      eigenenHighscoreAnzeigen();
      gespeicherteHighscoresAbfragen();
    });
  }

  function gespeicherteHighscoresAbfragen() {
    setTimeout(function() {
      zählerListe[0] = 0;
      AblageListe[3] = 0;
      if (namen.length > 0) {
        zustände[0] = "whileFunctionHighscoresAbfragen";
        whileFunctionHighscoresAbfragen();
      }
    }, 100);
  }

  function whileFunctionHighscoresAbfragen() {
    highscoresAndereSpieler(namen[zählerListe[0]]);
    //  setTimeout(function () {
    AblageListe[3] += 267;
    zählerListe[0]++;
    //  }, 550);
  }

  function highscoresAndereSpieler(nameAndererSpieler) {
    dbGet("von2Zu4", "highscores" + nameAndererSpieler, function(result) {

      canvas.font = "65px Georgia";
      if (JSON.parse(highscores[mode][0]) < JSON.parse(JSON.parse(result)[mode][0]) && JSON.parse(highscores[mode][1]) < JSON.parse(JSON.parse(result)[mode][1])) {
        canvas.fillStyle = "red";
      } else if (JSON.parse(highscores[mode][0]) > JSON.parse(JSON.parse(result)[mode][0]) && JSON.parse(highscores[mode][1]) > JSON.parse(JSON.parse(result)[mode][1])) {
        canvas.fillStyle = "green";
      } else {
        canvas.fillStyle = "black";
      }
      canvas.fillText("user: " + nameAndererSpieler, 30, 120 * 2 + AblageListe[3] - 120);
      //    canvas.fillText("×" + nameAndererSpieler, 0, 120*2 + AblageListe[3]  - 120);
      canvas.fillStyle = "blue";
      canvas.fillRect(280 + 40 * (nameAndererSpieler.length - 2), 120 * 2 + AblageListe[3] - 173 + 5, 70, 65);
      canvas.fillStyle = "black";
      canvas.fillRect(289 + 40 * (nameAndererSpieler.length - 2), 120 * 2 + AblageListe[3] - 173 + 10 + 5, 50, 45);
      canvas.font = "105px Georgia";
      canvas.fillStyle = "red";
      canvas.fillText("×", 285 + 40 * (nameAndererSpieler.length - 2), 120 * 2 + AblageListe[3] - 105 + 5);

      canvas.font = "50px Georgia";
      canvas.fillStyle = "black";
      canvas.fillText("Punkte insgesamt: ", 30, (130 + 40) * 2 - 50 + AblageListe[3] - 120);
      canvas.fillText("Höchste Punkte von 1 Stein: ", 30, (170 + 57) * 2 - 55 + AblageListe[3] - 120);
      canvas.font = "30px Georgia";
      if (JSON.parse(highscores[mode][0]) < JSON.parse(JSON.parse(result)[mode][0])) {
        canvas.fillStyle = "red";
      } else if (JSON.parse(highscores[mode][0]) > JSON.parse(JSON.parse(result)[mode][0])) {
        canvas.fillStyle = "green";
      } else {
        canvas.fillStyle = "black";
      }
      canvas.fillText("highscore: " + JSON.parse(JSON.parse(result)[mode][0]), 30, (145 + 40) * 2 - 48 + AblageListe[3] - 120);
      if (JSON.parse(highscores[mode][1]) < JSON.parse(JSON.parse(result)[mode][1])) {
        canvas.fillStyle = "red";
      } else if (JSON.parse(highscores[mode][1]) > JSON.parse(JSON.parse(result)[mode][1])) {
        canvas.fillStyle = "green";
      } else {
        canvas.fillStyle = "black";
      }
      canvas.fillText("highscore: " + JSON.parse(result)[mode][1], 30, (185 + 47) * 2 - 37 + AblageListe[3] - 120);
      dbGet("von2Zu4", "zweitBesteScores" + nameAndererSpieler, function(result) {
        canvas.fillStyle = "black";
        canvas.fillText("zweit bester Score: " + JSON.parse(result)[mode][0], 30, (160 + 40) * 2 - 47 + AblageListe[3] - 120);
        canvas.fillText("zweit bester Score: " + JSON.parse(result)[mode][1], 30, (195 + 50) * 2 - 35 + AblageListe[3] - 120);
        if (zustände[0] == "whileFunctionHighscoresAbfragen" && zählerListe[0] < namen.length) {
          whileFunctionHighscoresAbfragen();
        } else {
          zustände[0] = "beendet"
        }
      });
    });
  }

  function neueRunde() {
    canvas.fillStyle = "white";
    canvas.fillRect(0, 0, 5000, 5000);
    zustände[2] = "inRunde";
    zustände[0] = "beendet";
    felderAuswahl = [];
    document.getElementById('textur').style = "touch-action: none";
    zahlenKreieren();
    spielfeldKreieren();
    for (var i = 0; i < Object.keys(items).length; i++) {
      items[Object.keys(items)[i]].xp.got = 0;
    }
    if (mode == "items") itemsAnzeigen(0);
  }

  function spielfeldKreieren() {
    canvas.fillStyle = "white";
    canvas.fillRect(0, 0, textur.width, textur.height);
    zählerListe[0] = 0;
    zählerListe[1] = 0;
    KoordinatenX = 145;
    KoordinatenY = 110;
    while (KoordinatenY < 700) {
      if (felderAuswahl.includes(zählerListe[0] + " - " + zählerListe[1])) {
        canvas.fillStyle = "green";
      } else {
        canvas.fillStyle = "blue";
      }
      if (zählerListe[0] + " - " + zählerListe[1] == felderAuswahl[felderAuswahl.length - 1]) {
        canvas.fillStyle = "red"
      }

      canvas.beginPath();
      canvas.arc(KoordinatenX, KoordinatenY, 69, 0, Math.PI * 2, false);
      canvas.fill();
      canvas.fillStyle = "yellow"
      canvas.beginPath();
      canvas.arc(KoordinatenX, KoordinatenY, 60, 0, Math.PI * 2, false);
      canvas.fill();
      canvas.fillStyle = "black";
      if (zählerListe[0] + " - " + zählerListe[1] == felderAuswahl[felderAuswahl.length - 1] == false && (felderAuswahl.length == 2 && zustände[3] == "exchanger" && (!(zählerListe[0] + " - " + zählerListe[1] == felderAuswahl[0] || zählerListe[0] + " - " + zählerListe[1] == felderAuswahl[1])) || zustände[3] != "exchanger" || (felderAuswahl.length != 2 && zustände[3] == "exchanger"))) {
        spielfeld[zählerListe[0]][zählerListe[1]] += "";
        canvas.font = 105 - 15 * spielfeld[zählerListe[0]][zählerListe[1]].length + "px Georgia";
        KoordinatenX += 10;
        KoordinatenX -= 10 * spielfeld[zählerListe[0]][zählerListe[1]].length;
        canvas.fillText(spielfeld[zählerListe[0]][zählerListe[1]], KoordinatenX - 23, KoordinatenY + 23);
        KoordinatenX -= 10;
        KoordinatenX += 10 * spielfeld[zählerListe[0]][zählerListe[1]].length;
      } else if (zustände[3] != "exchanger"/* && zählerListe[0] + " - " + zählerListe[1] == felderAuswahl[felderAuswahl.length - 1]*/) {
        AblageListe[1] = "";
        AblageListe[1] += zustände[1] * felderAuswahl.length;
        canvas.font = 105 - 15 * AblageListe[1].length + "px Georgia";
        KoordinatenX += 10;
        KoordinatenX -= 10 * AblageListe[1].length;
        canvas.fillText(zustände[1] * felderAuswahl.length, KoordinatenX - 23, KoordinatenY + 23);
        KoordinatenX -= 10;
        KoordinatenX += 10 * AblageListe[1].length;
      }
      else {
        spielfeld[zählerListe[0]][zählerListe[1]] += "";
        canvas.font = 105 - 15 * spielfeld[zählerListe[0]][zählerListe[1]].length + "px Georgia";
        KoordinatenX += 10;
        KoordinatenX -= 10 * spielfeld[zählerListe[0]][zählerListe[1]].length;
        if (zählerListe[0] + " - " + zählerListe[1] == felderAuswahl[felderAuswahl.length - 1]) canvas.fillText(spielfeld[felderAuswahl[0].toString().split(' - ')[0]][felderAuswahl[0].toString().split(' - ')[1]], KoordinatenX - 23, KoordinatenY + 23);
        else canvas.fillText(spielfeld[felderAuswahl[1].toString().split(' - ')[0]][felderAuswahl[1].toString().split(' - ')[1]], KoordinatenX - 23, KoordinatenY + 23);
        KoordinatenX -= 10;
        KoordinatenX += 10 * spielfeld[zählerListe[0]][zählerListe[1]].length;
      }
      KoordinatenX += 170;
      if (KoordinatenX > 1500) {
        KoordinatenX = 145;
        KoordinatenY += 170;
        zählerListe[0]++;
        zählerListe[1] = -1;
      }
      zählerListe[1]++;
    }
    if (spielfeld[0].includes("empty")) {
      removeEmpty();
      spielfeldKreieren();
    }
    if (spielfeld[1].includes("empty")) {
      removeEmpty();
      spielfeldKreieren();
    }
    if (spielfeld[2].includes("empty")) {
      removeEmpty();
      spielfeldKreieren();
    }
    if (spielfeld[3].includes("empty")) {
      removeEmpty();
      spielfeldKreieren();
    }
    if (mode == "items") itemsAnzeigen(0);
  }

  function zahlenKreieren() {
    zählerListe[0] = 0;
    zählerListe[1] = 0;
    while (zählerListe[0] < 4) {
      spielfeld[zählerListe[0]] = [];
      while (zählerListe[1] < 8) {
        spielfeld[zählerListe[0]][zählerListe[1]] = Math.floor(Math.random() * 4);
        spielfeld[zählerListe[0]][zählerListe[1]]++;
        spielfeld[zählerListe[0]][zählerListe[1]] = spielfeld[zählerListe[0]][zählerListe[1]] * 2
        zählerListe[1]++;
      }
      zählerListe[1] = 0;
      zählerListe[0]++;
    }
  }

  function itemsAnzeigen(time) {
    for (var i = 0; i < Object.keys(items).length; i++) {
      var Bild = new Image();
          Bild.src = "https://adi.nicolaiweitkemper.de/Bilder/von%202%20zu%204/item" + (i + 1) + ".jpeg";
          canvas.drawImage(Bild, 145 + 170*i - 55, 790/* + 170*/ - 55, 120/* - 20*/ - 35 + 30, 120 - 17 - 3 + 20 - 35 +25);
          diff = ((100 / 100) * Math.PI*2*10).toFixed(2);
          canvas.lineWidth = 10;
          if (Object.keys(items)[i] == selectedItem || zustände[3] == Object.keys(items)[i])  canvas.strokeStyle = "red"; // colour for progress bar
          else canvas.strokeStyle = "yellow";
          canvas.beginPath();
          canvas.arc(145 + 170*i, 790/* + 170*/, 60, 4.72, diff/10+4.72, false);
          canvas.stroke();
          canvas.strokeStyle = "white";
          canvas.beginPath();
          canvas.arc(145 + 170*i, 790/* + 170*/, 76, 4.72, diff/10+4.72, false);
          canvas.stroke();
          canvas.beginPath();
          canvas.arc(145 + 170*i, 790/* + 170*/, 70, 4.72, diff/10+4.72, false);
          canvas.stroke();
      diff = ((/*al*/(items[Object.keys(items)[i]].xp.got/items[Object.keys(items)[i]].xp.needs*100) / 100) * Math.PI*2*10).toFixed(2);
      if (items[Object.keys(items)[i]].xp.got < items[Object.keys(items)[i]].xp.needs) {canvas.strokeStyle = "blue"; alert = true;} // colour for progress bar
      else {
        canvas.strokeStyle = "#40FF00";
        if (Object.keys(items)[i] == selectedItem) changeSelection();
    }
    if (zustände[3] != Object.keys(items)[i]) {
      canvas.beginPath();
      canvas.arc(145 + 170*i, 790/* + 170*/, 60, 4.72, diff/10+4.72, false);
      canvas.stroke();
    }
      // if (items[Object.keys(items)[i]].xp.got >= items[Object.keys(items)[i]].xp.needs) {
      //   canvas.strokeStyle = "#40FF00"; // colour for progress bar
      //   canvas.beginPath();
      //   canvas.arc(145 + 170*i, 790/* + 170*/, 60, 4.72, diff/10+4.72, false);
      //   canvas.stroke();
      // }
    }
    if (time < 5) {
      setTimeout(function () {
        itemsAnzeigen(time + 1);
      }, 500);
    }
  }

  var f = function() {
    var eventHandler = function(event) {
      console.log(window.scrollX + " - " + window.scrollY);
  //    if (zustände[2] == "inRunde" == false) {
        mausxScroll = window.scrollX;
        mausyScroll = window.scrollY;
    //  }
    };
    window.addEventListener('scroll', eventHandler, false)
    //    koordinatenSpieler1[6] = 0;

  };
  window.addEventListener('DOMContentLoaded', f, false)

  function readMouseMove(e) {
    mausx = e.clientX + mausxScroll;
    mausy = e.clientY + mausyScroll;
    //  console.log(e.clientX);
  //  if (gerät == "PC") {
      mousemoveFolgen();
  //  }
  }

  function mousemoveFolgen() {
    if (zustände[0] == "Auswahl" && zustände[2] == "inRunde") {
      klickpointCheck();
      if ((zählerListe[0] == 5 && felderAuswahl.includes(AblageListe[0]) == false && (spielfeld[AblageListe[0].toString().split(' - ')[0]][AblageListe[0].toString().split(' - ')[1]] == zustände[1] && zustände[3] != "exchanger") || (zustände[3] == "exchanger" && felderAuswahl.length < 2))) {
        if ((AblageListe[0].toString().split(' - ')[0] == JSON.parse(felderAuswahl[felderAuswahl.length - 1].toString().split(' - ')[0]) + 1 && AblageListe[0].toString().split(' - ')[1] == JSON.parse(felderAuswahl[felderAuswahl.length - 1].toString()
            .split(' - ')[1]) || AblageListe[0].toString().split(' - ')[0] == JSON.parse(felderAuswahl[felderAuswahl.length - 1].toString().split(' - ')[0]) - 1 && AblageListe[0].toString().split(' - ')[1] == JSON.parse(felderAuswahl[felderAuswahl.length -
            1].toString().split(' - ')[1]) || AblageListe[0].toString().split(' - ')[1] == JSON.parse(felderAuswahl[felderAuswahl.length - 1].toString().split(' - ')[1]) + 1 && AblageListe[0].toString().split(' - ')[0] == JSON.parse(felderAuswahl[
            felderAuswahl.length - 1].toString().split(' - ')[0]) || AblageListe[0].toString().split(' - ')[1] == JSON.parse(felderAuswahl[felderAuswahl.length - 1].toString().split(' - ')[1]) - 1 && AblageListe[0].toString().split(' - ')[0] == JSON
          .parse(felderAuswahl[felderAuswahl.length - 1].toString().split(' - ')[0]))) {

          felderAuswahl[felderAuswahl.length] = AblageListe[0];
          console.log(felderAuswahl);
        }
      }
      if (zählerListe[0] == 5 && spielfeld[AblageListe[0].toString().split(' - ')[0]][AblageListe[0].toString().split(' - ')[1]] == zustände[1] && AblageListe[0] == felderAuswahl[felderAuswahl.length - 2]) {
        felderAuswahl.pop();
      }
      spielfeldKreieren();
    }
  }
  document.onmousemove = readMouseMove
  if (gerät == "Handy") {
    document.addEventListener('touchmove', touch);
    document.addEventListener('touchstart', touch);
  }

  function touch(ev) {
    mausx = ev.touches[0]["pageX"] + mausxScroll;
    mausy = ev.touches[0]["pageY"] + mausyScroll;
    if (ev.type == "touchstart") {
      klickpointCheck();
      if (felderAuswahl < 1) {
        zustände[0] = "beendet";
        mousedownFolgen();
      }
      if (felderAuswahl.length > 0 && AblageListe[0].toString().split(' - ')[0] == felderAuswahl[felderAuswahl.length - 1].toString().split(' - ')[0] == false || AblageListe[0].toString().split(' - ')[1] == felderAuswahl[felderAuswahl.length - 1].toString()
        .split(' - ')[1] == false) {
        zustände[0] = "beendet";
        mousedownFolgen();
      } else if (felderAuswahl.length > 0 && AblageListe[0].toString().split(' - ')[0] == felderAuswahl[felderAuswahl.length - 1].toString().split(' - ')[0] && AblageListe[0].toString().split(' - ')[1] == felderAuswahl[felderAuswahl.length - 1].toString()
        .split(' - ')[1]) {
        mousedownFolgen();
      }
    }
    if (ev.type == "touchmove") {
      mousemoveFolgen();
    }
  }


   window.addEventListener('mousedown', function() {
    if (gerät == "PC") {
      klickpointCheck();
      if (felderAuswahl < 1) {
        zustände[0] = "beendet";
        mousedownFolgen();
      }
      if (felderAuswahl.length > 0 && AblageListe[0].toString().split(' - ')[0] == felderAuswahl[felderAuswahl.length - 1].toString().split(' - ')[0] == false || AblageListe[0].toString().split(' - ')[1] == felderAuswahl[felderAuswahl.length - 1].toString()
        .split(' - ')[1] == false) {
        zustände[0] = "beendet";
        mousedownFolgen();
      } else if (felderAuswahl.length > 0 && AblageListe[0].toString().split(' - ')[0] == felderAuswahl[felderAuswahl.length - 1].toString().split(' - ')[0] && AblageListe[0].toString().split(' - ')[1] == felderAuswahl[felderAuswahl.length - 1].toString()
        .split(' - ')[1]) {
        mousedownFolgen();
      }
    }
  });

  function mousedownFolgen() {
    if (zustände[2] == "beendet" == false) {
      klickpointCheck();
      AblageListe[5] = "none";
      for (var i = 0; i < 8; i++) {
        if (mausx > 80 + 170 * i && mausx < 80 + 170 * i + 138 && mausy > 50 + 170 * 4 && mausy < 50 + 170 * 4 + 138) AblageListe[5] = i;
      }
       if (AblageListe[5] != "none" && !(items[Object.keys(items)[AblageListe[5]]].xp.got >= items[Object.keys(items)[AblageListe[5]]].xp.needs)) {
        selectedItem = Object.keys(items)[AblageListe[5]];
        itemsAnzeigen(0);
      }
      else if (AblageListe[5] != "none") {
        zustände[3] = Object.keys(items)[AblageListe[5]];
        itemsAnzeigen();
      }
      if (zählerListe[0] == 5) {
        if (zustände[0] == "Auswahl" == false) {
          zustände[0] = "Auswahl";
          felderAuswahl = [];
          felderAuswahl[0] = AblageListe[0];
          spielfeldKreieren();
        } else if (zustände[3] == "flash") {
        var audio = new Audio("https://adi.nicolaiweitkemper.de/Sounds/thunder-and-lightning-storm-sound-effects-with-flashes-youtubemp3free.org.mp3")
            audio.play();
             setTimeout(function () {
                audio.pause();
              }, 9000);
          zustände[3] = "beendet";
            items.flash.xp.got = 0
            spielfeld[AblageListe[0].toString().split(' - ')[0]][AblageListe[0].toString().split(' - ')[1]] = "empty";
            spielfeldKreieren();
        }
        else if (zustände[3] == "changer") {
          doChanger(prompt("Mit welcher Zahl wollen sie das Feld ersetzen? (bitte wählen sie zwischen 2,4 und 6)"));
        }
        else if (zustände[3] == "exchanger") {
          if (felderAuswahl.length == 2) {
            AblageListe[1] = spielfeld[felderAuswahl[0].toString().split(' - ')[0]][felderAuswahl[0].toString().split(' - ')[1]];
            // felderAuswahl[0] = felderAuswahl[1];
            // felderAuswahl[1] = AblageListe[1];
            spielfeld[felderAuswahl[0].toString().split(' - ')[0]][felderAuswahl[0].toString().split(' - ')[1]] = spielfeld[felderAuswahl[1].toString().split(' - ')[0]][felderAuswahl[1].toString().split(' - ')[1]];
            spielfeld[felderAuswahl[1].toString().split(' - ')[0]][felderAuswahl[1].toString().split(' - ')[1]] = AblageListe[1];
            felderAuswahl = [];
            zustände[3] = "beendet";
            items.exchanger.xp.got = 0;
            spielfeldKreieren();
            audio = new Audio("http://adi.nicolaiweitkemper.de/Sounds/appearance-sound-effects-all-sounds-youtubemp3free.org.mp3");
            audio.currentTime = 17;
            audio.play();
             setTimeout(function () {
              audio.pause();
            }, 1555);
          }
        }
        else {
          zählerListe[0] = 0;
          while (zählerListe[0] < felderAuswahl.length - 1) {
            spielfeld[felderAuswahl[zählerListe[0]].toString().split(' - ')[0]][felderAuswahl[zählerListe[0]].toString().split(' - ')[1]] = "empty";
            zählerListe[0]++;
          }
          if (mode == "items" &&  spielfeld[felderAuswahl[zählerListe[0]].toString().split(' - ')[0]][felderAuswahl[zählerListe[0]].toString().split(' - ')[1]] != zustände[1] * felderAuswahl.length) items[selectedItem].xp.got += zustände[1] * felderAuswahl.length;
          itemsAnzeigen(0);
          spielfeld[felderAuswahl[zählerListe[0]].toString().split(' - ')[0]][felderAuswahl[zählerListe[0]].toString().split(' - ')[1]] = zustände[1] * felderAuswahl.length;
          if (felderAuswahl.length > 1) {
          var audio = new Audio("http://adi.nicolaiweitkemper.de/Sounds/''PLOP''%20-%20Sound%20Effect%20(FREE).mp3")
              audio.play();
               setTimeout(function () {
                  audio.pause();
                }, 900);
              }
              spielfeldKreieren();
        }
        }
    } else {
      zählerListe[0] = 0;
      AblageListe[3] = 0;
      while (zählerListe[0] < namen.length) {
        if (mausx > 280 + 40 * (namen[zählerListe[0]].length - 2) && mausx < 280 + 40 * (namen[zählerListe[0]].length - 2) + 70 && mausy > 369 + AblageListe[3] && mausy < 369 + 65 + AblageListe[3]) {
          console.log("Löschen " + zählerListe[0]);
          namen.splice(zählerListe[0], 1);
          dbSet("von2Zu4", "namen" + name, namen);
          canvas.fillStyle = "white";
          canvas.fillRect(0, 337, 10000, 10000)
          gespeicherteHighscoresAbfragen();
          zählerListe[0] = namen.length;
          audio = new Audio("http://adi.nicolaiweitkemper.de/Sounds/windows%207%20trash.wav").play();
        }
        if (zählerListe[0] == namen.length == false) {
          AblageListe[3] += 267;
          zählerListe[0]++;
        }
      }
    }
  }

  function doChanger(number) {
    if (number == 2 || number == 4 || number == 6)  {
      items.changer.xp.got = 0;
      spielfeld[AblageListe[0].toString().split(' - ')[0]][AblageListe[0].toString().split(' - ')[1]] = number;
      felderAuswahl[felderAuswahl.length - 1] = number;
      spielfeldKreieren();
      zustände[3] = "beendet";
      var audio = new Audio("http://adi.nicolaiweitkemper.de/Sounds/''PLOP''%20-%20Sound%20Effect%20(FREE).mp3")
          audio.play();
           setTimeout(function () {
              audio.pause();
            }, 900);
    }
    else {
      alert("bitte eine Zahl innerhalb der angegebenen Parameter angeben!");
      setTimeout(function () {
        doChanger(prompt("Mit welcher Zahl wollen sie das Feld ersetzen? (bitte wählen sie zwischen 2,4 und 6)"));
      }, 2000);
    }
  }

  function changeSelection() {
    AblageListe[1] = selectedItem;
    for (var i = 0; i < Object.keys(items).length; i++) {
      if (items[Object.keys(items)[i]].xp.got < items[Object.keys(items)[i]].xp.needs) selectedItem = Object.keys(items)[i];
    }
    setTimeout(function () {
      if (AblageListe[1] == selectedItem && alert == true) {
        new Audio("http://adi.nicolaiweitkemper.de/Sounds/beendet%20sound.wav").play();
        alert = false;
      }
      else if (alert == true) {
        new Audio("https://adi.nicolaiweitkemper.de/Sounds/ding-sound-effect-youtubemp3free.org.mp3").play();
      }
    }, 1333);
  }

  function klickpointCheck() {
    zählerListe[0] = 0;
    zählerListe[1] = 0;
    while (zählerListe[0] < 4) {
      while (zählerListe[1] < 8) {
        if (mausx > 80 + 170 * zählerListe[1] && mausx < 80 + 170 * zählerListe[1] + 138 && mausy > 50 + 170 * zählerListe[0] && mausy < 50 + 170 * zählerListe[0] + 138) {
          //console.log(zählerListe[0] + " - " + zählerListe[1]);
          AblageListe[0] = zählerListe[0] + " - " + zählerListe[1]
          if (zustände[0] == "Auswahl" == false) {
            zustände[1] = spielfeld[zählerListe[0]][zählerListe[1]];
          }
          zählerListe[0] = 4;
        }
        zählerListe[1]++;
      }
      zählerListe[1] = 0;
      zählerListe[0]++;
    }
  }

  document.onkeydown = function(event) {
    if (event.keyCode == 46) {
      zustände[0] = "beendet";
      felderAuswahl = [];
      spielfeldKreieren();
    }

  };

  function removeEmpty() {
    zählerListe[0] = 3;
    zählerListe[1] = 7;
    while (zählerListe[0] > 0) {

      while (zählerListe[1] > -1) {
        if (spielfeld[zählerListe[0]][zählerListe[1]] == "empty") {
          if (zählerListe[0] > 0) {
            spielfeld[zählerListe[0]][zählerListe[1]] = spielfeld[zählerListe[0] - 1][zählerListe[1]]
            spielfeld[zählerListe[0] - 1][zählerListe[1]] = "empty";
          } else {
            spielfeld[zählerListe[0]][zählerListe[1]] = Math.floor(Math.random() * 4);

            spielfeld[zählerListe[0]][zählerListe[1]]++;
            spielfeld[zählerListe[0]][zählerListe[1]] *= 2;
          }

        }


        if (zählerListe[1] == 0 && zählerListe[0] == 0 == false) {
          zählerListe[0]--;
          zählerListe[1] = 9;
        }
        zählerListe[1]--;
      }
    }
    zustände[0] = "beendet";
    felderAuswahl = [];
    spielfeldKreieren();
    // SpielendeCheck

    zählerListe[0] = 0;
    zählerListe[1] = 0;
    while (zählerListe[0] < 4) {

      while (zählerListe[1] < 8) {
        if (zählerListe[0] == 5 == false && zählerListe[0] > 0 && spielfeld[zählerListe[0] - 1][zählerListe[1]] == spielfeld[zählerListe[0]][zählerListe[1]]) {
          zählerListe[0] = 5;
        }
        if (zählerListe[0] == 5 == false && zählerListe[0] < 3 && spielfeld[zählerListe[0] + 1][zählerListe[1]] == spielfeld[zählerListe[0]][zählerListe[1]]) {
          zählerListe[0] = 5;
        }
        if (zählerListe[0] == 5 == false && zählerListe[1] > 0 && spielfeld[zählerListe[0]][zählerListe[1]] == spielfeld[zählerListe[0]][zählerListe[1] - 1]) {
          zählerListe[0] = 5;
        }

        if (zählerListe[0] == 5 == false && zählerListe[1] < 7 && spielfeld[zählerListe[0]][zählerListe[1]] == spielfeld[zählerListe[0]][zählerListe[1] + 1]) {
          zählerListe[0] = 5;
        }
        zählerListe[1]++;
      }
      zählerListe[0]++;
      zählerListe[1] = 0;
    }
    if (zählerListe[0] < 5) {
      dbSet("von2Zu4", mode + " spielfeld " + name, "NOPE");
      dbSet("von2Zu4", "items " + name, "NOPE");
      zustände[2] = "beendet"
      zählerListe[0] = 0;
      zählerListe[1] = 0;
      AblageListe[2] = 69;
      zählerListe[2] = 0;
      KoordinatenX = 145;
      KoordinatenY = 110;
      new Audio("http://soundbible.com/mp3/flyby-Conor-1500306612.mp3").play();
      Endanimation = setInterval(endanimation, 0);
      console.log("beendet");
    } else {
      zuVarSpielfeld();
      dbSet("von2Zu4",mode + " spielfeld " + name, AblageListe[4]);
      dbSet("von2Zu4", "items " + name, JSON.stringify(items));
    }
  }

  function zuVarSpielfeld() {
    zählerListe[0] = 0;
    AblageListe[4] = "";
    while (zählerListe[0] < 4) {
      AblageListe[4] += spielfeld[zählerListe[0]]
      AblageListe[4] += ";"
      zählerListe[0]++;
    }
    console.log(AblageListe[4]);
  }

  function endanimation() {
  canvas.fillStyle = "white"
  canvas.fillRect(0, 0, 1800, 700)
  zählerListe[0] = 0;
  zählerListe[1] = 0;
  KoordinatenX = 145;
  KoordinatenY = 110;
  if (AblageListe[2] < 1) {
    clearInterval(Endanimation);
    zählerListe[0] = 0;
    zählerListe[1] = 0;
    AblageListe[2] = spielfeld[0] + "," + spielfeld[1] + "," + spielfeld[2] + "," + spielfeld[3]
    scores[0] = 0;
    while (JSON.parse(zählerListe[0]) < JSON.parse(AblageListe[2].toString().split(',').length)) {
      scores[0] += JSON.parse(AblageListe[2].toString().split(',')[zählerListe[0]])
      zählerListe[0]++;
    }
    if (JSON.parse(scores[0]) > JSON.parse(highscores[mode][0])) {
      zweitBesteScores[mode][0] = highscores[mode][0];
      highscores[mode][0] = scores[0];
      if (name == null == false && name == "" == false) {
        dbSet("von2Zu4", "highscores" + name, JSON.stringify(highscores));
        dbSet("von2Zu4", "zweitBesteScores" + name, JSON.stringify(zweitBesteScores));
          Bild = new Image();
          Bild.src = "http://adi.nicolaiweitkemper.de/Bilder/New%20best.png";
          canvas.drawImage(Bild, 277, 20, 437, 437);
          setTimeout(function () {
            canvas.drawImage(Bild, 277, 20, 437, 437);
          }, 300);
        audio = new Audio("http://soundbible.com/mp3/Ta Da-SoundBible.com-1884170640.mp3").play();
      }
    }
    zählerListe[0] = 0;
    AblageListe[2] = AblageListe[2].toString().split(',')
    while (zählerListe[0] < AblageListe[2].length) {
      if (AblageListe[2][zählerListe[0]].length == 1) {
        AblageListe[2][zählerListe[0]] = "0" + AblageListe[2][zählerListe[0]]
      }
      zählerListe[0]++;
    }
    zählerListe[0] = 0;
    while (zählerListe[0] < AblageListe[2].length) {
      if (AblageListe[2][zählerListe[0]].length == 2) {
        AblageListe[2][zählerListe[0]] = "0" + AblageListe[2][zählerListe[0]]
      }
      zählerListe[0]++;
    }
    AblageListe[2].sort();
    zählerListe[0] = 0;
    remove0();

    if (JSON.parse(AblageListe[2][AblageListe[2].length - 1]) > JSON.parse(highscores[mode][1])) {
      zweitBesteScores[mode][1] = highscores[mode][1];
      highscores[mode][1] = AblageListe[2][AblageListe[2].length - 1];
      if (name == null == false && name == "" == false) {
        dbSet("von2Zu4", "highscores" + name, JSON.stringify(highscores));
        dbSet("von2Zu4", "zweitBesteScores" + name, JSON.stringify(zweitBesteScores));
          Bild = new Image();
          Bild.src = "http://adi.nicolaiweitkemper.de/Bilder/New%20best.png";
          canvas.drawImage(Bild, 277, 180, 430, 430);
          setTimeout(function () {
            canvas.drawImage(Bild, 277, 180, 430, 430);
          }, 300);
        audio = new Audio("http://soundbible.com/mp3/Ta Da-SoundBible.com-1884170640.mp3").play();
      }
    }
    scores[1] = AblageListe[2][AblageListe[2].length - 1]
    if (JSON.parse(scores[0]) > JSON.parse(zweitBesteScores[mode][0]) && JSON.parse(scores[0]) < JSON.parse(highscores[mode][0])) {
      zweitBesteScores[mode][0] = scores[0];
      dbSet("von2Zu4", "zweitBesteScores" + name, JSON.stringify(zweitBesteScores));
    }
    if (JSON.parse(scores[1]) > JSON.parse(zweitBesteScores[mode][1]) && JSON.parse(scores[1]) < JSON.parse(highscores[mode][1])) {
      zweitBesteScores[mode][1] = scores[1];
      dbSet("von2Zu4", "zweitBesteScores" + name, JSON.stringify(zweitBesteScores));
    }
    KoordinatenY = 700;
    AblageListe[3] = 0;
    /*    canvas.fillStyle = "blue";
        canvas.fillRect(0,350,100 + 75,50);
        canvas.fillStyle = "yellow";
        canvas.fillRect(10,360,80 + 75,30);
        canvas.fillStyle = "black";
        canvas.fillText("Neue Runde", 13, 383) */
    document.getElementById('textur').style = "";
    gespeicherteHighscoresAbfragen();
    eigenenHighscoreAnzeigen();
  }

  while (KoordinatenY < 700) {
    if (AblageListe[2] == "NAN") {
      AblageListe[2] = 69;
    }

    if (felderAuswahl.includes(zählerListe[0] + " - " + zählerListe[1])) {
      canvas.fillStyle = "green";
    } else {
      canvas.fillStyle = "blue";
    }
    if (zählerListe[0] + " - " + zählerListe[1] == felderAuswahl[felderAuswahl.length - 1]) {
      canvas.fillStyle = "red"
    }

    canvas.beginPath();
    canvas.arc(KoordinatenX, KoordinatenY, AblageListe[2], 0, Math.PI * 2, false);
    canvas.fill();
    canvas.fillStyle = "yellow"
    canvas.beginPath();
    if (AblageListe[2] > 8) {
      canvas.arc(KoordinatenX, KoordinatenY, AblageListe[2] - 9, 0, Math.PI * 2, false);
      canvas.fill();
      canvas.fillStyle = "black";
    }
    //    canvas.
    if (zählerListe[0] + " - " + zählerListe[1] == felderAuswahl[felderAuswahl.length - 1] == false) {
      spielfeld[zählerListe[0]][zählerListe[1]] += "";
      canvas.font = (105 - 15 * spielfeld[zählerListe[0]][zählerListe[1]].length) - zählerListe[2] * 2 + "px Georgia";
      KoordinatenX += 10;
      KoordinatenX -= 10 * spielfeld[zählerListe[0]][zählerListe[1]].length;
      canvas.fillText(spielfeld[zählerListe[0]][zählerListe[1]], KoordinatenX - 23, KoordinatenY + 23);
      KoordinatenX -= 10;
      KoordinatenX += 10 * spielfeld[zählerListe[0]][zählerListe[1]].length;
    } else {
      AblageListe[1] = "";
      AblageListe[1] += zustände[1] * felderAuswahl.length;
      canvas.font = (105 - 15 * AblageListe[1].length) - zählerListe[2] * 2 + "px Georgia";
      KoordinatenX += 10;
      KoordinatenX -= 10 * AblageListe[1].length;
      canvas.fillText(zustände[1] * felderAuswahl.length, KoordinatenX - 23, KoordinatenY + 23);
      KoordinatenX -= 10;
      KoordinatenX += 10 * AblageListe[1].length;
    }
    KoordinatenX += 170;
    if (KoordinatenX > 1500) {
      KoordinatenX = 145;
      KoordinatenY += 170;
      zählerListe[0]++;
      zählerListe[1] = -1;
    }
    zählerListe[1]++;
  }
  AblageListe[2]--;
  zählerListe[2]++;
}

  /*   zustände[2] = "beendet"
     AblageListe[2] = 69;
     zählerListe[2] = 0;
  Endanimation = setInterval(endanimation, 10);  */

  function eigenenHighscoreAnzeigen() {
    canvas.font = "50px Georgia";
    canvas.fillStyle = "black";
    canvas.fillText("Punkte insgesamt: ", 30, 0 + 70);
    canvas.fillText("Höchste Punkte von 1 Stein: ", 30, 150 + 80);
    canvas.font = "30px Georgia";
    canvas.fillText("highscore: " + highscores[mode][0], 30, 115);
    canvas.fillText("zweit bester Score: " + zweitBesteScores[mode][0], 30, 145);
    canvas.fillText("score: " + scores[0], 30, 175);

    canvas.fillText("highscore: " + highscores[mode][1], 30, 270);
    canvas.fillText("zweit bester Score: " + zweitBesteScores[mode][1], 30, 300);
    canvas.fillText("score: " + scores[1], 30, 330);
  }

  //  window.scrollTo(0, 100);

  function remove0() {
    while (zählerListe[0] < AblageListe[2].length) {
      try {
        if (JSON.parse(AblageListe[2][zählerListe[0]])) {zustände[0] = "noError"}
      }
      catch (e) {
        AblageListe[2][zählerListe[0]] = AblageListe[2][zählerListe[0]].replace("0", "");
        zustände[0] = "error";
      }
      try {
        if (JSON.parse(AblageListe[2][zählerListe[0]])) {zustände[0] = "noError"}
      }
      catch (e) {
        AblageListe[2][zählerListe[0]] = AblageListe[2][zählerListe[0]].replace("0", "");
        zustände[0] = "error";
      }
      if (zustände[0] == "noError") {
        zählerListe[0]++;
      }
    /*  else {
        AblageListe[2][zählerListe[0]] = AblageListe[2][zählerListe[0]].replace("0", "");
        zustände[0] = "noError";
      } */
    }
  }
</script>
