<meta charset="utf-8">
<script src="https://adi.nicolaiweitkemper.de/Database2/js.js"></script>
<div id="settings">
  <!-- <button type="button" style="display:none" id="startButton" onclick="style.display = 'inline'; settings.style.display = 'none'; textur.style.display = 'inline'" name="button">start</button> -->
auch welche, bei denen ich am besten bin zeigen<input id="showFinished" onchange="getDatabase();" checked="true" type="checkbox">
<ul id="settingsL" font-size:30px></ul>
Breite<input type="text" onchange="verteilung.innerHTML = 'sie müssen noch ' + (JSON.parse(breite.value)*JSON.parse(hoehe.value) - JSON.parse(anzahlGeraden.value) - JSON.parse(anzahlPuffer.value) - JSON.parse(anzahlWeichen.value) - JSON.parse(anzahlKurven.value)) + ' Segment(e) verteilen, damit so viele Segmente wie die Höhe und Breite hergeben vorhanden sind.'" id="breite" value="7">
<br>
Höhe<input type="text" onchange="verteilung.innerHTML = 'sie müssen noch ' + (JSON.parse(breite.value)*JSON.parse(hoehe.value) - JSON.parse(anzahlGeraden.value) - JSON.parse(anzahlPuffer.value) - JSON.parse(anzahlWeichen.value) - JSON.parse(anzahlKurven.value)) + ' Segment(e) verteilen, damit so viele Segmente wie die Höhe und Breite hergeben vorhanden sind.'" id="hoehe" value="7">
<br>
anzahl Geraden<input id="anzahlGeraden" onchange="verteilung.innerHTML = 'sie müssen noch ' + (JSON.parse(breite.value)*JSON.parse(hoehe.value) - JSON.parse(anzahlGeraden.value) - JSON.parse(anzahlPuffer.value) - JSON.parse(anzahlWeichen.value) - JSON.parse(anzahlKurven.value)) + ' Segment(e) verteilen, damit so viele Segmente wie die Höhe und Breite hergeben vorhanden sind.'" type="text" value="16">
<br>
anzahl Puffer<input id="anzahlPuffer" onchange="verteilung.innerHTML = 'sie müssen noch ' + (JSON.parse(breite.value)*JSON.parse(hoehe.value) - JSON.parse(anzahlGeraden.value) - JSON.parse(anzahlPuffer.value) - JSON.parse(anzahlWeichen.value) - JSON.parse(anzahlKurven.value)) + ' Segment(e) verteilen, damit so viele Segmente wie die Höhe und Breite hergeben vorhanden sind.'" type="text" value="2">
<br>
anzahl Bahnhöfe<input id="anzahlBahnhoefe" type="text" value="1">
<br>
anzahl Kurven<input id="anzahlKurven" onchange="verteilung.innerHTML = 'sie müssen noch ' + (JSON.parse(breite.value)*JSON.parse(hoehe.value) - JSON.parse(anzahlGeraden.value) - JSON.parse(anzahlPuffer.value) - JSON.parse(anzahlWeichen.value) - JSON.parse(anzahlKurven.value)) + ' Segment(e) verteilen, damit so viele Segmente wie die Höhe und Breite hergeben vorhanden sind.'" type="text" value="24">
<br>
anzahl Weichen<input id="anzahlWeichen" onchange="verteilung.innerHTML = 'sie müssen noch ' + (JSON.parse(breite.value)*JSON.parse(hoehe.value) - JSON.parse(anzahlGeraden.value) - JSON.parse(anzahlPuffer.value) - JSON.parse(anzahlWeichen.value) - JSON.parse(anzahlKurven.value)) + ' Segment(e) verteilen, damit so viele Segmente wie die Höhe und Breite hergeben vorhanden sind.'" type="text" value="7">
<h2 id="verteilung"></h2>
<br>
auch beim Test rotieren<input id="rotateInRound" type="checkbox">
<br>
beenden, wenn alle Bahnhöfe grün/alle Personen mitgenommen <input type="checkbox" id="justBahnhoefe">
<br>
Anzahl Züge<input id="anzahlZuege" value="1" onchange="if (value > 1) everybodyBahnhofAccessP.style.display = 'inline'; else everybodyBahnhofAccessP.style.display = 'none';" type="text">
<div id="everybodyBahnhofAccessP">
  <br>
  mili sek (1000 = 1 sek.) zwischen dem Losfahren der Züge am Spawnpoint<input id="timeBetweenTrains" value="1000" type="text">
  <br>
  mili sek (1000 = 1 sek.) bis zufällig plazierte Züge losfahren<input id="timeBetweenRandomTrains" value="1000" type="text">
  <br>
  <input id="anzahlRandomTrains" value="0" onchange="if (JSON.parse(value) <= JSON.parse(anzahlBahnhoefe.value)) randomTrainsAtBahnhof.value = value;" type="text">der Züge sollen nur zur Behinderung zufällig spawnen
  <br>
  <p><input value="0" id="randomTrainsAtBahnhof" type="text">der zufälligen Züge sollen an einem Bahnhof spawnen</p>
  <br>
  auch zweiträngige Züge (braun) können kollidierenden <input type="checkbox" id="brownCollide" checked="true">
  <br>
  Kollision auch mit Zügen möglich, die noch nicht losgefahren sind, aber auch nicht beim Spawnpoint des 1. Zuges warten <input type="checkbox" id="stayingTrainCollision">
  <br>
  alle Züge können Personen mitnehmen/Bahnhöfe grün machen<input type="checkbox" id="everybodyBahnhofAccess">
  <br>
  keine zweiträngige Züge (braun) dürfen einen Banhof anfahren <input type="checkbox" id="justTrainBahnhof">
  <br>
  alle Züge müssen das Ziel erreichen<input type="checkbox" id="everybodyMustFinish">
  <br>
  alle Züge können das Ziel erreichen<input type="checkbox" id="everybodyCanFinish">
  <br>
  Zug ist bei Erreichen des Ziels weg <input type="checkbox" checked="true" id="disapearWhenFinished">
</div>
<br>
<button type="button" id="createFieldButton" onclick="createField();" style="font-size: 55px" name="button">create field</button>
</div>
<div id="highscores">
  <h1 id="highscoresBetterThanYours"></h1>
  <h1 id="highscoresAsGoodAsYours"></h1>
  <h1 id="highscoresWorseThanYours"></h1>
</div>
<canvas id="textur" onclick="canvasClicked();" width="1800" height="700"></canvas>
<br>
<h1 id="nameEingeloggt" onclick='name = prompt ("Mit welchem Namen wollen sie sich eingloggen?"); nameEingeloggt.innerHTML = "als " + name + " eingeloggt"; getDatabase();'></h1>
<br>
<button type="button" onclick="downloadHighscores(true);" name="button">download highscores and maps for offline play</button>
<br>
<p id="pSaveAutomaticly"><input type="checkbox" onchange="localStorage.setItem('saveAutomaticlyHelpTheTrain', checked);" id="saveAutomaticly">autosave</p>
<br>
<button type="button" style="font-size: 77px" id="test" onclick="testTrain(innerHTML);" name="button">test</button>
<br>
play train audio<input onchange="playTrainAudio(true);" checked="true" id="trainAudio" type="checkbox">
<br>
use fast train audio<input onchange="playTrainAudio(true);" checked="true" id="fastTrainAudio" type="checkbox">
<script>
  var alertWhenFinishedSaving = false;
  window.onbeforeunload = function(){
  console.log("Leave Website");
    if (dbSetWarteschlange.length > 0) {alertWhenFinishedSaving = true; return 'Es wurden noch nicht alle Änderungen gespeichert! Bitte klicken sie auf "bleiben" und warten sie auf die Meldung, dass der Speichervorgang erfolgreich war!';}
};
  textur.style.display = "none";
  document.getElementById('highscoresBetterThanYours').style.color = "red"
  document.getElementById('highscoresWorseThanYours').style.color = "green";
  document.getElementById('highscores').style.display = "none";
  everybodyBahnhofAccessP.style.display = 'none';
  var canvas = textur.getContext('2d');
  function downloadHighscores(warn) {
    if ((!warn || confirm("WARNUNG: Dies muss die Datei sein, mit der sie nachher offline spielen wollen! Andernfalls werden die Highscores nicht auftauchen! Trotzdem fortfahren?"))) {
      pSaveAutomaticly.style.display = "inline";
      if (!localStorage.getItem("saveAutomaticlyHelpTheTrain")) {
        saveAutomaticly.checked = confirm("Wollen sie, dass die Daten immer hochgeladen werden, wenn sie diese Datei öffnen?");
        localStorage.setItem("saveAutomaticlyHelpTheTrain", saveAutomaticly.checked);
      }
      localStorage.setItem("downloadedHighscoresHelpTheTrain", JSON.stringify(highscores));
    }
  }
  function releaseTrain(i) {
    if (inRound && i > -1) train[i].moving = true;
    i++;
    var timeInterval = timeBetweenRandomTrains.value;
    if (i > JSON.parse(anzahlRandomTrains.value)) timeInterval = timeBetweenTrains.value;
    if ((i < JSON.parse(anzahlZuege.value)) && inRound) {
      setTimeout(function () {
        if (inRound) releaseTrain(i);
      }, timeInterval);
    }
  }
  function testTrain(innerHTML) {
    inRound = true;
    playTrainAudio();
    if (innerHTML == 'test') {
      test.innerHTML = 'beende test';
      window.scroll(0, 0);
      setTimeout(function () {
        scrollingInterac.user = false;
      }, 100);
      moveTrain();
      //var anzahlZuege = {value: 2};;
      releaseTrain(-1);
      // var timeInterval = timeBetweenRandomTrains.value;
      // if (i > JSON.parse(anzahlRandomTrains.value)) timeInterval = timeBetweenTrains.value;
      // var Test = setInterval(function () {
      //   if (inRound) train[i].moving = true;
      //   i++;
      //   var timeInterval = timeBetweenRandomTrains.value;
      //   if (i > JSON.parse(anzahlRandomTrains.value)) timeInterval = timeBetweenTrains.value;
      //   if (!(i < JSON.parse(anzahlZuege.value))) clearInterval(Test);
      // }, timeInterval);
    }
    else {resetTrain();}
  }
  var fields = [
      { // gerade
        wallStructure: [
          {
            type: "wall",
            number: 3
          },
          {
            type: "way",
            number: 3,
          },
          {
            type: "wall",
            number: 3
          }
        ],
        number: 16
      },
      /*{ // Bahnhof
        wallStructure: [
          {
            type: "bahnsteig",
            number: 3,
            done: false
          },
          {
            type: "wall",
            number: 6,
          }
        ],
        number: 2
      },*/
      { // Puffer
        wallStructure: [
          {
            type: "wall",
            number: 3
          },
          {
            type: "way",
            number: 2,
          },
          {
            type: "wall",
            number: 4
          }
        ],
        number: 2
      },
      {
        wallStructure: [
          { // Kurve
            type: "wall",
            number: 4
          },
          {
            type: "way",
            number: 2,
          },
          {
            type: "wall",
            number: 1
          },
          {
            type: "way",
            number: 1,
          },
          {
            type: "wall",
            number: 1
          }
        ],
        number: 24
      },
      {
        wallStructure: [
          { // Weiche
            type: "wall",
            number: 1
          },
          {
            type: "way",
            number: 1,
            active: true
          },
          {
            type: "wall",
            number: 1
          },
          {
            type: "way",
            number: 2,
            active: true
          },
          {
            type: "way",
            number: 1,
            active: false
          },
          {
            type: "wall",
            number: 3
          }
        ],
        number: 7
      }

  ]
  if (!localStorage.getItem("storedName")) var name = prompt("Bitte geben sie ihren (spitz) Namen ein, um ihre Highscores speichern zu können");
  else var name = localStorage.getItem("storedName");
  localStorage.setItem("storedName", name);
  nameEingeloggt.innerHTML = "als " + name + " eingeloggt"
  getDatabase();
  function uploadData() {
    var doubleSettings = [];
    if (localStorage.getItem("newFieldUploadHelpTheTrain")) {
      var list = JSON.parse(localStorage.getItem("newFieldUploadHelpTheTrain"));
      for (var i = 0; i < list.length; i++) {
        if (!list[i].gapFiller) {
        var newSettings = JSON.parse(JSON.stringify(list[i].selectedSettings));
        doubleSettings.push(JSON.parse(JSON.stringify(list[i].selectedSettings)));
        for (var i1 = 0; Object.keys(highscores).includes(newSettings); i1++) {
          newSettings += "|";
          doubleSettings[doubleSettings.length - 1] += "|";
        }
        highscores[newSettings] = list[i].data;
        list.shift();
        i--;
      }
      else doubleSettings.push("gapFiller");
      }
      localStorage.setItem("newFieldUploadHelpTheTrain", []);
      dbSetWarteschlange.push({tag: "highscores", data: highscores});
    }
    if (localStorage.getItem("highscoresUploadHelpTheTrain")) {
      var list = JSON.parse(localStorage.getItem("highscoresUploadHelpTheTrain"));
      for (var i = 0; i < list.length; i++) {
        if (doubleSettings[i] != "gapFiller") list[i].selectedSettings = doubleSettings[i];
        if (!highscores[list[i].selectedSettings].highscores[name] || highscores[list[i].selectedSettings].highscores[name] > list[i].data) highscores[list[i].selectedSettings].highscores[name] = list[i].data;
        list.shift();
        doubleSettings.shift();
        i--;
      }
      localStorage.setItem("highscoresUploadHelpTheTrain", []);
      dbSetWarteschlange.push({tag: "highscores", data: highscores});
    }
  }
  function getDatabase(pReturn) {
    if (pReturn) alert("Sie haben es in " + zuege + " Zügen geschafft!");
    dbGet("helpTheTrain", "highscores").then(result => {
      highscores = result;
      uploadData();
      setTimeout(function () {
        if (localStorage.getItem("saveAutomaticlyHelpTheTrain") != undefined) {
          downloadHighscores();
          saveAutomaticly.checked = JSON.parse(localStorage.getItem("saveAutomaticlyHelpTheTrain"));
        }
        else pSaveAutomaticly.style.display = "none";
        displaySettingsList();
      }, 1000);
      if (pReturn) saveHighscore();
    }).catch(function(e) {
      if (pReturn) saveHighscore();
      else if (e == "TypeError: Failed to fetch") {
        alert("Der offline Modus ist aktiviert! Sie können neue zufällige Level erstellen (auch ohne dass sie gespeichert werden). Zudem können sie falls sie mit dieser Datei schon Mal die daten heruntergeladen haben die damaligen highscores angezeigen und neue, falls sie neue aufstellen, wenn sie mit dieser Datei später ins Internet gehen hochgeladen! Das Audio wird erst gespeichert, wenn sie es bereits auf der Seite abgespielt haben.");
        offline = true;
        if (JSON.parse(localStorage.getItem("downloadedHighscoresHelpTheTrain"))) highscores = JSON.parse(localStorage.getItem("downloadedHighscoresHelpTheTrain"));
        else alert("keine Felder gespeichert!");
      }
      if (e != "TypeError: Failed to fetch") uploadData();
      setTimeout(function () {
        displaySettingsList();
      }, 1000);
    });
  }
  var offline = false;
  function displaySettingsList() {
    for (var i1 = 0; i1 < Object.keys(highscores).length; i1++) {
      try {
        document.getElementById("listEl " + i1).remove();
      } catch (e) {
        //console.log("please debug");
      }
    }
    for (var i = 0; i < Object.keys(highscores).length; i++) {
      var bestHighscore = {i: -1, number: 1111};
      for (var i1 = 0; i1 < Object.keys(highscores[Object.keys(highscores)[i]].highscores).length; i1++) {
        if (highscores[Object.keys(highscores)[i]].highscores[Object.keys(highscores[Object.keys(highscores)[i]].highscores)[i1]] < bestHighscore.number) bestHighscore.number = highscores[Object.keys(highscores)[i]].highscores[Object.keys(highscores[Object.keys(highscores)[i]].highscores)[i1]];
      }
      if ((((!highscores[Object.keys(highscores)[i]].highscores[name] || highscores[Object.keys(highscores)[i]].highscores[name] < bestHighscore.number) && !showFinished.checked) || (showFinished.checked))) {
        var li = document.createElement("li");
        var settingsText = document.createTextNode(Object.keys(highscores)[i].toString().split(', ').splice(4, Object.keys(highscores)[i].toString().split(', ').length - 4)).data.split(',alle Züge k')[0];
        li.appendChild(document.createTextNode(settingsText));
        if (highscores[Object.keys(highscores)[i]].highscores[name] > bestHighscore.number) li.setAttribute("style",'color:red');
        else if (highscores[Object.keys(highscores)[i]].highscores[name] != undefined) li.setAttribute("style",/*'color:#40FF00'*/'color:green');
        else li.setAttribute("style",'color:blue');
        li.setAttribute("onclick", "changeSettings(Object.keys(highscores)[id.toString().split('listEl ')[1]])");
        li.setAttribute("id", "listEl " + i);
        document.getElementById("settingsL").appendChild(li);
      }
    }
  }
  function changeSettings(innerHTML) {
    // if (createFieldButton.innerHTML == "create field") {
    document.getElementById('highscores').style.display = "inline";
    anzahlBahnhoefe.value = JSON.parse(innerHTML.toString().split("Anzahl Bahnhoefe: ")[1].toString().split(", ")[0]);
    rotateInRound.checked = JSON.parse(innerHTML.toString().split("bei Test rotieren: ")[1].toString().split(", ")[0]);
    everybodyBahnhofAccess.checked = JSON.parse(innerHTML.toString().split("grün machen: ")[1].toString().split(", ")[0]);
    everybodyMustFinish.checked = JSON.parse(innerHTML.toString().split("müssen das Ziel erreichen: ")[1].toString().split(", ")[0]);
    everybodyCanFinish.checked = JSON.parse(innerHTML.toString().split("können das Ziel erreichen: ")[1].toString().split(", ")[0]);
    disapearWhenFinished.checked = JSON.parse(innerHTML.toString().split("weg: ")[1].toString().split(", ")[0]);
    timeBetweenTrains.value = JSON.parse(innerHTML.toString().split("zwischen Zügen: ")[1].toString().split(", ")[0]);
    timeBetweenRandomTrains.value = JSON.parse(innerHTML.toString().split("bis zufällige Züge losfahren: ")[1].toString().split(", ")[0]);
    anzahlZuege.value = JSON.parse(innerHTML.toString().split("Anzahl Züge: ")[1].toString().split(", ")[0]);
    //anzahlRandomTrains.value = JSON.parse(innerHTML.toString().split("Zeit bis Züge losfahren: ")[1].toString().split(", ")[0]);
    //randomTrainsAtBahnhof.value = JSON.parse(innerHTML.toString().split("Züge an Bahnhof: ")[1].toString().split(", ")[0]);
    justBahnhoefe.checked = JSON.parse(innerHTML.toString().split("beenden, wenn alle Bahnhöfe grün: ")[1].toString().split(", ")[0]);
    brownCollide.checked = JSON.parse(innerHTML.toString().split("braune Züge können kollidierenden: ")[1].toString().split(", ")[0]);
    stayingTrainCollision.checked = JSON.parse(innerHTML.toString().split("Kollision auch mit stehenden Zügen: ")[1].toString().split(", ")[0]);
    justTrainBahnhof.checked = JSON.parse(innerHTML.toString().split(", braune Züge dürfen keinen Bahnhof berühren: ")[1].toString().split("|")[0]);
    createFieldButton.innerHTML = "create field";
    createField(true, innerHTML);
  }
  var field = [];
  var bahnhoefe = {verbleibend: 1, collected: 0, all: 1};
  var highscores = {};
  function createField(restore, selected) {
    if (createFieldButton.innerHTML == "create field") {
    if (restore) {
      createFieldButton.innerHTML = "start";
      if (anzahlZuege.value > 1) everybodyBahnhofAccessP.style.display = "inline";
      else everybodyBahnhofAccessP.style.display = "none";
    }
    else textur.style.display = "inline";
    selectedSettings = "Anzahl Kurven: " + anzahlKurven.value + ", Anzahl Weichen: " + anzahlWeichen.value + ", Anzahl Geraden: " + anzahlGeraden.value + ", Anzahl Puffer: " + anzahlPuffer.value + ", Anzahl Bahnhoefe: " + anzahlBahnhoefe.value /*+ ", Zeit bis Züge losfahren: " + anzahlRandomTrains.value  + ", anzahl Züge zur Behinderung: " + anzahlRandomTrains.value + ", anzahl Züge an Bahnhof: " + randomTrainsAtBahnhof.value*/ + ", breite: " + breite.value + ", höhe: " + hoehe.value +  ", bei Test rotieren: " + rotateInRound.checked + ", alle Züge können Personen mitnehmen/Bahnhöfe grün machen: " + everybodyBahnhofAccess.checked + ", alle Züge müssen das Ziel erreichen: " + everybodyMustFinish.checked + ", alle Züge können das Ziel erreichen: " + everybodyCanFinish.checked + ", Zug ist bei Erreichen des Ziels weg: " + disapearWhenFinished.checked + ", mili sec. zwischen Zügen: " + timeBetweenTrains.value + ", Zeit bis zufällige Züge losfahren: " + timeBetweenRandomTrains.value + ", Anzahl Züge: " + anzahlZuege.value + ", beenden, wenn alle Bahnhöfe grün: " +
    justBahnhoefe.checked + ", " + "auch braune Züge können kollidierenden: " + brownCollide.checked + ", Kollision auch mit stehenden Zügen: " + stayingTrainCollision.checked + ", braune Züge dürfen keinen Bahnhof berühren: " + justTrainBahnhof.checked;
    if (restore) {field = highscores[selected].data.field; train = highscores[selected].data.trains}
    if (!restore && Object.keys(highscores).includes(selectedSettings) && confirm("Diese Einstelungen wurden bereits von jemandem getroffen! Sie können das Level mit den Einstellungen spielen. Wollen sie dennoch ein neues Level mit den selben Einstellungen erstellen?")) {
      for (var i = 0; Object.keys(highscores).includes(selectedSettings); i++) {
        selectedSettings += "|";
      }
    }
    else if (!restore && Object.keys(highscores).includes(selectedSettings)) {
      return "cancel";
    }
    fields[0].number = JSON.parse(anzahlGeraden.value);
    fields[1].number = JSON.parse(anzahlPuffer.value);
    fields[2].number = JSON.parse(anzahlKurven.value);
    fields[3].number = JSON.parse(anzahlWeichen.value);
    bahnhoefe.all = JSON.parse(JSON.stringify(JSON.parse(anzahlBahnhoefe.value)));
    bahnhoefe.verbleibend = JSON.parse(JSON.stringify(JSON.parse(anzahlBahnhoefe.value)));

    for (var i = 0; !restore && i < JSON.parse(breite.value); i++) {
    field[i] = [];
    for (var i1 = 0; i1 < JSON.parse(hoehe.value); i1++) {
      field[i][i1] = newField(i);
    }
  }
  selectedField = JSON.parse(JSON.stringify(field));
  if (!restore) settings.style.display = "none";
  zuege = 0;
  for (var i = 1; i < JSON.parse(anzahlZuege.value) && !restore; i++) {
    train.push({spawnPoint: {x: 0, y: 0, i2: 1, i3: 1}, position: {x: 0, y: 0, i2: 1, i3: 1}, direction: "right"});
    if (i <= (JSON.parse(anzahlRandomTrains.value) - JSON.parse(randomTrainsAtBahnhof.value))) {
      var randomPosition = {x: Math.round(Math.random() *(field.length - 1)), y: Math.round(Math.random() *(field[0].length - 1)), i2: Math.round(Math.random() *(2)), i3: Math.round(Math.random() *(2))};
      train[train.length - 1].spawnPoint = {x: randomPosition.x, y: randomPosition.y, i2: randomPosition.i2, i3: randomPosition.i3};
      field[randomPosition.x][randomPosition.y][randomPosition.i2][randomPosition.i3].spawnPoint = true;
      if (field[train[train.length - 1].spawnPoint.x][train[train.length - 1].spawnPoint.y][train[train.length - 1].spawnPoint.i2][train[train.length - 1].spawnPoint.i3].type != "way") {
        train.pop();
        i--;
      }
    }
    else if (i <= JSON.parse(anzahlRandomTrains.value)) {
      for (var i2 = 0; i2 < field.length; i2++) {
        for (var i3 = 0; i3 < field[0].length; i3++) {
          for (var i4 = 0; i4 < 3; i4++) {
            for (var i5 = 0; i5 < 3; i5++) {
              try {
                if (field[i2][i3][i4][i5].collected != undefined && !field[i2][i3][i4][i5].alreadyDone && field[i2][i3][i4 - 1] && field[i2][i3][i4 - 1][i5].type == "way") {train[i].spawnPoint = {x: i2, y: i3, i2: i4 - 1, i3: i5}; field[i2][i3][i4][i5].alreadyDone = true; field[i2][i3][i4 - 1][i5].spawnPoint = true; i2 = field.length; i3 = field[0].length; i4 = 3; i5 = 3;}
                else if (field[i2][i3][i4][i5].collected != undefined && !field[i2][i3][i4][i5].alreadyDone && field[i2][i3][i4 + 1] && field[i2][i3][i4 + 1][i5].type == "way") {train[i].spawnPoint = {x: i2, y: i3, i2: i4 + 1, i3: i5}; field[i2][i3][i4][i5].alreadyDone = true; field[i2][i3][i4 + 1][i5].spawnPoint = true; i2 = field.length; i3 = field[0].length; i4 = 3; i5 = 3;}
                else if (field[i2][i3][i4][i5].collected != undefined && !field[i2][i3][i4][i5].alreadyDone && field[i2][i3][i4][i5 - 1] && field[i2][i3][i4][i5 - 1].type == "way") {train[i].spawnPoint = {x: i2, y: i3, i2: i4, i3: i5 - 1}; field[i2][i3][i4][i5].alreadyDone = true; field[i2][i3][i4][i5 - 1].spawnPoint = true; i2 = field.length; i3 = field[0].length; i4 = 3; i5 = 3;}
                else if (field[i2][i3][i4][i5].collected != undefined && !field[i2][i3][i4][i5].alreadyDone && field[i2][i3][i4][i5 + 1] && field[i2][i3][i4][i5 + 1].type == "way") {train[i].spawnPoint = {x: i2, y: i3, i2: i4, i3: i5 + 1}; field[i2][i3][i4][i5].alreadyDone = true; field[i2][i3][i4][i5 + 1].spawnPoint = true; i2 = field.length; i3 = field[0].length; i4 = 3; i5 = 3;}

              } catch (e) {
                console.log("etwas zu tun XD");
              }
            }
          }
        }
      }
    }
  }
  bahnhoefe.verbleibend = JSON.parse(JSON.stringify(JSON.parse(anzahlBahnhoefe.value)));
  resetTrain();
  Layout();
  }
  else {
    createFieldButton.innerHTML = "create field";
    settings.style.display = 'none';
    textur.style.display = 'inline';
    changeSettings(selectedSettings);
  }
}
var train = [{spawnPoint: {x: 0, y: 0, i2: 1, i3: 1}, position: {x: 0, y: 0, i2: 1, i3: 1}, direction: "right"}];
function newField(pI) {
  var newField = {};
  var possibleStructure = [];
  for (var i = 0; i < fields.length; i++) {
    if (fields[i].number > 0) possibleStructure.push(i);
  }
  var selectedStructure = possibleStructure[Math.round(Math.random() *(possibleStructure.length - 1))];
  var i2 = 0;
  var i3 = 0;
  // try {
  //   console.log(fields[selectedStructure].wallStructure);
  // } catch (e) {
  //   console.log("please debug ;) ");
  // }
  for (var i = 0; i < fields[selectedStructure].wallStructure.length; i++) {
    for (var i1 = 0; i1 < fields[selectedStructure].wallStructure[i].number; i1++) {
      if (!newField[i2]) newField[i2] = [];
      newField[i2][i3] = {type: fields[selectedStructure].wallStructure[i].type};
      if (fields[selectedStructure].wallStructure[i].active != undefined) newField[i2][i3].active = fields[selectedStructure].wallStructure[i].active;
      i2++;
      if (i2 == 3) {i2 = 0; i3++;}
    }
  }
  for (var i2 = 0; i2 < 3; i2++) {
    for (var i3 = 0; i3 < 3; i3++) {
      if (pI > 0 && newField[i2][i3].type == "wall" && bahnhoefe.verbleibend > 0 && Math.round(Math.random() *(100)) > 97 && ((newField[i2 - 1] && newField[i2 - 1][i3].type == "way") || (newField[i2 + 1] && newField[i2 + 1][i3].type == "way") || (newField[i2][i3 - 1] && newField[i2][i3 - 1].type == "way") || (newField[i2][i3 + 1] && newField[i2][i3 + 1].type == "way"))) {
        newField[i2][i3].collected = false;
        bahnhoefe.verbleibend--;
      }
    }
  }
  fields[selectedStructure].number--;
  for (var i = 0; (i < Math.round(Math.random() * 11)); i++) {
    if ((Math.round(Math.random() *1) == 0)) newField = turn("right", newField);
    else newField = turn("left", newField);
  }
  return newField
}
function turn(direction, officialCard, x, y) {
document.getElementById('highscores').style.display = 'none';
zuege++;
var newField = {0: [], 1: [], 2: []};
newField[1][1] = officialCard[1][1];
if (direction == "right") {
  for (var i = 0; i < 3; i++) { // rechts --> unten works!
    newField[i][2] = officialCard[2][i];
    turnSpawnPoint(x, y, 2, i, i, 2);
  }
  for (var i = 0; i < 3; i++) { // unten --> links  works!
    newField[0][i] = officialCard[1 - 1 + i][1 + 1];
    turnSpawnPoint(x, y, i, 2, 0, i);
  }
  for (var i = 0; i < 3; i++) { // oben --> rechts works!
    newField[2][i] = officialCard[i][0];
    turnSpawnPoint(x, y, i, 0, 2, i);
  }
  var i1 = 0;
  for (var i = 2; i > -1; i--) { // links --> oben works!
    newField[i1][0] = officialCard[0][i];
    turnSpawnPoint(x, y, 0, i, i1, 0);
    i1++;
  }
}
else {
  for (var i = 2; i > -1; i--) { // rechts --> oben
    newField[i][0] = officialCard[2][i];
    turnSpawnPoint(x, y, 2, i, i, 0);
  }
  var i1 = 0;
  for (var i = 3; i > 0; i--) { // unten --> rechts
    newField[2][i - 1] = officialCard[i1][2];
    turnSpawnPoint(x, y, i1, 2, 2, i - 1);
    i1++;
  }
  var i1 = 0;
  for (var i = 3; i > 0; i--) { // oben --> links
    newField[0][i1] = officialCard[i - 1][0];
    turnSpawnPoint(x, y, i - 1, 0, 0, i1);
    i1++;
  }
  for (var i = 0; i < 3; i++) { // links --> unten
    newField[i][2] = officialCard[0][i];
    turnSpawnPoint(x, y, 0, i, i, 2);
  }
}

return newField;
}
function turnSpawnPoint(x, y, i, i1, iBefore, i1Before) {
  if (x != undefined && field[x][y][i][i1].spawnPoint) {
    for (var i2 = 0; i2 < train.length; i2++) {
      if (equals({x: train[i2].spawnPoint.x, y: train[i2].spawnPoint.y, i2: train[i2].spawnPoint.i2, i3: train[i2].spawnPoint.i3}, {x: x, y: y, i2: i, i3: i1})) {
        train[i2].spawnPoint = {x: x, y: y, i2: iBefore, i3: i1Before};
        train[i2].position = {x: x, y: y, i2: iBefore, i3: i1Before};
      }
    }
  }
}
function Layout(times) {
  textur.height = field[0].length*3*50 + 10 + 50;
  textur.width = field.length*3*50 + 10 + 50;
  if (!times) times = 0;
  for (var i = 0; i < field.length; i++) {
    for (var i1 = 0; i1 < field[0].length; i1++) {
      displayCard(field, i, i1, 10 + 50*3*i, 10 + 50*3*i1, times);
    }
  }
  /*if (times < 5) {
    setTimeout(function () {
      Layout(times + 1);
    }, 70);
  }*/
  canvas.fillStyle = "red";
  canvas.fillRect((field.length*3*50)/ 2 + 10, field[0].length*3*50 + 10, 40, 40);
  //var trainColors = ["red", "brown"];
  for (var i = 0; i < train.length; i++) {
    if (i != 0) canvas.fillStyle = "brown"//trainColors[i];
    canvas.fillRect(10 + train[i].position.x*50*3 + train[i].position.i2*50 + 5, 10 + 50*3*train[i].position.y + train[i].position.i3*50 + 5, 40, 40);
  }
}

function displayCard(field, i, i1, startx, starty, times) {
  canvas.globalAlpha = 1;//0.5
  if (isNaN(times)) canvas.globalAlpha = 0.5;
  for (var i2 = 0; i2 < 3; i2++) {
    for (var i3 = 0; i3 < 3; i3++) {
      if (field[i][i1][i2][i3].type == "wall") canvas.fillStyle = "brown";
      else if (field[i][i1][i2][i3].type == "way") canvas.fillStyle = "gray";
      if (field[i][i1][i2][i3].type == "wall" && field[i][i1][i2][i3].collected === false) canvas.fillStyle = "red";
      if (field[i][i1][i2][i3].type == "wall" && field[i][i1][i2][i3].collected === true) canvas.fillStyle = "#40FF00";
      fillField(i2, i3, startx, starty);
      if (field[i][i1][i2][i3].active) {
         canvas.globalAlpha = 0.4;
        canvas.fillStyle = "green";
        fillField(i2, i3, startx, starty);
         canvas.globalAlpha = 1;
      }
    }
  }
}
function fillField(i2, i3, startx, starty) {
  if ((i2 == 2 && i3 == 2)) canvas.fillRect(startx + 50*i2, starty + 50*i3, 45, 45);
  else if (i2 == 2) canvas.fillRect(startx + 50*i2, starty + 50*i3, 45, 50);
  else if (i3 == 2) canvas.fillRect(startx + 50*i2, starty + 50*i3, 50, 45);
  else/* (i2 != 2 && i3 != 2)*/ canvas.fillRect(startx + 50*i2, starty + 50*i3, 50, 50);
}
var xMaus;
var yMaus;
document.onmousemove = readMouseMove
function readMouseMove(e) {
  xMaus = e.clientX + scrollX //- 10;
  yMaus = e.clientY + scrollY //+ 23//- 33;
  //    console.log(xMaus + " - " + yMaus);
  canvas.fillStyle = "red";
  if (selected.type == "train") {Layout(5); canvas.fillRect(xMaus, yMaus, 40, 40);}
}
var scrollingInterac = {};
window.onscroll = function (e) {
  //console.log("scroll event");
  if (!scrollingInterac.PC) {
    scrollingInterac.user = true;
  }
  if (scrollY == 0) {
    scrollingInterac.user = false;
  }
  //if (scrollY < 10 && scrollX < 10) scrollingInterac.user = false;
}
function canvasClicked() {
  for (var i = 0; i < field.length; i++) {
  for (var i1 = 0; i1 < field[0].length; i1++) {
    // 10 + 50*document.body.style.zoom*3*i, 10 + 50*document.body.style.zoom*3*i1
    for (var i2 = 0; i2 < 3; i2++) {
      for (var i3 = 0; i3 < 3; i3++) {
        // if (xMaus > 10 + 50*document.body.style.zoom*i2*i && xMaus < 10 + 50*document.body.style.zoom*i2*i  + 130 && yMaus > 10 + 50*document.body.style.zoom*i3*i1  && yMaus < 10 + 50*document.body.style.zoom*i3*i1  + 130 && player.movement == "movingPlayer" && checkMovementPossibe(player.movingPlayer.x, player.movingPlayer.y, player.movingPlayer.i2, player.movingPlayer.i3)) {
        //       field[i][i1][i2][i3].player = player.myNumber
        //       field[player.movingPlayer.x][player.movingPlayer.y][i2][i3].player = false;
        //     }
        if ((/*gerät == "PC" && */xMaus > 10 + 50*document.body.style.zoom*3*i + 50*document.body.style.zoom*i2 && xMaus < 10 + 50*document.body.style.zoom*3*i + 50*document.body.style.zoom*i2 + 50*document.body.style.zoom && yMaus > 10 + 50*document.body.style.zoom*3*i1 + 50*document.body.style.zoom*i3 && yMaus < 10 + 50*document.body.style.zoom*3*i1 + 50*document.body.style.zoom*i3 + 50*document.body.style.zoom) /*|| (gerät == "Handy" && xMaus > 10 + 50*document.body.style.zoom*3*i + 50*document.body.style.zoom*i2 && xMaus < 10 + 50*document.body.style.zoom*3*i + 50*document.body.style.zoom*i2 + 50*document.body.style.zoom && yMaus - scrollY > 10 + 50*document.body.style.zoom*3*i1 + 50*document.body.style.zoom*i3 && yMaus - scrollY < 10 + 50*document.body.style.zoom*3*i1 + 50*document.body.style.zoom*i3 + 50*document.body.style.zoom)*/) {
          console.log(i + "- " + i1 + " - " + i2 + " - " + i3);
          if (!inRound && i == train[0].spawnPoint.x && i1 == train[0].spawnPoint.y && i2 == train[0].spawnPoint.i2 && i3 == train[0].spawnPoint.i3)  {
            var moveTrain = true;
            selected.type = "train";
          }
          if (selected.type != "train") {
          if (field[i][i1][i2][i3].active) { // weiche stellen
            var audio = new Audio("https://adi.nicolaiweitkemper.de/Sounds/helpTheTrain/weiche.mp3").play();
            // weiche noch nicht gestellt (Ausgangszustand)
            if (!field[i][i1].straight) {
            if ((!field[i][i1][0][1].active && field[i][i1][0][1].type == "way")/*Weiche nach unten -*/) {field[i][i1][0][1].active = true; field[i][i1][1][2].active = false;}
            else if ((!field[i][i1][2][1].active && field[i][i1][2][1].type == "way")/*Weiche nach oben -*/) {field[i][i1][2][1].active = true; field[i][i1][1][0].active = false;}
            else if ((!field[i][i1][1][2].active && field[i][i1][1][2].type == "way")/*Weiche nach rechts -*/) {field[i][i1][1][2].active = true; field[i][i1][2][1].active = false;}
            else if ((!field[i][i1][1][0].active && field[i][i1][1][1].type == "way")/*Weiche nach links*/) {field[i][i1][1][0].active = true; field[i][i1][0][1].active = false;}
            field[i][i1].straight = true;
          }
          else {
            if ((!field[i][i1][1][2].active && field[i][i1][1][2].type == "way")/*Weiche nach unten -*/) {field[i][i1][0][1].active = false; field[i][i1][1][2].active = true;}
            else if ((!field[i][i1][1][0].active && field[i][i1][1][0].type == "way")/*Weiche nach oben -*/) {field[i][i1][2][1].active = false; field[i][i1][1][0].active = true;}
            else if ((!field[i][i1][2][1].active && field[i][i1][2][1].type == "way")/*Weiche nach rechts -*/) {field[i][i1][1][2].active = false; field[i][i1][2][1].active = true;}
            else if ((!field[i][i1][0][1].active && field[i][i1][0][1].type == "way")/*Weiche nach links*/) {field[i][i1][1][0].active = false; field[i][i1][0][1].active = true;}
            field[i][i1].straight = false;
          }
        }
          else if (!inRound || rotateInRound.checked) {
            field[i][i1] = turn("right", field[i][i1], i, i1);
            var audio = new Audio("https://adi.nicolaiweitkemper.de/Sounds/helpTheTrain/turn.mp3").play();
          }
          Layout();
        }
        else if (field[i][i1][i2][i3].type == "way" && i == 0 && !moveTrain) {
          for (var i4 = 0; i4 < train.length - JSON.parse(anzahlRandomTrains.value); i4++) {
            train[i4].spawnPoint = {x: 0, y: i1, i2: i2, i3: i3};
            train[i4].position = JSON.parse(JSON.stringify(train[0].spawnPoint));
          }
          selected.type = "";
          Layout();
        }
      }
      }
    }
  }
}
// (7*3*50*document.body.style.zoom)/ 2 + 10, 7*3*50*document.body.style.zoom + 10, 40, 40
if (xMaus > (field.length*3*50*document.body.style.zoom)/ 2 + 10 && xMaus < (field.length*3*50*document.body.style.zoom)/ 2 + 10 + 40 && yMaus > field[0].length*3*50*document.body.style.zoom + 10 && yMaus < field[0].length*3*50*document.body.style.zoom + 10 + 40) selected.type = "train";
}
var selected = {type: ""};
var inRound = false;
document.body.style.zoom = 1.0;
function moveTrain() {
  document.body.style.zoom = 1.0;
  for (var i = 0; i < train.length; i++) {
    if (train[i].moving) {
      collisionCheck(i);
      var scrollPosition = {x: train[i].position.x, y: train[i].position.y};
      var cameraMovements = 2;
      for (var i2 = 0; cameraMovements > 1 && i2 < 100; i2++) {
        cameraMovements = 0;
        for (var i1 = 0; i1 < train.length; i1++) {
          var scrollPosition = {x: train[i].position.x, y: train[i].position.y};
          if (train[i1].position.x == 0 || train.length > 1) scrollPosition.x++;
          if (train[i1].position.y == 0 || train.length > 1) scrollPosition.y++;
          if (!scrollingInterac.user && /*screen.availHeight*/window.innerHeight + scrollY < 10 + (scrollPosition.y + 1)*50*document.body.style.zoom*3 + train[i1].position.i3 || !scrollingInterac.user && /*screen.availWidth*/window.innerWidth + scrollX < 10 + (scrollPosition.x + 1)*50*document.body.style.zoom*3 + train[i1].position.i2 || !scrollingInterac.user && 10 + (scrollPosition.y - 1)*50*document.body.style.zoom*3 + train[i1].position.i3 < scrollY || !scrollingInterac.user && 10 + (scrollPosition.x - 1)*50*document.body.style.zoom*3 + train[i1].position.i2 < scrollX) cameraMovements++;
        }
        if (cameraMovements > 1) {
          scrollingInterac.PC = true;
          document.body.style.zoom -= 0.01;
        }
      }
      var scrollPosition = {x: train[i].position.x, y: train[i].position.y};
    if (train[i].position.x == 0 || train.length > 1) scrollPosition.x++;
    if (train[i].position.y == 0 || train.length > 1) scrollPosition.y++;
    scrollingInterac.PC = true;
    //console.log("PC scrolling");
    if (!scrollingInterac.user && /*screen.availHeight*/window.innerHeight + scrollY < 10 + (scrollPosition.y + 1)*50*document.body.style.zoom*3 + train[i].position.i3) {
      window.scroll(scrollX, scrollY + (10 + (scrollPosition.y + 1)*50*document.body.style.zoom*3 + train[i].position.i3 - window.innerHeight + scrollY));
    }
    if (!scrollingInterac.user && /*screen.availWidth*/window.innerWidth + scrollX < 10 + (scrollPosition.x + 1)*50*document.body.style.zoom*3 + train[i].position.i2) {
      window.scroll(scrollX + (10 + (scrollPosition.x + 1)*50*document.body.style.zoom*3 + train[i].position.i2 - window.innerWidth - scrollX), scrollY);
    }
    if (!scrollingInterac.user && 10 + (scrollPosition.y - 1)*50*document.body.style.zoom*3 + train[i].position.i3 < scrollY) {
      window.scroll(scrollX, scrollY - (scrollY - 10 + (scrollPosition.y - 1)*50*document.body.style.zoom*3 + train[i].position.i3));
    }
    if (!scrollingInterac.user && 10 + (scrollPosition.x - 1)*50*document.body.style.zoom*3 + train[i].position.i2 < scrollX) {
      window.scroll(scrollX - (scrollX - 10 + (scrollPosition.x - 1)*50*document.body.style.zoom*3 + train[i].position.i2), scrollY);
    }
    setTimeout(function () {
      scrollingInterac.PC = false;
      //console.log("PC not scrolling");
    }, 1);
   //if (/*screen.availHeight*/window.innerHeight + scrollY > 10 + (scrollPosition.y - 1)*50*document.body.style.zoom*3 + train[i].position.i3) window.scroll(scrollX, scrollY - (10 + (scrollPosition.y - 1)*50*document.body.style.zoom*3 + train[i].position.i3 - window.innerHeight + scrollY));
   //if (/*screen.availWidth*/window.innerWidth + scrollY > 10 + (scrollPosition.x - 1)*50*document.body.style.zoom*3 + train[i].position.i2) window.scroll(scrollX - (10 + (scrollPosition.x - 1)*50*document.body.style.zoom*3 + train[i].position.i2 - window.innerWidth - scrollX), scrollY);
    var possibleDirections = [];
    var downIncluded = false;
    if (train[i].direction != "left" && isTrack(i, train[i].position.x, train[i].position.y, train[i].position.i2 + 1, train[i].position.i3).boolean) {possibleDirections.push({track: isTrack(i, train[i].position.x, train[i].position.y, train[i].position.i2 + 1, train[i].position.i3).position, direction: "right"});}
    if (train[i].direction != "right" && isTrack(i, train[i].position.x, train[i].position.y, train[i].position.i2 - 1, train[i].position.i3).boolean) {possibleDirections.push({track: isTrack(i, train[i].position.x, train[i].position.y, train[i].position.i2 - 1, train[i].position.i3).position, direction: "left"});}
    if (train[i].direction != "up" && isTrack(i, train[i].position.x, train[i].position.y, train[i].position.i2, train[i].position.i3 + 1).boolean) {possibleDirections.push({track: isTrack(i, train[i].position.x, train[i].position.y, train[i].position.i2, train[i].position.i3 + 1).position, direction: "down"}); downIncluded = true;}
    if (train[i].direction != "down" && isTrack(i, train[i].position.x, train[i].position.y, train[i].position.i2, train[i].position.i3 - 1).boolean) {possibleDirections.push({track: isTrack(i, train[i].position.x, train[i].position.y, train[i].position.i2, train[i].position.i3 - 1).position, direction: "up"});}
    if (downIncluded) {train[i].direction = "down"; train[i].position = JSON.parse(JSON.stringify(isTrack(i, train[i].position.x, train[i].position.y, train[i].position.i2, train[i].position.i3 + 1).position));}
    else if (possibleDirections.length == 0) {console.log("Puffer or wall reached!"); changeDirection(i);}
    else {train[i].position = JSON.parse(JSON.stringify(possibleDirections[0].track)); train[i].direction = possibleDirections[0].direction}
    collisionCheck(i);
  }
  }
  Layout();
  setTimeout(function () {
    if (inRound) moveTrain();
  }, 90);
}
var zuege = 0;
function collisionCheck(i) {
  for (var i1 = 0; i1 < train.length; i1++) {
    if (train[i].position.x != field.length && i1 != i && ((brownCollide.checked) || (!brownCollide.checked && i < 1)) && equals(train[i].position, train[i1].position) && /*!equals(train[i1].position, train[i1].spawnPoint)*/(train[i1].moving || (stayingTrainCollision.checked && !equals(train[i1].spawnPoint, train[0].spawnPoint)))) {
      console.log("Kollision!");
      var audio = new Audio("https://adi.nicolaiweitkemper.de/Sounds/helpTheTrain/dampflockKollision.mp3").play();
      resetTrain();
    }
  }
}
function isTrack(trainNumber, i, i1, i2, i3) {
  var transform = false;
  if (i2 == 3) {i2 = 0; i++; transform = true;}
  if (i3 == 3) {i3 = 0; i1++; transform = true;}
  if (i2 == -1) {i2 = 2; i--; transform = true;}
  if (i3 == -1) {i3 = 2; i1--; transform = true;}
  try {
  if (field[i][i1][i2][i3].collected === false && (trainNumber == 0 || everybodyBahnhofAccess.checked)) {
    field[i][i1][i2][i3].collected = true;
    bahnhoefe.collected++;
    var audio = new Audio("https://adi.nicolaiweitkemper.de/Sounds/helpTheTrain/bahnhof.mp3").play();
  }
  if (justTrainBahnhof.checked && field[i][i1][i2][i3].collected != undefined && trainNumber != 0) {
    resetTrain();
    var audio = new Audio("https://adi.nicolaiweitkemper.de/Sounds/helpTheTrain/gueterzugBeiBahnhof.mp3").play();
  }
  if (justBahnhoefe.checked && bahnhoefe.collected == bahnhoefe.all) {bahnhoefe.collected = 0; getDatabase(true);}
    return {boolean: (field[i][i1][i2][i3].type == "way" && (field[i][i1][i2][i3].active == undefined || field[i][i1][i2][i3].active == true || transform)), position: {x: i, y: i1, i2: i2, i3: i3}};
  } catch (e) {
    console.log("turning, because edge reached");
    if (bahnhoefe.collected == bahnhoefe.all && (i == field.length || justBahnhoefe.checked) && (everybodyCanFinish.checked || everybodyMustFinish.checked || trainNumber == 0)) {
      if (!everybodyMustFinish.checked || everyTrainFinished) {
      getDatabase(true);
    }
    else {
      train[trainNumber].finished = true;
      if (disapearWhenFinished.checked) {
        train[trainNumber].moving = false;
        train[trainNumber].position.x = field.length + 1;
      }
      var everyTrainFinished = true;
      for (var i4 = 0; i4 < train.length; i4++) {
        if (!train[i4].finished) everyTrainFinished = false;
      }
      if (everyTrainFinished) getDatabase(true);
    }
    }
    return {boolean: false};
    changeDirection(i);
  }
}
var selectedSettings;
function equals(a, b) {
  var equalsVar = true;
  for (var i = 0; i < Object.keys(a).length; i++) {
    if (a[Object.keys(a)[i]] != b[Object.keys(a)[i]]) equalsVar = false;
  }
  return equalsVar;
}
function saveHighscore() {
  var newField = !highscores[selectedSettings];
  if (!highscores[selectedSettings]) {
    highscores[selectedSettings] = {data: {field: selectedField, trains: train}, highscores: {}};
    if (offline && confirm("Wollen sie dieses Feld ink. ihren Ergebnissen speichern? Sie können es hochladen, indem sie diese Datei erneut aufrufen, wenn sie Internet haben.")) {
      if (!localStorage.getItem("newFieldUploadHelpTheTrain")) var newFieldUpload = [];
      else var newFieldUpload = JSON.parse(localStorage.getItem("newFieldUploadHelpTheTrain"));
      newFieldUpload.push({selectedSettings: selectedSettings, data: {data: {field: selectedField, trains: train}, highscores: {}}});
      localStorage.setItem("newFieldUploadHelpTheTrain", JSON.stringify(newFieldUpload));
    }
  }
  if (!highscores[selectedSettings].highscores[name] || highscores[selectedSettings].highscores[name] > zuege) {
    if (highscores[selectedSettings].highscores[name] > zuege) alert("So wenig Züge haben sie noch nie gebraucht!");
    highscores[selectedSettings].highscores[name] = zuege;
    if (!offline) dbSetWarteschlange.push({tag: "highscores", data: highscores});
    else /*if (newFieldUpload != undefined || (highscores[selectedSettings] && confirm("Wollen sie diesen highscore wenn sie wieder Internet haben hochladen?")))*/ {
      if (!localStorage.getItem("highscoresUploadHelpTheTrain")) var highscoresUpload = [];
      else var highscoresUpload = JSON.parse(localStorage.getItem("highscoresUploadHelpTheTrain"));
      highscoresUpload.push({selectedSettings: selectedSettings, data: zuege});
      localStorage.setItem("highscoresUploadHelpTheTrain", JSON.stringify(highscoresUpload));
      // für gleiche array Lenge falls mehrmals gleiche Settings
      if (!localStorage.getItem("newFieldUploadHelpTheTrain")) var newFieldUpload = [];
      else var newFieldUpload = JSON.parse(localStorage.getItem("newFieldUploadHelpTheTrain"));
      if (newField) {
      newFieldUpload.push({gapFiller: true});
      localStorage.setItem("newFieldUploadHelpTheTrain", JSON.stringify(newFieldUpload));
    }
    }
  }
  highscoresBetterThanYours.innerHTML = "";
  highscoresAsGoodAsYours.innerHTML = "";
  highscoresWorseThanYours.innerHTML = "";
  for (var i = 0; i < Object.keys(highscores[selectedSettings].highscores).length; i++) {
    if (Object.keys(highscores[selectedSettings].highscores)[i] != name && highscores[selectedSettings].highscores[Object.keys(highscores[selectedSettings].highscores)[i]] < highscores[selectedSettings].highscores[name]) highscoresBetterThanYours.innerHTML += Object.keys(highscores[selectedSettings].highscores)[i] + ": " + highscores[selectedSettings].highscores[Object.keys(highscores[selectedSettings].highscores)[i]] + '<br>';
    else if (Object.keys(highscores[selectedSettings].highscores)[i] != name && highscores[selectedSettings].highscores[Object.keys(highscores[selectedSettings].highscores)[i]] > highscores[selectedSettings].highscores[name]) highscoresWorseThanYours.innerHTML += Object.keys(highscores[selectedSettings].highscores)[i] + ": " + highscores[selectedSettings].highscores[Object.keys(highscores[selectedSettings].highscores)[i]] + '<br>';
    else if (Object.keys(highscores[selectedSettings].highscores)[i] != name) highscoresAsGoodAsYours.innerHTML += Object.keys(highscores[selectedSettings].highscores)[i] + ": " + highscores[selectedSettings].highscores[Object.keys(highscores[selectedSettings].highscores)[i]] + '<br>';
  }
  document.getElementById('highscores').style.display = "inline";
  resetTrain(true);
  // if ((Ablage[0][zähler[0]][0] > dataMode[document.getElementById('Auswahl').value])) {
  //   document.getElementById('highscoresBetterThanYours').innerHTML += Ablage[0][zähler[0]][0] + "  " + Ablage[0][zähler[0]][1] + '<br>';
  // }
  // else if ((Ablage[0][zähler[0]][0] < dataMode[document.getElementById('Auswahl').value])) {
  //   document.getElementById('highscoresWorseThanYours').innerHTML += Ablage[0][zähler[0]][0] + "  " + Ablage[0][zähler[0]][1] + '<br>';
  // }
  // else {
  //   document.getElementById('highscoresAsGoodAsYours').innerHTML += Ablage[0][zähler[0]][0] + "  " + Ablage[0][zähler[0]][1] + '<br>';
  // }
}
var selectedField = [];
var dbSetWarteschlange = [];
setInterval(function () {
  if (dbSetWarteschlange.length > 0) {
    dbSet("helpTheTrain", dbSetWarteschlange[0].tag, dbSetWarteschlange[0].data);
    dbSetWarteschlange.shift();
  }
  else if (alertWhenFinishedSaving) {
  alert("Saving finished! You can now leave the website!");
  alertWhenFinishedSaving = false;
}
}, 2222);
function changeDirection(i) {
  var oppositeDirection = {right: "left", left: "right", down: "up", up: "down"};
  train[i].direction = oppositeDirection[train[i].direction];
}
function resetTrain(map, time) {
  if (!time) time = 0;
  document.body.style.zoom = 1.0;
  scrollingInterac.user = false;
  inRound = false;
  for (var i = 0; i < train.length; i++) {
    train[i].position = JSON.parse(JSON.stringify(train[i].spawnPoint));
    train[i].moving = false;
    train[i].finished = false;
    train[i].direction = "right";
  }
  if (map) zuege = 0;
  bahnhoefe = {verbleibend: JSON.parse(JSON.stringify(anzahlBahnhoefe.value)), collected: 0, all: JSON.parse(anzahlBahnhoefe.value)};
  test.innerHTML = 'test';
  for (var i = 0; i < field.length; i++) {
    for (var i1 = 0; i1 < field[0].length; i1++) {
      for (var i2 = 0; i2 < 3; i2++) {
        for (var i3 = 0; i3 < 3; i3++) {
          if (field[i][i1][i2][i3].collected === true) field[i][i1][i2][i3].collected = false;
        }
      }
    }
  }
  if (map) field = JSON.parse(JSON.stringify(selectedField));
  if (time < 1) {
    setTimeout(function () {
      resetTrain(map, time + 1);
    }, 700);
  }
  Layout();
}
var audio;
function playTrainAudio(demo) {
  if ((inRound || demo) && trainAudio.checked) {
    if (fastTrainAudio.checked) {
      audio = new Audio("https://adi.nicolaiweitkemper.de/Sounds/helpTheTrain/dampflockFast.mp3");
      audio.volume = 0.7;
      audio.play();
      setTimeout(function () {
          /*if (!offline) */playTrainAudio();
      }, 360);
    }
    else {
      audio = new Audio("https://adi.nicolaiweitkemper.de/Sounds/helpTheTrain/dampflock.mp3");
      audio.volume = 0.7;
      audio.play();
      setTimeout(function () {
        /*if (!offline)*/ playTrainAudio();
      }, 850);
    }
  }
}
</script>
